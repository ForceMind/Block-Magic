!function(e,t){"use strict";class n{constructor(){this.normal=!1}get source(){return this._source}set source(e){this._source=e,e?t.ILaya.loader.load(e,t.Loader.SPINE).then(e=>{!this._source||e&&!e.isCreateFromURL(this._source)||(this.templet=e)}):this.templet=null}get items(){return this._items}set items(e){this._items=e}get templet(){return this._templet}set templet(e){this.init(e)}init(e){this._templet=e,this._templet&&this.flush()}flush(){var e,t,n;let r=null===(e=this.target)||void 0===e?void 0:e.templet,i=null===(t=this._templet)||void 0===t?void 0:t.skeletonData;if(this._items&&i&&r&&r._textures){for(let e=this._items.length-1;e>=0;e--){let t=this._items[e],a=t.attachment,s=t.slot,o=t.skin;if(a&&s&&o){let e=null,t=i.skins;for(let r=t.length-1;r>=0;r--)if(t[r].name==o){let i=t[r].attachments;for(let t=i.length-1;t>=0&&(e=null===(n=i[t])||void 0===n?void 0:n[a],!e);t--);break}if(e){let t=e.region.page;r.setTexture(t.name,t.texture.realTexture);let n=this.target.getSkeleton().findSlot(s);n&&n.setAttachment(e)}}}this.normal=this._templet!==r}else this.normal=!1}}class r{get skin(){return this._skin}set skin(e){this._skin=e}get slot(){return this._slot}set slot(e){this._slot=e}get attachment(){return this._attachment}set attachment(e){this._attachment=e}}class i{static createMesh(e,n,r,i=!1,a=!0){let s=new t.Mesh2D,o=[],h=i?t.BufferUsage.Dynamic:t.BufferUsage.Static,l=t.LayaGL.renderDeviceFactory.createVertexBuffer(h),d=n.vertexDeclaration,c=d.vertexStride;l.vertexDeclaration=d;let m=n.maxVertexCount*c,p=n.vbLength*Float32Array.BYTES_PER_ELEMENT;l.setDataLength(m),a&&l.setData(n.vb.buffer,0,0,p),o.push(l),s._vertexCount=m/c,s._vertexBuffers=o;let u=r.maxIndexCount*r.size;r.ibLength;let f=t.LayaGL.renderDeviceFactory.createIndexBuffer(h);f.indexType=r.type,f.indexCount=r.maxIndexCount,f._setIndexDataLength(u),a&&f._setIndexData(r.ib,0),s._indexBuffer=f;let _=s._bufferState;_.applyState(o,f);let g=[],x=r.outRenderData;for(let e=0,n=x.renderData.length;e<n;e++){let n=x.renderData[e],i=t.LayaGL.renderDeviceFactory.createRenderGeometryElement(t.MeshTopology.Triangles,t.DrawType.DrawElement);i.bufferState=_,i.setDrawElemenParams(n.length,n.offset*r.size),i.indexFormat=r.type,g.push(i)}s._setSubMeshes(g);var y=m+u;return s._setCPUMemory(y),s._setGPUMemory(y),s}static createMeshDynamic(e){let n=new t.Mesh2D,r=[],i=t.BufferUsage.Dynamic,a=t.LayaGL.renderDeviceFactory.createVertexBuffer(i);a.vertexDeclaration=e,r.push(a),n._vertexBuffers=r;let s=t.LayaGL.renderDeviceFactory.createIndexBuffer(i);return n._indexBuffer=s,n._bufferState.applyState(r,s),n}static _updateSpineSubMesh(e,n){let r=e.subMeshCount,i=n.mulitRenderData;if(!i)return!1;let a=i.renderData,s=a.length,o=r!=s,h=e._subMeshes;if(o){let i=Math.max(s,r),o=e._bufferState;for(let e=0;e<i;e++){let r=h[e],i=a[e];i?(r||(r=t.LayaGL.renderDeviceFactory.createRenderGeometryElement(t.MeshTopology.Triangles,t.DrawType.DrawElement),r.bufferState=o,h[e]=r),r.indexFormat=n.type,r.clearRenderParams(),r.setDrawElemenParams(i.length,i.offset*n.size)):r.destroy()}h.length=s}else for(let e=0;e<r;e++){let t=h[e],r=a[e];t.indexFormat=n.type,t.clearRenderParams(),t.setDrawElemenParams(r.length,r.offset*n.size)}return o}static getVertexDeclaration(e){var n=i._vertexDeclarationMap[e];if(!n){for(var r=e.split(","),a=[],s=0,o=0,h=r.length;o<h;o++){var l;switch(r[o]){case"COLOR2":l=new t.VertexElement(s,t.VertexElementFormat.Vector4,11),s+=16;break;case"BONE":l=new t.VertexElement(s,t.VertexElementFormat.Single,3),a.push(l),s+=4,l=new t.VertexElement(s,t.VertexElementFormat.Single,4),a.push(l),s+=4,l=new t.VertexElement(s,t.VertexElementFormat.Vector4,5),a.push(l),s+=16,l=new t.VertexElement(s,t.VertexElementFormat.Vector4,6),a.push(l),s+=16,l=new t.VertexElement(s,t.VertexElementFormat.Vector4,7),s+=16;break;case"RIGIDBODY":l=new t.VertexElement(s,t.VertexElementFormat.Single,4),s+=4;break;case"UV":l=new t.VertexElement(s,t.VertexElementFormat.Vector2,0),s+=8;break;case"COLOR":l=new t.VertexElement(s,t.VertexElementFormat.Vector4,1),s+=16;break;case"POSITION":l=new t.VertexElement(s,t.VertexElementFormat.Vector2,2),s+=8;break;default:throw"VertexMesh: unknown vertex flag."}a.push(l)}n=new t.VertexDeclaration(s,a),i._vertexDeclarationMap[e]=n}return n}static getIndexFormat(e){let n=t.IndexFormat.UInt32;return e<256&&t.LayaGL.renderEngine.getCapable(t.RenderCapable.Element_Index_Uint8)?n=t.IndexFormat.UInt8:e<65536&&(n=t.IndexFormat.UInt16),n}}i._vertexDeclarationMap={};class a{static SetSpineBlendMode(e,n,r=!0){switch(e){case 1:n.blend=t.RenderState.BLEND_ENABLE_ALL,n.blendSrc=t.RenderState.BLENDPARAM_SRC_ALPHA,n.blendDst=t.RenderState.BLENDPARAM_ONE;break;case 3:n.blend=t.RenderState.BLEND_ENABLE_SEPERATE,n.blendSrcRGB=t.RenderState.BLENDPARAM_ONE,n.blendSrcAlpha=t.RenderState.BLENDPARAM_ONE,n.blendDstRGB=t.RenderState.BLENDPARAM_ONE_MINUS_SRC_COLOR,n.blendDstAlpha=t.RenderState.BLENDPARAM_ONE;break;case 2:n.blend=t.RenderState.BLEND_ENABLE_ALL,n.blendSrc=t.RenderState.BLENDPARAM_DST_COLOR,n.blendDst=t.RenderState.BLENDPARAM_ONE_MINUS_SRC_ALPHA;break;default:n.blend=t.RenderState.BLEND_ENABLE_ALL,n.blendSrc=r?t.RenderState.BLENDPARAM_ONE:t.RenderState.BLENDPARAM_SRC_ALPHA,n.blendDst=t.RenderState.BLENDPARAM_ONE_MINUS_SRC_ALPHA}}static initSpineMaterial(e){e.alphaTest=!1,e.depthWrite=!1,e.cull=t.RenderState.CULL_NONE,e.blend=t.RenderState.BLEND_ENABLE_ALL,e.blendSrc=t.RenderState.BLENDPARAM_SRC_ALPHA,e.blendDst=t.RenderState.BLENDPARAM_ONE_MINUS_SRC_ALPHA,e.depthTest=t.RenderState.DEPTHTEST_OFF}static changeVertexDefine(e,t){let n=!1,r=t.vertexBuffers;for(let e=0;e<r.length;e++){if(r[e].vertexDeclaration.getVertexElementByUsage(11)){n=!0;break}}n?e.addDefine(a.SPINE_COLOR2):e.removeDefine(a.SPINE_COLOR2)}static init(){t.Shader3D.addInclude("SpineVertex.glsl","#if !defined(SpineVertex_lib)\n#define SpineVertex_lib\nvoid transfrom(vec2 pos,vec4 xDir,vec4 yDir,out vec2 outPos){outPos.x=xDir.x*pos.x+xDir.y*pos.y+xDir.z;outPos.y=yDir.x*pos.x+yDir.y*pos.y+yDir.z;}void transfrom_spine(vec2 pos,vec3 xDir,vec3 yDir,out vec2 outPos){outPos.x=xDir.x*pos.x-yDir.x*pos.y+xDir.z;outPos.y=xDir.y*pos.x-yDir.y*pos.y+yDir.z;}\n#ifdef SPINE_SIMPLE\nuniform vec4 u_SimpleAnimatorParams;uniform sampler2D u_SimpleAnimatorTexture;uniform float u_SimpleAnimatorTextureSize;vec4 getBonePosBake(float FramePos,float boneIndices,float weight,vec2 pos,float offset){vec2 uv=vec2(0.0,0.0);float PixelPos=FramePos+boneIndices*2.0;float halfOffset=offset*0.5;float uvoffset=PixelPos/u_SimpleAnimatorTextureSize;uv.y=floor(uvoffset)*offset+halfOffset;uv.x=mod(PixelPos,u_SimpleAnimatorTextureSize)*offset+halfOffset;vec4 up=texture2D(u_SimpleAnimatorTexture,uv);uv.x+=offset;vec4 down=texture2D(u_SimpleAnimatorTexture,uv);vec2 outPos;transfrom(pos,up,down,outPos);outPos=outPos*weight;return vec4(outPos,0.,1.0);}\n#endif\n#if defined(SPINE_FAST) || defined(SPINE_RB)\nuniform vec4 u_sBone[200];vec4 getBonePos(float fboneId,float weight,vec2 pos){int boneId=int(fboneId);vec4 up=u_sBone[boneId*2];vec4 down=u_sBone[boneId*2+1];vec2 outPos;transfrom(pos,up,down,outPos);outPos=outPos*weight;return vec4(outPos,0.,1.0);}\n#endif\nuniform vec4 u_color;vec4 getSpinePos(){\n#ifdef SPINE_SIMPLE\n#ifdef GPU_INSTANCE\nfloat currentPixelPos=a_SimpleTextureParams.x+a_SimpleTextureParams.y;\n#else\nfloat currentPixelPos=u_SimpleAnimatorParams.x+u_SimpleAnimatorParams.y;\n#endif\nfloat offset=1.0/u_SimpleAnimatorTextureSize;return getBonePosBake(currentPixelPos,a_BoneId,a_weight,a_position,offset)+getBonePosBake(currentPixelPos,a_PosWeightBoneID_2.w,a_PosWeightBoneID_2.z,a_PosWeightBoneID_2.xy,offset)+getBonePosBake(currentPixelPos,a_PosWeightBoneID_3.w,a_PosWeightBoneID_3.z,a_PosWeightBoneID_3.xy,offset)+getBonePosBake(currentPixelPos,a_PosWeightBoneID_4.w,a_PosWeightBoneID_4.z,a_PosWeightBoneID_4.xy,offset);\n#else\n#ifdef SPINE_FAST\nreturn getBonePos(a_BoneId,a_weight,a_position)+getBonePos(a_PosWeightBoneID_2.w,a_PosWeightBoneID_2.z,a_PosWeightBoneID_2.xy)+getBonePos(a_PosWeightBoneID_3.w,a_PosWeightBoneID_3.z,a_PosWeightBoneID_3.xy)+getBonePos(a_PosWeightBoneID_4.w,a_PosWeightBoneID_4.z,a_PosWeightBoneID_4.xy);\n#endif\n#ifdef SPINE_RB\nreturn getBonePos(a_BoneId,1.0,a_position);\n#endif\n#endif\nreturn vec4(a_position.x,a_position.y,0.,1.);}void getGlobalPos(vec4 pos,out vec2 globalPos){\n#ifdef GPU_INSTANCE\nvec3 down=a_NMatrix_1;vec3 up=a_NMatrix_0;\n#else\nvec3 down=u_NMatrix_1;vec3 up=u_NMatrix_0;\n#endif\ntransfrom_spine(pos.xy,up,down,globalPos);}vec4 getScreenPos(vec4 pos){vec2 globalPos;\n#ifdef GPU_INSTANCE\nvec3 down=a_NMatrix_1;vec3 up=a_NMatrix_0;\n#else\nvec3 down=u_NMatrix_1;vec3 up=u_NMatrix_0;\n#endif\ntransfrom_spine(pos.xy,up,down,globalPos);clip(globalPos);vec2 viewPos;getViewPos(globalPos,viewPos);vec4 outPos;getProjectPos(viewPos,outPos);return outPos;}void getVertexInfo(vec4 pos,inout vertexInfo info){info.pos=pos.xy;info.color=vec4(1.0);\n#ifdef COLOR\ninfo.color=a_color;\n#endif\ninfo.color*=u_baseRenderColor;\n#ifdef PREMULTIPLYALPHA\ninfo.color.rgb=info.color.rgb*info.color.a;\n#endif\n#ifdef UV\ninfo.uv=a_uv;\n#endif\n#ifdef LIGHT2D_ENABLE\nvec2 global;vec3 stageInv0=vec3(u_LightAndShadow2DStageMat0.x,u_LightAndShadow2DStageMat0.y,u_LightAndShadow2DStageMat0.z);vec3 stageInv1=vec3(u_LightAndShadow2DStageMat1.x,u_LightAndShadow2DStageMat1.y,u_LightAndShadow2DStageMat1.z);invertMat(stageInv0,stageInv1);getGlobalPos(pos,global);transfrom(global,stageInv0,stageInv1,global);transfrom(global,u_LightAndShadow2DSceneInv0,u_LightAndShadow2DSceneInv1,global);transfrom(global,u_LightAndShadow2DStageMat0,u_LightAndShadow2DStageMat1,global);info.lightUV.x=(global.x-u_LightAndShadow2DParam.x)/u_LightAndShadow2DParam.z;info.lightUV.y=1.0-(global.y-u_LightAndShadow2DParam.y)/u_LightAndShadow2DParam.w;\n#endif\n}\n#endif\n"),t.Shader3D.addInclude("SpineFragment.glsl",'#if !defined(SpineFragment_lib)\n#define SpineFragment_lib\n#include "Sprite2DFrag.glsl";\nvec4 getColor(){vec4 color=texture2D(u_spineTexture,v_texcoord.xy);\n#ifndef GAMMATEXTURE\n#ifdef GAMMASPACE\ncolor.xyz=linearToGamma(color.xyz);\n#endif\n#else\n#ifndef GAMMASPACE\ncolor.xyz=gammaToLinear(color.xyz);\n#endif\n#endif\nvec4 final;\n#ifdef TWOCOLORTINT\nfinal.a=color.a*v_color.a;final.xyz=((color.a-1.0)*v_color2.a+1.0-color.xyz)*v_color2.xyz+color.xyz*v_color.xyz;\n#else\nfinal=color*v_color;\n#endif\nreturn final;}\n#endif\n'),a.BONEMAT=t.Shader3D.propertyNameToID("u_sBone"),a.SpineTexture=t.Shader3D.propertyNameToID("u_spineTexture"),a.SPINE_FAST=t.Shader3D.getDefineByName("SPINE_FAST"),a.SPINE_RB=t.Shader3D.getDefineByName("SPINE_RB"),a.SPINE_UV=t.Shader3D.getDefineByName("UV"),a.SPINE_COLOR=t.Shader3D.getDefineByName("COLOR"),a.SPINE_PREMULTIPLYALPHA=t.Shader3D.getDefineByName("PREMULTIPLYALPHA"),a.SIMPLE_SIMPLEANIMATORPARAMS=t.Shader3D.propertyNameToID("u_SimpleAnimatorParams"),a.SIMPLE_SIMPLEANIMATORTEXTURE=t.Shader3D.propertyNameToID("u_SimpleAnimatorTexture"),a.SIMPLE_SIMPLEANIMATORTEXTURESIZE=t.Shader3D.propertyNameToID("u_SimpleAnimatorTextureSize"),a.SPINE_SIMPLE=t.Shader3D.getDefineByName("SPINE_SIMPLE"),a.SPINE_GPU_INSTANCE=t.Shader3D.getDefineByName("GPU_INSTANCE"),a.SPINE_TWOCOLORTINT=t.Shader3D.getDefineByName("TWOCOLORTINT"),a.SPINE_COLOR2=t.Shader3D.getDefineByName("COLOR2");const e=t.LayaGL.renderDeviceFactory.createGlobalUniformMap("Spine2D");e.addShaderUniformArray(a.BONEMAT,"u_sBone",t.ShaderDataType.Vector4,200),e.addShaderUniform(a.SIMPLE_SIMPLEANIMATORPARAMS,"u_SimpleAnimatorParams",t.ShaderDataType.Vector4),e.addShaderUniform(a.SIMPLE_SIMPLEANIMATORTEXTURE,"u_SimpleAnimatorTexture",t.ShaderDataType.Texture2D),e.addShaderUniform(a.SIMPLE_SIMPLEANIMATORTEXTURESIZE,"u_SimpleAnimatorTextureSize",t.ShaderDataType.Float);let n=t.Shader3D.add("SpineStandard",!0,!1);n.shaderType=t.ShaderFeatureType.D2_BaseRednerNode2D;let r={u_spineTexture:t.ShaderDataType.Texture2D},s=new t.SubShader(a.textureSpineAttribute,r);n.addSubShader(s),s.addShaderPass('#define SHADER_NAME SpineStandardVS\n#include "Sprite2DVertex.glsl";\n#include "SpineVertex.glsl";\nvarying vec4 v_color2;void main(){vec4 pos=getSpinePos();vertexInfo info;getVertexInfo(pos,info);v_texcoord=info.uv;v_color=info.color;\n#ifdef COLOR2\nv_color2=a_color2;\n#else\nv_color2=vec4(0.0,0.0,0.0,1.0);\n#endif\n#ifdef PREMULTIPLYALPHA\nv_color2.xyz=v_color2.xyz*v_color.a;\n#endif\n#ifdef LIGHT2D_ENABLE\nlightAndShadow(info);\n#endif\ngl_Position=getScreenPos(pos);}','#define SHADER_NAME SpineStandardFS\nvarying vec4 v_color2;\n#include "SpineFragment.glsl";\nvoid main(){clip();gl_FragColor=getColor();\n#ifdef LIGHT2D_ENABLE\nlightAndShadow(gl_FragColor);\n#endif\n}'),a.SpineNormalVertexDeclaration=i.getVertexDeclaration("UV,COLOR,POSITION,COLOR2"),a.instanceNMatrixDeclaration=new t.VertexDeclaration(24,[new t.VertexElement(0,t.VertexElementFormat.Vector3,8),new t.VertexElement(12,t.VertexElementFormat.Vector3,9)]),a.instanceSimpleAnimatorDeclaration=new t.VertexDeclaration(16,[new t.VertexElement(0,t.VertexElementFormat.Vector4,10)])}}a.textureSpineAttribute={a_uv:[0,t.ShaderDataType.Vector2],a_color:[1,t.ShaderDataType.Vector4],a_position:[2,t.ShaderDataType.Vector2],a_weight:[3,t.ShaderDataType.Float],a_BoneId:[4,t.ShaderDataType.Float],a_PosWeightBoneID_2:[5,t.ShaderDataType.Vector4],a_PosWeightBoneID_3:[6,t.ShaderDataType.Vector4],a_PosWeightBoneID_4:[7,t.ShaderDataType.Vector4],a_NMatrix_0:[8,t.ShaderDataType.Vector3],a_NMatrix_1:[9,t.ShaderDataType.Vector3],a_SimpleTextureParams:[10,t.ShaderDataType.Vector4],a_color2:[11,t.ShaderDataType.Vector4]},t.Laya.addAfterInitCallback(a.init);class s{get material(){return this._material}set material(e){this._material=e,this.element.materialShaderData=this._material._shaderValues,this.element.subShader=this._material._shader.getSubShaderAt(0)}constructor(e){this.verticesLength=0,this.indicesLength=0,this.vertexBufferLength=0,this.indexBufferLength=0,this.init(),this.material=e}init(){let e=t.LayaGL.renderDeviceFactory.createRenderGeometryElement(t.MeshTopology.Triangles,t.DrawType.DrawElement),n=t.LayaGL.renderDeviceFactory.createBufferState();e.bufferState=n;let r=t.LayaGL.renderDeviceFactory.createVertexBuffer(t.BufferUsage.Dynamic),i=t.LayaGL.renderDeviceFactory.createIndexBuffer(t.BufferUsage.Dynamic);r.vertexDeclaration=this.vertexDeclarition,n.applyState([r],i),e.indexFormat=t.IndexFormat.UInt16,this.geo=e,this.vb=r,this.ib=i,this.element=t.LayaGL.render2DRenderPassFactory.createRenderElement2D(),this.element.nodeCommonMap=["BaseRender2D","spine2D"],this.element.canotPool=!0,this.element.geometry=e,this.element.renderStateIsBySprite=!1}get vertexDeclarition(){return a.SpineNormalVertexDeclaration}draw(){let e=this.vb,t=this.ib,n=4*this.verticesLength,r=2*this.indicesLength;if(n<=0||r<=0)return this.geo.clearRenderParams(),void(this.element.geometry=null);n>this.vertexBufferLength&&(e.setDataLength(n),this.vertexBufferLength=n),r>this.indexBufferLength&&(t._setIndexDataLength(r),this.indexBufferLength=r),e.setData(this.vertexArray.buffer,0,this.vertexArray.byteOffset,n),t._setIndexData(new Uint16Array(this.indexArray.buffer,this.indexArray.byteOffset,r/2),0),this.geo.clearRenderParams(),this.geo.setDrawElemenParams(r/2,0),this.element.geometry=this.geo}drawByData(e,t,n,r){this.vertexArray=e,this.indexArray=n,this.verticesLength=t,this.indicesLength=r,this.draw()}clear(){this.verticesLength=0,this.indicesLength=0}destroy(){this.clear(),this.vb.destroy(),this.ib.destroy(),this.geo.destroy(),this.element.destroy()}_cloneTo(e){e.verticesLength=this.verticesLength,e.indicesLength=this.indicesLength,e.vertexArray=new Float32Array(this.vertexArray),e.indexArray=new Uint16Array(this.indexArray)}}s.maxVertex=10922;class o extends s{constructor(e){super(e),null==o.vertexArray&&(o.vertexArray=new Float32Array(s.maxVertex*o.vertexSize_TwoColor),o.indexArray=new Uint16Array(3*s.maxVertex)),this.vertexArray=o.vertexArray,this.indexArray=o.indexArray}appendVerticesClip(e,t){let n=t.length,r=e.length,i=o.vertexSize_TwoColor,a=this.vertexArray,s=this.verticesLength,h=s/i,l=s;for(let t=0;t<r;l+=i,t+=i)a[l]=e[t+6],a[l+1]=e[t+7],a[l+2]=e[t+2],a[l+3]=e[t+3],a[l+4]=e[t+4],a[l+5]=e[t+5],a[l+6]=e[t],a[l+7]=e[t+1],a[l+8]=e[t+8],a[l+9]=e[t+9],a[l+10]=e[t+10],a[l+11]=e[t+11];this.verticesLength=s+r;let d=this.indexArray;for(let e=this.indicesLength,r=0;r<n;e++,r++)d[e]=t[r]+h;this.indicesLength+=n}canAppend(e,t){return this.verticesLength+e<o.maxVertex*o.vertexSize_TwoColor&&this.indicesLength+t<3*o.maxVertex}appendVertices(e,t,n,r,i,a,s){let h=o.vertexSize_TwoColor,l=this.verticesLength/h,d=this.vertexArray,c=this.verticesLength;for(let n=0,r=0,o=t;r<o;r+=h,n+=2){let t=c+r;d[t]=s[n],d[t+1]=s[n+1],d[t+2]=i.r,d[t+3]=i.g,d[t+4]=i.b,d[t+5]=i.a,d[t+6]=e[r],d[t+7]=e[r+1],d[t+8]=a.r,d[t+9]=a.g,d[t+10]=a.b,d[t+11]=a.a}this.verticesLength=c+t;let m=this.indexArray;for(let e=this.indicesLength,t=0;t<r;e++,t++)m[e]=n[t]+l;this.indicesLength+=r}}o.vertexSize=8,o.vertexSize_TwoColor=12;class h{constructor(){this.vmeshs=[],this.nextBatchIndex=0}clearBatch(){for(var e=0;e<this.vmeshs.length;e++)this.vmeshs[e].clear();this.nextBatchIndex=0}nextBatch(e,t){if(this.vmeshs.length==this.nextBatchIndex){let n=this.createMesh(e);return this.vmeshs.push(n),t._renderElements[this.nextBatchIndex++]=n.element,n.element.value2DShaderData=t._spriteShaderData,n}let n=this.vmeshs[this.nextBatchIndex];return t._renderElements[this.nextBatchIndex++]=n.element,n.element.owner=t.owner._struct,n.material=e,n}destroy(){for(var e=0;e<this.vmeshs.length;e++)this.vmeshs[e].destroy();this.vmeshs.length=0}}const l=[0,1,2,2,3,0];class d extends h{createMesh(e){return new o(e)}constructor(e){super(),this.templet=e,null==d.vertices&&(d.vertices=spine.Utils.newFloatArray(12288)),this.renderable={vertices:null,numVertices:0,numFloats:0},this.clipper=new spine.SkeletonClipping,this.tempColor=new spine.Color,this.tempColor2=new spine.Color}draw(e,t,n,r){let i=this.clipper;this.clearBatch();let a,s,h,c,m,p=null,u=this.renderable,f=e.drawOrder,_=e.color,g=o.vertexSize_TwoColor,x=!1;-1==n&&(x=!0);let y=d.vertices;for(let o=0,d=f.length;o<d;o++){let d=i.isClipping()?2:g,S=f[o];if(!S.bone.active){i.clipEndWithSlot(S);continue}if(n>=0&&n==S.data.index&&(x=!0),!x){i.clipEndWithSlot(S);continue}r>=0&&r==S.data.index&&(x=!1);let D,A=S.getAttachment();if(A instanceof window.spine.RegionAttachment){let t=A;u.vertices=y,u.numVertices=4,u.numFloats=d<<2,null!=A.sequence&&A.sequence.apply(S,A),this.computeWorldVertices_RegionAttachment(t,S.bone,u.vertices,0,d,-e.x,-e.y),s=l,a=t.uvs,D=t.region.page.texture,h=t.color}else{if(!(A instanceof window.spine.MeshAttachment)){if(A instanceof window.spine.ClippingAttachment){let t=A;this.clipStart(this.clipper,S,t,-e.x,-e.y);continue}i.clipEndWithSlot(S);continue}{let t=A;u.vertices=y,u.numVertices=t.worldVerticesLength>>1,u.numFloats=u.numVertices*d,u.numFloats>u.vertices.length&&(u.vertices=y=window.spine.Utils.newFloatArray(u.numFloats)),null!=A.sequence&&A.sequence.apply(S,A),this.computeWorldVertices_MeshAttachment(t,S,0,t.worldVerticesLength,u.vertices,0,d,-e.x,-e.y),s=t.triangles,D=t.region.page.texture,a=t.uvs,h=t.color}}if(D){let e=S.color,n=this.tempColor;n.r=_.r*e.r*h.r,n.g=_.g*e.g*h.g,n.b=_.b*e.b*h.b,n.a=_.a*e.a*h.a;let r=this.tempColor2;S.darkColor?r.setFromColor(S.darkColor):r.set(0,0,0,1);let o=S.data.blendMode,l=!1;if(o!=p&&(p=o,l=!0),m!=D&&(m=D,l=!0),l){c&&c.draw();let e=t.templet.getMaterial(D.realTexture,p);c=this.nextBatch(e,t),c.clear()}i.isClipping()?(i.clipTriangles(u.vertices,u.numFloats,s,s.length,a,n,r,true),c.canAppend(i.clippedVertices.length,i.clippedTriangles.length)||(c.draw(),c=this.nextBatch(c.material,t),c.clear()),c.appendVerticesClip(i.clippedVertices,i.clippedTriangles)):(c.canAppend(u.numFloats,s.length)||(c.draw(),c=this.nextBatch(c.material,t),c.clear()),0!=n.a&&c.appendVertices(u.vertices,u.numFloats,s,s.length,n,r,a))}i.clipEndWithSlot(S)}i.clipEnd(),c&&c.draw()}clipStart(e,t,n,r,i){if(e.clipAttachment)return 0;e.clipAttachment=n;let a=n.worldVerticesLength,s=spine.Utils.setArraySize(e.clippingPolygon,a);this.computeWorldVertices_MeshAttachment(n,t,0,a,s,0,2,r,i);let o=e.clippingPolygon;spine.SkeletonClipping.makeClockwise(o);let h=e.clippingPolygons=e.triangulator.decompose(o,e.triangulator.triangulate(o));for(let e=0,t=h.length;e<t;e++){let t=h[e];spine.SkeletonClipping.makeClockwise(t),t.push(t[0]),t.push(t[1])}return h.length}computeWorldVertices_RegionAttachment(e,t,n,r,i,a,s){let o=e.offset,h=t.worldX+a,l=t.worldY+s,d=t.a,c=t.b,m=t.c,p=t.d,u=0,f=0;u=o[0],f=o[1],n[r]=u*d+f*c+h,n[r+1]=u*m+f*p+l,r+=i,u=o[2],f=o[3],n[r]=u*d+f*c+h,n[r+1]=u*m+f*p+l,r+=i,u=o[4],f=o[5],n[r]=u*d+f*c+h,n[r+1]=u*m+f*p+l,r+=i,u=o[6],f=o[7],n[r]=u*d+f*c+h,n[r+1]=u*m+f*p+l}computeWorldVertices_MeshAttachment(e,t,n,r,i,a,s,o,h){r=a+(r>>1)*s;let l=t.bone.skeleton,d=t.deform,c=e.vertices,m=e.bones;if(null==m){d.length>0&&(c=d);let e=t.bone,l=e.worldX+o,m=e.worldY+h,p=e.a,u=e.b,f=e.c,_=e.d;for(let e=n,t=a;t<r;e+=2,t+=s){let n=c[e],r=c[e+1];i[t]=n*p+r*u+l,i[t+1]=n*f+r*_+m}return}let p=0,u=0;for(let e=0;e<n;e+=2){let e=m[p];p+=e+1,u+=e}let f=l.bones;if(0==d.length)for(let e=a,t=3*u;e<r;e+=s){let n=0,r=0,a=m[p++];for(a+=p;p<a;p++,t+=3){let e=f[m[p]],i=c[t],a=c[t+1],s=c[t+2];n+=(i*e.a+a*e.b+e.worldX+o)*s,r+=(i*e.c+a*e.d+e.worldY+h)*s}i[e]=n,i[e+1]=r}else{let e=d;for(let t=a,n=3*u,l=u<<1;t<r;t+=s){let r=0,a=0,s=m[p++];for(s+=p;p<s;p++,n+=3,l+=2){let t=f[m[p]],i=c[n]+e[l],s=c[n+1]+e[l+1],d=c[n+2];r+=(i*t.a+s*t.b+t.worldX+o)*d,a+=(i*t.c+s*t.d+t.worldY+h)*d}i[t]=r,i[t+1]=a}}}}class c extends s{constructor(e){super(e),this._renderElement2D=t.LayaGL.render2DRenderPassFactory.createRenderElement2D(),this._renderElement2D.geometry=this.geo,this._renderElement2D.nodeCommonMap=["BaseRender2D","spine2D"]}destroy(){super.destroy(),this._renderElement2D.destroy()}}class m extends h{constructor(e){super(),this.vmeshs=[],this.nextBatchIndex=0,this.templet=e}createMesh(e){return new c(e)}draw(e,t,n,r){this.nextBatchIndex=0,p.drawSkeleton((e,n,r,i)=>{let a=t.templet.getMaterial(this.templet.getTexture(r),i.value);this.nextBatch(a,t).drawByData(p._vbArray,e,p._ibArray,n),t.owner._struct.renderElements=t._renderElements},e,!0,n,r)}}class p{static initialize(){if(window.Spine)return p.isWasm=!0,window.Spine().then(e=>(p._spine=e,window.spine=e,p.initClass(),p.bindBuffer(131064,32766),p.allAdpat(),Promise.resolve()));window.spine&&(p.isWasm=!1,p.adaptJS(),p.allAdpat())}static createNormalRender(e){return p.isWasm?new m(e):new d(e)}static allAdpat(){let e=window.spine,t=e.AnimationState.prototype;t.oldApply=t.apply,t.applyCache=function(e){},t.getCurrentPlayTimeOld=function(e){return this.getCurrentOld(e).getAnimationTime()},t.getCurrentPlayTime=t.getCurrentPlayTimeOld,t.getCurrentPlayTimeByCache=function(e){let t=this.getCurrent(e),n=t.animationStart,r=t.animationEnd,i=r-n;t.trackLast=t.nextTrackLast;let a=t.trackLast%i,s=t.getAnimationTime(),o=!1;if(o=t.loop?0==i||a>t.trackTime%i:s>=r&&t.animationLast<r,o)return this.dispatchEvent(t,"complete",null),t.nextAnimationLast=-1,t.nextTrackLast=-1,0;t.nextAnimationLast=s,t.nextTrackLast=t.trackTime;let h=t.animationLast;return Math.max(h,0)};let n=e.Skeleton.prototype;n.oldUpdateWorldTransform=n.updateWorldTransform,n.updateWorldTransformCache=function(){},e.AnimationState.prototype.dispatchEvent=function(e,t,n){this.eventsObject[t](e,n)}}static adaptJS(){let e=window.spine;if(e){e.AnimationState.prototype.oldAddListener=e.AnimationState.prototype.addListener,e.AnimationState.prototype.addListener=function(e){this.eventsObject=e,this.oldAddListener(e)};let t=e.SkeletonData.prototype;t.getAnimationsSize=function(){return this.animations.length},t.getAnimationByIndex=function(e){return this.animations[e]},t.getSkinIndexByName=function(e){let t=this.skins;for(let n=0,r=t.length;n<r;n++)if(t[n].name==e)return n;return-1},e.Skeleton.prototype.showSkinByIndex=function(e){this.setSkin(this.data.skins[e])};let n=e.AnimationState.prototype;n.getCurrentOld=n.getCurrent,n.getCurrent=function(e){let t=this.getCurrentOld(e);return this.currentTrack=t,t}}}static initClass(){let e=window.spine,t=e.AnimationState.prototype;t.addListener=function(e){this.eventsObject=e,this.setListener(p._spine.AnimationStateListenerObject.implement({callback:(t,n,r,i)=>{e[p.stateMap[n.value]](r,i)}}))},t.getCurrentOld=t.getCurrent,t.setAnimationOld=t.setAnimation,t.setAnimation=function(e,t,n){return this.__tracks&&(this.__tracks.length=0),this.setAnimationOld(e,t,n)},t.getCurrent=function(e){let t,n=this.__tracks;return n?t=n[e]:(n=this.__tracks=[],t=this.getCurrentOld(e),n[e]=t),t||(t=this.getCurrentOld(e),n[e]=t),this.currentTrack=t,t},e.TextureAtlas=u,Object.defineProperty(e.Skin.prototype,"attachments",{get:function(){return this.getAttachments()}});let n=e.Skeleton.prototype;Object.defineProperty(n,"slots",{get:function(){return this.getSlots()}}),Object.defineProperty(n,"data",{get:function(){return this.getData()}}),Object.defineProperty(n,"bones",{get:function(){return this.getBones()}}),Object.defineProperty(n,"color",{get:function(){return this.getColor()}});let r=e.SkeletonData.prototype;Object.defineProperty(r,"name",{get:function(){return this.getName()}}),Object.defineProperty(r,"skins",{get:function(){return this.getSkins()}}),Object.defineProperty(r,"slots",{get:function(){return this.getSlots()}});let i=e.Animation.prototype;Object.defineProperty(i,"name",{get:function(){return this.getName()}}),Object.defineProperty(i,"duration",{get:function(){return this.getDuration()}}),Object.defineProperty(i,"timelines",{get:function(){return this.getTimelines()}}),Object.defineProperty(r,"animations",{get:function(){return this.getAnimations()}}),Object.defineProperty(e.Skin.prototype,"name",{get:function(){return this.getName()}});let a=e.SlotData.prototype;Object.defineProperty(a,"boneData",{get:function(){return this.getBoneData()}}),Object.defineProperty(a,"color",{get:function(){return this.getColor()}}),Object.defineProperty(a,"index",{get:function(){return this.getIndex()}}),Object.defineProperty(a,"attachmentName",{get:function(){return this.getAttachmentName()}}),Object.defineProperty(a,"blendMode",{get:function(){return this.getBlendMode().value}}),Object.defineProperty(e.BoneData.prototype,"index",{get:function(){return this.getIndex()}});let s=e.RegionAttachment.prototype;Object.defineProperty(s,"color",{get:function(){return this.getColor()}}),Object.defineProperty(s,"name",{get:function(){return this.getName()}}),Object.defineProperty(s,"offset",{get:function(){return this.getOffset()}}),Object.defineProperty(s,"uvs",{get:function(){return this.getRotateUVs()}}),Object.defineProperty(s,"region",{get:function(){return this}}),Object.defineProperty(s,"page",{get:function(){return this.getPage()}}),Object.defineProperty(e.AtlasPage.prototype,"name",{get:function(){return this.getName()}});let o=e.MeshAttachment.prototype;Object.defineProperty(o,"bones",{get:function(){return this.getBones()}}),Object.defineProperty(o,"uvs",{get:function(){return this.getUVs()}}),Object.defineProperty(o,"triangles",{get:function(){return this.getTriangles()}}),Object.defineProperty(o,"vertices",{get:function(){return this.getVertices()}}),Object.defineProperty(o,"color",{get:function(){return this.getColor()}}),Object.defineProperty(o,"region",{get:function(){return this}}),Object.defineProperty(o,"page",{get:function(){return this.getPage()}}),Object.defineProperty(o,"name",{get:function(){return this.getName()}});let h=e.EventTimeline.prototype;Object.defineProperty(h,"frames",{get:function(){return this.getFrames()}}),Object.defineProperty(h,"events",{get:function(){return this.getEvents()}});let l=e.AttachmentTimeline.prototype;Object.defineProperty(l,"frames",{get:function(){return this.getFrames()}}),Object.defineProperty(l,"slotIndex",{get:function(){return this.getSlotIndex()}}),Object.defineProperty(l,"attachmentNames",{get:function(){return this.getAttachmentNames()}});let d=e.DrawOrderTimeline.prototype;Object.defineProperty(d,"frames",{get:function(){return this.getFrames()}}),Object.defineProperty(d,"drawOrders",{get:function(){return this.getDrawOrders()}});let c=e.ColorTimeline.prototype;Object.defineProperty(c,"frames",{get:function(){return this.getFrames()}}),Object.defineProperty(c,"slotIndex",{get:function(){return this.getSlotIndex()}});let m=e.TrackEntry.prototype;Object.defineProperty(m,"loop",{get:function(){return this.getLoop()}}),Object.defineProperty(m,"animationStart",{get:function(){return this.getAnimationStart()},set:function(e){}}),Object.defineProperty(m,"animationEnd",{get:function(){return this.getAnimationEnd()}}),Object.defineProperty(m,"animationLast",{get:function(){return this.getAnimationLast()}}),Object.defineProperty(m,"nextAnimationLast",{get:function(){return this.getAnimationLast()},set:function(e){this.setNextAnimationLast(e)}}),Object.defineProperty(m,"trackTime",{get:function(){return this.getTrackTime()}}),Object.defineProperty(m,"animation",{get:function(){return this.getAnimation()}});let f=e.Bone.prototype;Object.defineProperty(f,"a",{get:function(){return this.getA()}}),Object.defineProperty(f,"b",{get:function(){return this.getB()}}),Object.defineProperty(f,"c",{get:function(){return this.getC()}}),Object.defineProperty(f,"d",{get:function(){return this.getD()}}),Object.defineProperty(f,"worldX",{get:function(){return this.getWorldX()}}),Object.defineProperty(f,"worldY",{get:function(){return this.getWorldY()}});let _=e.Event.prototype;Object.defineProperty(_,"volume",{get:function(){return this.getVolume()}}),Object.defineProperty(_,"balance",{get:function(){return this.getBalance()}}),Object.defineProperty(_,"time",{get:function(){return this.getTime()}}),Object.defineProperty(_,"data",{get:function(){return this.getData()}}),Object.defineProperty(_,"floatValue",{get:function(){return this.getFloatValue()}}),Object.defineProperty(_,"intValue",{get:function(){return this.getIntValue()}}),Object.defineProperty(_,"stringValue",{get:function(){return this.getStringValue()}});let g=e.EventData.prototype;Object.defineProperty(g,"name",{get:function(){return this.getName()}}),Object.defineProperty(g,"audioPath",{get:function(){return this.getAudioPath()}})}static bindBuffer(e,t){p._spine.createBuffer(e,t),p._vbArray=p._spine.getVertexsBuffer(),p._ibArray=p._spine.getIndexsBuffer()}static drawSkeleton(e,t,n,r,i){p._spine.drawSkeleton(e,t,n,r,i)}}p.stateMap={0:"start",1:"interrupt",2:"end",3:"complete",4:"dispose",5:"event"};class u{constructor(e,t){return new p._spine.Atlas(e,"",p._spine.TextureLoader.implement({load:(e,n)=>{let r=t(n);e.texture=r},unload:function(e){}}),!0)}}t.Laya.addBeforeInitCallback(p.initialize);class f{constructor(){this._skinIndex=0}getSpineColor(){return this._spineColor}destroy(){this._renderer.destroy(),this._renderer=null,this._owner._renderElements.length=0}initBake(e){}init(e,n,r,i){this._renderer=p.createNormalRender(n),this._skeleton=e,this._owner=r;let s=e.color;this._spineColor=new t.Color(s.r,s.g,s.b,s.a);let o=r._spriteShaderData.getColor(t.BaseRenderNode2D.BASERENDER2DCOLOR)||new t.Color;o.setValue(s.r,s.g,s.b,s.a),void 0!==r._renderAlpha?o.a*=r._renderAlpha:o.a*=r.owner.alpha,r._spriteShaderData.setColor(t.BaseRenderNode2D.BASERENDER2DCOLOR,o),r._spriteShaderData.removeDefine(a.SPINE_FAST),r._spriteShaderData.removeDefine(a.SPINE_RB),r._spriteShaderData.addDefine(a.SPINE_COLOR2)}play(e){}setSkinIndex(e){this._skinIndex=e}changeSkeleton(e){this._skeleton=e,e.showSkinByIndex(this._skinIndex),this._skeleton.setSlotsToSetupPose()}render(e){this._owner.clear(),this._renderer.draw(this._skeleton,this._owner,-1,-1),this._owner.owner._struct.renderElements=this._owner._renderElements}complete(){}}class _{constructor(){}apply(e,t,n){return e>=this.startFrame&&(!(this._lastFrame>=this.endFrame&&e>=this.endFrame)&&(this._lastFrame=e,this.updateVB(t,n)))}initChange(e){return this.sizeMap=e.slotVBMap.get(this.slotId),!0}updateVB(e,t){if(!this.sizeMap&&(this.sizeMap=e.slotVBMap.get(this.slotId),!this.sizeMap))return!1;let n=t[this.slotId];if(n.attachment){let t=n.deform;if(!t||!t.length)return!1;let r=e.vertexSize,i=this.sizeMap.get(n.attachment.name),a=i.offset*r,s=e.vb,o=i.attachment;e.appendDeform(o,t,a,s)}return!0}clone(){let e=new _;return e.slotId=this.slotId,e.startFrame=this.startFrame,e.endFrame=this.endFrame,e}}class g{changeOrder(e){return this.order}change(e,t){return!0}}class x{constructor(e){this.slotId=e}apply(e,t,n){return this.updateVB(t,n),e>=this.startFrame}initChange(e){return this.sizeMap=e.slotVBMap.get(this.slotId),!0}updateVB(e,t){if(!this.sizeMap&&(this.sizeMap=e.slotVBMap.get(this.slotId),!this.sizeMap))return!1;let n=t[this.slotId],r=n.color;if(n.attachment){let t,i,a,s,o=e.vertexSize,h=this.sizeMap.get(n.attachment.name),l=e.vb,d=h.offset*o,c=h.attachment,m=c.lightColor,p=e.twoColorTint,u=e.vertexDeclaration.getVertexElementByUsage(1).offset/4,f=0;if(p){f=e.vertexDeclaration.getVertexElementByUsage(11).offset/4}m?(t=r.r*m.r,i=r.g*m.g,a=r.b*m.b,s=r.a*m.a):(t=r.r,i=r.g,a=r.b,s=r.a);let _=n.darkColor,g=0,x=0,y=0,S=1;_&&(g=_.r,x=_.g,y=_.b,S=_.a);let D=c.vertexCount;for(let e=0;e<D;e++){let n=d+e*o+u;if(l[n]=t,l[n+1]=i,l[n+2]=a,l[n+3]=s,p){let t=d+e*o+f;l[t]=g,l[t+1]=x,l[t+2]=y,l[t+3]=S}}}return!0}clone(){let e=new x(this.slotId);return e.startFrame=this.startFrame,e.endFrame=this.endFrame,e}}class y{change(e,t){let n=t.get(this.slotId),r=n.get(this.attachment);return r?e.appendVB(r):r=n.get(null),this.attachmentParse=r,!this.attachmentParse.isClip}changeOrder(e){return e[this.slotId]=this.attachmentParse,null}}const S=1/30;class D{static getFloat32Array(e){let t=new Float32Array(8);return t[0]=e.a,t[1]=e.b,t[2]=e.worldX,t[3]=0,t[4]=e.c,t[5]=e.d,t[6]=e.worldY,t[7]=0,t}constructor(){this.isDynamic=!1,this.changeMap=new Map,this.frames=[],this.skinDataArray=[],this.boneFrames=[],this.eventsFrames=[]}getFrameIndex(e,t){let n=this.frames,r=n.length;for(let t=1;t<r;t++)if(n[t]>e)return t-1;return r-1}cacheBones(e){let t=e._play(this.name),n=Math.round(t/S)||1;for(let t=0;t<=n;t++){let n=e._updateState(0==t?0:S),r=[];this.boneFrames.push(r);for(let e=0;e<n.length;e++){let t=n[e],i=D.getFloat32Array(t);r.push(i)}}}check(e,t){this.name=e.name;let n=e.timelines,r=this.changeMap,i=this.frames,a=!1;i.push(0),r.set(0,{});for(let e=0,i=n.length;e<i;e++){let i=n[e],s=i.frames;if(i instanceof spine.AttachmentTimeline){let e=i.attachmentNames,t=i.slotIndex;for(let n=0,i=s.length;n<i;n++){let i=s[n],a=new y;a.slotId=t,a.attachment=e[n]||null;let o=r.get(i);o||(-1==this.frames.indexOf(i)&&this.frames.push(i),o={iChanges:[]},r.set(i,o)),(o.iChanges=o.iChanges||[]).push(a)}}else if(i instanceof spine.DrawOrderTimeline){let e=i.drawOrders;for(let t=0,n=s.length;t<n;t++){let n=s[t],i=new g;i.order=e[t];let a=r.get(n);a||(-1==this.frames.indexOf(n)&&this.frames.push(n),a={iChanges:[]},r.set(n,a)),(a.iChanges=a.iChanges||[]).push(i)}}else if(i instanceof(spine.ColorTimeline||spine.RGBATimeline)||spine.TwoColorTimeline&&i instanceof spine.TwoColorTimeline){let e=i.slotIndex;if(5==s.length&&0==s[0]&&0==s[4]){let t=new y;t.slotId=e,t.attachment=null;let n=0,i=r.get(n);i||(-1==this.frames.indexOf(n)&&this.frames.push(n),i={iChanges:[]},r.set(n,i)),(i.iChanges=i.iChanges||[]).push(t)}else{let t=new x(e),n=s[0],i=s[5*((s.length/5|0)-1)];t.startFrame=n,t.endFrame=i;let a=r.get(n);a||(-1==this.frames.indexOf(n)&&this.frames.push(n),a={vChanges:[]},r.set(n,a)),-1==this.frames.indexOf(i)&&this.frames.push(i),(a.vChanges=a.vChanges||[]).push(t)}}else if(i instanceof window.spine.ClippingAttachment)a=!0;else if(i instanceof window.spine.EventTimeline){if(t.canCache){let e=i.events;for(let t=0,n=s.length;t<n;t++){let n=s[t],r=e[t];(this.eventsFrames[Math.round(n/S)]=this.eventsFrames[n]||[]).push(r)}}}else if(i instanceof spine.DeformTimeline){let e=i.slotIndex,t=new _;t.slotId=e;let n=s[0],a=s[s.length-1];t.startFrame=n,t.endFrame=a;let o=r.get(n);o||(-1==this.frames.indexOf(n)&&this.frames.push(n),o={vChanges:[]},r.set(n,o)),-1==this.frames.indexOf(a)&&this.frames.push(a),(o.vChanges=o.vChanges||[]).push(t)}}this.isDynamic=!!r.size,i.sort(),a||t.canCache&&(this.cacheBones(t),this.isCache=!0),this.frameNumber=i.length}createSkinData(e,t,n,r,i,a){let s=new A;s.type=a;let o=this.frames;return s.init(this.changeMap,e,t,n,o,r,i,this.isDynamic),s.updateBoneMat=this.isCache?0==this.eventsFrames.length?s.updateBoneMatCache:s.updateBoneMatCacheEvent:s.updateBoneMatByBone,this.skinDataArray.push(s),s}destroy(){for(let e=0,t=this.skinDataArray.length;e<t;e++)this.skinDataArray[e].destroy();this.skinDataArray.length=0,this.frames.length=0,this.changeMap.clear()}}class A{constructor(){this.maxVertexCount=0,this.maxIndexCount=0,this.isDynamic=!1,this.renderDatas=[]}getMesh(){return this._defaultMesh}getFrameData(e){return this.renderDatas[e]||this._defaultFrameData}updateBoneMatCache(e,t,n,r,i,a=0,s=0){this.vb.updateBoneCache(t.boneFrames,e/S,i,a,s)}updateBoneMatCacheEvent(e,t,n,r,i){let a=e/S;this.vb.updateBoneCache(t.boneFrames,a,i);let s=Math.round(a),o=r.currentTrack,h=o.lastEventFrame;if(h!=s){if((h>s||null==h)&&(h=-1),s-h<=1){let e=t.eventsFrames[s];if(e)for(let t=0,n=e.length;t<n;t++)r.dispatchEvent(null,"event",e[t])}else for(let e=h+1;e<=s;e++){let n=t.eventsFrames[e];if(n)for(let e=0,t=n.length;e<t;e++)r.dispatchEvent(null,"event",n[e])}o.lastEventFrame=s}}updateBoneMatByBone(e,t,n,r,i,a=0,s=0){this.vb.updateBone(n,i,a,s)}init(e,t,n,r,a,s,o,h){if(this.mainIB=n,this.isDynamic=h,this.canInstance=!this.isDynamic,h){this.vb=t.clone(),this.vb.initBoneMat();let i,h=o.slice(),l=a.length;for(let t=0;t<l;t++){let o=a[t],l=e.get(o);if(!l)continue;let d=l.iChanges,c={};if(d){for(let e=0,t=d.length;e<t;e++){let t=d[e];t.change(this.vb,s)||(this.isNormalRender=!0);let n=t.changeOrder(h);n&&(i=n)}r.createIB(h,this.vb,i),c.ib=r.ib.slice(0,r.ibLength),c.mulitRenderData=r.outRenderData,c.type=r.type,c.size=r.size}let m=l.vChanges;if(m){let e=[];for(let n=0,r=m.length;n<r;n++){let r=m[n].clone();r.initChange(this.vb)&&(r.startFrame=t,r.endFrame=a.indexOf(r.endFrame),e.push(r))}c.vChanges=e}this.renderDatas.push(c),o||(c.ib||(c.mulitRenderData=n.outRenderData,c.ib=n.ib.slice(0,this.mainIB.ibLength),c.type=n.type,c.size=n.size),this._defaultFrameData=c)}this.maxIndexCount=Math.max(r.maxIndexCount,this.mainIB.maxIndexCount)}else this.vb=t,this._defaultMesh=i.createMesh(this.type,this.vb,n,this.isDynamic),this._defaultMesh._addReference(),this.maxIndexCount=n.maxIndexCount;this.maxVertexCount=this.vb.maxVertexCount,this._defaultFrameData||(this._defaultFrameData={mulitRenderData:n.outRenderData,ib:n.ib.slice(0,this.mainIB.ibLength),type:n.type,size:n.size})}destroy(){this._defaultMesh&&this._defaultMesh.destroy(),this._defaultMesh=null,this._defaultFrameData=null,this.renderDatas=null}}class v{}v.BONEVERTEX=22,v.RIGIDBODYVERTEX=9;const P=[0,1,2,2,3,0];class I{constructor(){this.vertexCount=0,this.indexCount=0,this.isNormalRender=!1,this.vertexBones=0}init(e,n,r,i,a){this.slotId=r,this.sourceData=e,this.attachment=e.name,this.boneIndex=n;let s=a.color;this.blendMode=a.blendMode;let o,h=this.color=new t.Color,l=a.darkColor;if(e instanceof spine.RegionAttachment){o=e.color;let t=e;this.vertexArray=t.offset,this.stride=2,this.indexArray=P,this.uvs=t.uvs,this.textureName=t.region.page.name}else if(e instanceof spine.MeshAttachment){o=e.color;let t=v.BONEVERTEX,n=e;if(this.textureName=n.region.page.name,n.bones&&0!=n.bones.length){i&&i.length,this.stride=t-6;let e=n.uvs.length/2,r=this.vertexArray=new Float32Array(e*this.stride);this.indexArray=n.triangles,this.uvs=n.uvs;let a=n.vertices,s=n.bones,o=0,h=(t-6)/4;this.vertexBones=h;for(let t=0,n=0;t<e;t++){let e=s[o++];e+=o;let i=[],l=t*this.stride,d=0;for(;o<e;o++,n+=3,d++)i.push([a[n],a[n+1],a[n+2],s[o]]);i.length>h&&(this.vertexBones=Math.max(this.vertexBones,i.length),i.length=h,this.isNormalRender=!0);for(let e=0;e<h;e++){let t=i[e];t&&(r[l+4*e]=t[0],r[l+4*e+1]=t[1],r[l+4*e+2]=t[2],r[l+4*e+3]=t[3])}}}else i&&i.length>1?this.vertexArray=new Float32Array(i):this.vertexArray=n.vertices,this.stride=2,this.indexArray=n.triangles,this.uvs=n.uvs}else e instanceof spine.ClippingAttachment?(this.attachment=null,this.isClip=!0):e instanceof spine.PathAttachment?(this.attachment=e.name,this.vertexArray=new Float32Array(e.vertices),this.isPath=!0):this.attachment=null;return this.textureName&&(this.vertexCount=this.vertexArray.length/this.stride,this.indexCount=this.indexArray.length),o&&(this.lightColor=o,h.r=s.r*o.r,h.g=s.g*o.g,h.b=s.b*o.b,h.a=s.a*o.a),this.darkColor=l,!0}}class b{constructor(){this.renderData=[],this.id=b.ID++}addData(e,t,n,r,i){this.currentData={textureName:e,blendMode:t,offset:n,length:r,attachment:i},this.renderData.push(this.currentData)}endData(e){this.currentData.length=e-this.currentData.offset}}b.ID=0;class B{constructor(){this.ibLength=0,this.maxIndexCount=0}updateFormat(e){let t=i.getIndexFormat(e);this.type!==t&&(this.type=t,this._updateBuffer())}setBufferLength(e){e<=this.maxIndexCount||(this.maxIndexCount=e,this._updateBuffer())}_updateBuffer(){let e=this.ib;switch(this.type){case t.IndexFormat.UInt16:this.size=2,this.ib=new Uint16Array(this.maxIndexCount);break;case t.IndexFormat.UInt8:this.size=1,this.ib=new Uint8Array(this.maxIndexCount);break;case t.IndexFormat.UInt32:this.size=4,this.ib=new Uint32Array(this.maxIndexCount)}e&&this.ib.set(e)}createIB(e,t,n){let r,a,s=0,o=t.slotVBMap;n?(r=n,a=function(t){return e[t]}):(r=e,a=function(e){return e});let h,l,d=new b,c=[],m=-1;for(let e=0,t=r.length;e<t;e++){let t=a(r[e]);if(t.attachment&&!t.isPath){let e=!1;h!=t.textureName&&(h=t.textureName,e=!0),l!=t.blendMode&&(l=t.blendMode,e=!0),e&&(d.currentData&&d.endData(s),d.addData(t.textureName,t.blendMode,s,0,t.attachment));let n=o.get(t.slotId).get(t.attachment);t.attachment&&t.indexArray&&(c.push({data:t.indexArray,offset:n.offset,start:s}),s+=t.indexArray.length,m=Math.max(m,s))}}let p=t.maxVertexCount,u=i.getIndexFormat(p),f=!1;u!==this.type&&(this.type=u,f=!0),m>this.maxIndexCount&&(this.maxIndexCount=m,f=!0),f&&this._updateBuffer();let _=this.ib;for(let e=0,t=c.length;e<t;e++){let t=c[e],n=t.offset,r=t.start;for(let e=0,i=t.data.length;e<i;e++)_[r+e]=t.data[e]+n}h&&d.endData(s),this.outRenderData=d,this.ibLength=s}}class E{static checkAttachment(t){if(null==t)return e.ESpineRenderType.rigidBody;if(t instanceof window.spine.RegionAttachment)return e.ESpineRenderType.rigidBody;if(t instanceof window.spine.MeshAttachment){return t.bones?e.ESpineRenderType.boneGPU:e.ESpineRenderType.rigidBody}return e.ESpineRenderType.normal}static appendIndexArray(e,t,n,r){if(!e.attachment||!e.indexArray)return r;let i=e.indexArray;for(let e=0,a=i.length;e<a;e++)t[r]=i[e]+n,r++;return r}}class w{constructor(e){this.animator=e,this.reset()}set skinIndex(e){this.currentSKin=this.animator.skinDataArray[e]}get name(){return this.animator.name}reset(){this.currentTime=-1,this.currentFrameIndex=-1}renderWithOutMat(e,t,n){let r=this.currentFrameIndex,i=this.animator.getFrameIndex(n,r);t.renderUpdate(this.currentSKin,i,r),this.currentTime=n,this.currentFrameIndex=i}render(e,t,n,r,i,a,s){this.renderWithOutMat(t,n,r),this.currentSKin.updateBoneMat(r,this.animator,e,this.state,i,a,s)}}class C{constructor(e,t){this.currentMaterials=[],this.cacheMaterials=[],this.vChanges=[],this.vertexBones=0,this.owner=e,this.name=t.name,this.hasNormalRender=t.hasNormalRender,this.vertexBones=t.vertexBones,this.skinAttachType=t.type}getMaterialByName(e,t){return this.templet.getMaterial(this.templet.getTexture(e),t)}renderUpdate(e,t,n){const r=this.owner._nodeOwner;let i=!1;i=e.isDynamic?this.updateDynamicRender(e,t,n,r):this.handleRender(e,t,r,e.getMesh()),i&&r._updateRenderElements()}updateDynamicRender(e,t,n,r){let a=this.owner.getDynamicMesh(e.vb.vertexDeclaration),s=this.vChanges,o=e.getFrameData(t),h=n<0,l=!1;h&&(this._resetVertexBuffset(e),s.length=0);for(let r=n+1;r<=t;r++){let t=e.getFrameData(r).vChanges;if(t)for(const e of t)s.includes(e)||s.push(e)}for(let n=s.length-1;n>=0;n--){s[n].apply(t,e.vb,this.owner._skeleton.slots)?l=!0:s.splice(n,1)}(l||h)&&this.uploadVertexBuffer(e.vb,a),(o.ib||h)&&this.uploadIndexBuffer(o,a);let d=i._updateSpineSubMesh(a,o);return this.handleRender(e,t,r,a,d)}handleRender(e,t,n,r,i=!1){let a=!1,s=e.getFrameData(t).mulitRenderData;if(s){let e=this.cacheMaterials[s.id]||this.createMaterials(s);this.currentMaterials!==e&&(n._updateMaterials(e),a=!0,this.currentMaterials=e)}return!n._onMeshChange(r,i)||a}createMaterials(e){let t=e.renderData.map(e=>this.getMaterialByName(e.textureName,e.blendMode));return this.cacheMaterials[e.id]=t,t}uploadIndexBuffer(e,t){let n=e.ib,r=t._indexBuffer;r.indexType=e.type,r.indexCount=n.length,r._setIndexDataLength(n.byteLength),r._setIndexData(n,0)}uploadVertexBuffer(e,t){let n=t.vertexBuffers[0],r=4*e.vbLength;n.setDataLength(e.maxVertexCount*e.vertexSize*4),n.setData(e.vb.buffer,0,0,r)}init(e,t,n){this.templet=t,this.hasNormalRender&&(this._renderer=p.createNormalRender(t))}render(e){}_resetVertexBuffset(e){let t=this.owner._skeleton.slots,n=e.vb.slotVBMap,r=e.renderDatas,i=new Set;r.forEach(e=>{if(e.vChanges)for(const t of e.vChanges)i.add(t.slotId)}),i.forEach(r=>{var i;let a=t[r];if(a&&a.attachment){let t=null===(i=n.get(r))||void 0===i?void 0:i.get(a.attachment.name);t&&e.vb.resetVB(t.attachment)}})}destroy(){this.hasNormalRender&&this._renderer.destroy()}}class M{constructor(e){this._skinIndex=0,this.renderProxyMap=new Map,this._dynamicMap=new Map,this.animatorMap=new Map,this.skinRenderArray=[],this.boneMat=new Float32Array(8*e.maxBoneNumber),e.skinAttachArray.forEach(e=>{this.skinRenderArray.push(new C(this,e))});let t=e.animators;for(let e=0,n=t.length;e<n;e++){let n=t[e];this.animatorMap.set(n.name,new w(n))}this.currentRender=this.skinRenderArray[this._skinIndex]}getSpineColor(){return this.spineColor}destroy(){this.skinRenderArray.forEach(e=>e.destroy()),this._dynamicMap.forEach(e=>e.destroy()),this._dynamicMap.clear(),this._nodeOwner._onMeshChange(null)}initBake(e){if(this.bakeData=e,e){let t=this.renderProxyMap.get(R.RenderBake)||new L(this._nodeOwner);t.simpleAnimatorTexture=e.texture2d,t._bonesNums=e.bonesNums,t.aniOffsetMap=e.aniOffsetMap,this.renderProxyMap.set(R.RenderBake,t)}this.isBake=!!e,this._curAnimationName&&(this._clear(),this.play(this._curAnimationName))}changeSkeleton(e){this._skeleton=e,this.renderProxyMap.forEach(t=>{t.changeSkeleton(e)}),e.showSkinByIndex(this._skinIndex),this._skeleton.setSlotsToSetupPose()}init(e,n,r,i){this._skeleton=e,this._nodeOwner=r;let a=e.color;this.spineColor=new t.Color(a.r,a.g,a.b,a.a);let s=r._spriteShaderData.getColor(t.BaseRenderNode2D.BASERENDER2DCOLOR)||new t.Color;s.setValue(a.r,a.g,a.b,a.a),void 0!==r._renderAlpha?s.a*=r._renderAlpha:s.a*=r.owner.alpha,r._spriteShaderData.setColor(t.BaseRenderNode2D.BASERENDER2DCOLOR,s),this.skinRenderArray.forEach(t=>{t.init(e,n,r)}),this._state=i,this.animatorMap.forEach((e,t)=>{e.state=i});let o=new T(this._nodeOwner),h=new N(this._nodeOwner);this.renderProxyMap.set(R.RenderNormal,h),this.renderProxyMap.set(R.RenderOptimize,o)}get renderProxytype(){return this._renderProxytype}set renderProxytype(e){this.isBake&&e==R.RenderOptimize&&null!=this.bakeData.aniOffsetMap[this._curAnimationName]&&(e=R.RenderBake),this.renderProxy=this.renderProxyMap.get(e),e==R.RenderNormal&&(this._nodeOwner._spriteShaderData.removeDefine(a.SPINE_FAST),this._nodeOwner._spriteShaderData.removeDefine(a.SPINE_RB)),this._renderProxytype=e}beginCache(){this._state.apply=this._state.applyCache,this._state.getCurrentPlayTime=this._state.getCurrentPlayTimeByCache,this._skeleton.updateWorldTransform=this._skeleton.updateWorldTransformCache}endCache(){this._state.apply=this._state.oldApply,this._state.getCurrentPlayTime=this._state.getCurrentPlayTimeOld,this._skeleton.updateWorldTransform=this._skeleton.oldUpdateWorldTransform}setSkinIndex(t){switch(this._skinIndex=t,this.currentRender=this.skinRenderArray[t],this.currentRender.skinAttachType){case e.ESpineRenderType.boneGPU:this._nodeOwner._spriteShaderData.addDefine(a.SPINE_FAST),this._nodeOwner._spriteShaderData.removeDefine(a.SPINE_RB);break;case e.ESpineRenderType.rigidBody:this._nodeOwner._spriteShaderData.addDefine(a.SPINE_RB),this._nodeOwner._spriteShaderData.removeDefine(a.SPINE_FAST);break;case e.ESpineRenderType.normal:this._nodeOwner._spriteShaderData.removeDefine(a.SPINE_FAST),this._nodeOwner._spriteShaderData.removeDefine(a.SPINE_RB)}this.currentAnimation&&(this._clear(),this.play(this._curAnimationName))}getDynamicMesh(e,t=!0){let n=e.id,r=this._dynamicMap.get(n);return!r&&t&&(r=i.createMeshDynamic(e),r._addReference(),this._dynamicMap.set(n,r)),r}_clear(){this._nodeOwner.clear(),this._isRender=!1}play(t){this._curAnimationName=t;let n=this.currentRender,r=this.renderProxy,i=this.currentAnimation,s=i?i.currentSKin:null,o=this.currentAnimation=this.animatorMap.get(t);o.skinIndex=this._skinIndex;let h=o.currentSKin;if(i&&i.reset(),h.isNormalRender)this.renderProxytype=R.RenderNormal;else{switch(n.vertexBones>4&&console.warn(`In FastRender mode - Current skin: ${n.name} has ${n.vertexBones} bones influencing each vertex. This exceeds the recommended limit of 4 bones per vertex.`),this.currentRender.skinAttachType){case e.ESpineRenderType.boneGPU:this._nodeOwner._spriteShaderData.addDefine(a.SPINE_FAST),this._nodeOwner._spriteShaderData.removeDefine(a.SPINE_RB);break;case e.ESpineRenderType.rigidBody:this._nodeOwner._spriteShaderData.addDefine(a.SPINE_RB),this._nodeOwner._spriteShaderData.removeDefine(a.SPINE_FAST);break;case e.ESpineRenderType.normal:this._nodeOwner._spriteShaderData.removeDefine(a.SPINE_FAST),this._nodeOwner._spriteShaderData.removeDefine(a.SPINE_RB)}i&&s.isNormalRender&&this._clear(),s==h&&this._nodeOwner._mesh||(this.currentAnimation.currentFrameIndex=-1),this._isRender||(this.renderProxytype=R.RenderOptimize,this._isRender=!0)}r&&r.leave(),this.renderProxy.change(n,o),!o.animator.isCache&&this.renderProxytype!=R.RenderBake||h.isNormalRender?this.endCache():this.beginCache()}complete(){this.currentAnimation.currentFrameIndex=-1}render(e){this.renderProxy.render(e,this.boneMat)}}var R,k;!function(e){e[e.RenderNormal=0]="RenderNormal",e[e.RenderOptimize=1]="RenderOptimize",e[e.RenderBake=2]="RenderBake"}(R||(R={}));class T{constructor(e){this._renderNode=e,this.changeSkeleton(e.getSkeleton())}changeSkeleton(e){this._skeleton=e,this.bones=e.bones,this.slots=e.slots}change(e,t){this.skinUpdate=e,this.currentAnimation=t}leave(){}render(e,t){this.currentAnimation.render(this.bones,this.slots,this.skinUpdate,e,t,-this._skeleton.x,-this._skeleton.y),this._renderNode._spriteShaderData.setBuffer(a.BONEMAT,t)}}class N{constructor(e){this._renderNode=e,this.changeSkeleton(e.getSkeleton())}changeSkeleton(e){this._skeleton=e}leave(){this._renderNode._spriteShaderData.removeDefine(a.SPINE_COLOR2)}change(e,t){this._renderer=e._renderer,this._renderNode._spriteShaderData.addDefine(a.SPINE_COLOR2)}render(e,t){this._renderNode.clear(),this._renderer.draw(this._skeleton,this._renderNode,-1,-1),this._renderNode.owner._struct.renderElements=this._renderNode._renderElements}}class L{get simpleAnimatorTexture(){return this._simpleAnimatorTexture}set simpleAnimatorTexture(e){this._simpleAnimatorTexture&&this._simpleAnimatorTexture._removeReference(),this._simpleAnimatorTexture=e,this._simpleAnimatorTextureSize=e.width,this._renderNode._spriteShaderData.setTexture(a.SIMPLE_SIMPLEANIMATORTEXTURE,e),e._addReference(),this._renderNode._spriteShaderData.setNumber(a.SIMPLE_SIMPLEANIMATORTEXTURESIZE,this._simpleAnimatorTextureSize)}get simpleAnimatorOffset(){return this._simpleAnimatorOffset}set simpleAnimatorOffset(e){e.cloneTo(this._simpleAnimatorOffset)}constructor(e){this.step=1/60,this._simpleAnimatorParams=new t.Vector4,this._renderNode=e,this._simpleAnimatorOffset=new t.Vector2,this.changeSkeleton(e.getSkeleton())}changeSkeleton(e){this._skeleton=e,this.bones=e.bones,this.slots=e.slots}leave(){this._renderNode._spriteShaderData.removeDefine(a.SPINE_SIMPLE),this._renderNode._renderType=t.BaseRender2DType.spine}change(e,n){this.skinRender=e,this.currentAnimation=n,this._renderNode._spriteShaderData.addDefine(a.SPINE_SIMPLE),this._simpleAnimatorOffset.x=this.aniOffsetMap[n.name],n.currentSKin.canInstance&&(this._renderNode._renderType=t.BaseRender2DType.spineSimple)}_computeAnimatorParamsData(){this._simpleAnimatorParams.x=this._simpleAnimatorOffset.x,this._simpleAnimatorParams.y=Math.round(this._simpleAnimatorOffset.y)*this._bonesNums*2}setCustomData(e,t=0){this._simpleAnimatorParams.z=e,this._simpleAnimatorParams.w=t}render(e,t){this.currentAnimation.renderWithOutMat(this.slots,this.skinRender,e),this._simpleAnimatorOffset.y=e/this.step,this._computeAnimatorParamsData(),this._renderNode._spriteShaderData.setVector(a.SIMPLE_SIMPLEANIMATORPARAMS,this._simpleAnimatorParams)}}class O{constructor(e,t=0,n=!0){this._vertexSize=0,this._baseVtxCount=6,this._boneVtxCount=4,this.twoColorTint=!1,this.boneMaxId=0,this.maxVertexCount=t,this.vertexFlag=e,this.mapIndex=new Map,this.slotVBMap=new Map,this.boneArray=[],this.vbLength=0,n&&(this._vertexDeclaration=i.getVertexDeclaration(this.vertexFlag),this.twoColorTint=-1!=e.indexOf("COLOR2"),this.twoColorTint&&(this._baseVtxCount+=4),this._vertexSize=this._vertexDeclaration.vertexStride/4,this._boneVtxCount=this._vertexSize-this._baseVtxCount,this._updateBuffer())}setBufferLength(e){e<=this.maxVertexCount||(this.maxVertexCount=e,this._updateBuffer())}_updateBuffer(){let e=this.vb;this.vb=new Float32Array(this.maxVertexCount*this.vertexSize),e&&this.vb.set(e)}get vertexSize(){return this._vertexSize}get vertexDeclaration(){return this._vertexDeclaration}appendAndCreateIB(e){this.appendVB(e)}getBoneId(e){let t=this.mapIndex.get(e);return null==t&&(t=this.boneMaxId,this.mapIndex.set(e,t),this.boneArray.push(t,e),this.boneMaxId++),t}initBoneMat(){this.boneMat=new Float32Array(8*this.mapIndex.size)}appendVB(e){let t,n=this.slotVBMap.get(e.slotId);if(n){let t=n.get(e.attachment);if(null!=t)return t}else n=new Map,this.slotVBMap.set(e.slotId,n);return t=this.vbLength/this.vertexSize,n.set(e.attachment,{offset:t,attachment:e}),e.vertexCount?(t+e.vertexCount>=this.maxVertexCount&&this.setBufferLength(t+e.vertexCount),this.vbLength=this.appendVertexArray(e,this.vb,this.vbLength,this),t):t}resetVB(e){var t;if(e.isPath)return;let n=null===(t=this.slotVBMap.get(e.slotId))||void 0===t?void 0:t.get(e.attachment);n&&this.appendVertexArray(e,this.vb,n.offset*this.vertexSize,this)}updateBone(e,t,n=0,r=0){let i=this.boneArray;for(let a=0,s=i.length;a<s;a+=2){let s=8*i[a],o=e[i[a+1]];t[s]=o.a,t[s+1]=o.b,t[s+2]=o.worldX+n,t[s+3]=0,t[s+4]=o.c,t[s+5]=o.d,t[s+6]=o.worldY+r,t[s+7]=0}}updateBoneCache(e,t,n,r=0,i=0){let a,s=this.boneArray,o=Math.floor(t);a=o==e.length-1?0:t-o;let h=e[o],l=e[o+1];if(a>1e-4)for(let e=0,t=s.length;e<t;e+=2){let t=8*s[e],r=h[s[e+1]],i=l[s[e+1]];n[t]=r[0]+(i[0]-r[0])*a,n[t+1]=r[1]+(i[1]-r[1])*a,n[t+2]=r[2]+(i[2]-r[2])*a,n[t+3]=0,n[t+4]=r[4]+(i[4]-r[4])*a,n[t+5]=r[5]+(i[5]-r[5])*a,n[t+6]=r[6]+(i[6]-r[6])*a,n[t+7]=0}else for(let e=0,t=s.length;e<t;e+=2){let t=8*s[e],r=h[s[e+1]];n.set(r,t)}}_cloneTo(e){e.vb=new Float32Array(this.vb),e.vbLength=this.vbLength,e.mapIndex=new Map(this.mapIndex),e.boneMaxId=this.boneMaxId,e.boneArray=this.boneArray.slice(),e._vertexDeclaration=this._vertexDeclaration,e._vertexSize=this._vertexSize,e.twoColorTint=this.twoColorTint,e._baseVtxCount=this._baseVtxCount,e._boneVtxCount=this._boneVtxCount,e.vertexFlag=this.vertexFlag,this.slotVBMap.forEach((t,n)=>{e.slotVBMap.set(n,new Map(t))})}clone(){let e=this._create();return this._cloneTo(e),e}}class V extends O{_create(){return new V(this.vertexFlag,this.maxVertexCount,!1)}appendVertexArray(e,t,n,r){if(!e.attachment)return r.getBoneId(e.boneIndex),n;let i=this.vertexSize,a=e.vertexArray,s=e.uvs,o=e.color,h=o.r,l=o.g,d=o.b,c=o.a,m=this._boneVtxCount/4,p=e.darkColor,u=0,f=0,_=0,g=1;if(p&&(u=p.r,f=p.g,_=p.b,g=p.a),2==e.stride){let o=r.getBoneId(e.boneIndex);for(let r=0,p=a.length;r<p;r+=e.stride){t[n]=s[r],t[n+1]=s[r+1],t[n+2]=h,t[n+3]=l,t[n+4]=d,t[n+5]=c,t[n+6]=a[r],t[n+7]=a[r+1],t[n+8]=1,t[n+9]=o;let e=n+10;for(let n=0,r=m-1;n<r;n++){let r=e+4*n;t[r]=0,t[r+1]=0,t[r+2]=0,t[r+3]=0}if(this.twoColorTint){let e=n+6+this._boneVtxCount;t[e]=u,t[e+1]=f,t[e+2]=_,t[e+3]=g}n+=i}}else for(let o=0,p=0,x=a.length;o<x;o+=e.stride,p+=2){t[n]=s[p],t[n+1]=s[p+1],t[n+2]=h,t[n+3]=l,t[n+4]=d,t[n+5]=c;let e=n+6;for(let n=0;n<m;n++){let i=e+4*n,s=o+4*n;t[i]=a[s],t[i+1]=a[s+1],t[i+2]=a[s+2],t[i+3]=r.getBoneId(a[s+3])}if(this.twoColorTint){let n=e+this._boneVtxCount;t[n]=u,t[n+1]=f,t[n+2]=_,t[n+3]=g}n+=i}return n}appendDeform(e,t,n,r){if(!e.attachment)return;let i=this.vertexSize,a=e.vertexArray;if(2==e.stride)for(let s=0,o=a.length;s<o;s+=e.stride)r[n+6]=t[s],r[n+7]=t[s+1],n+=i;else{let s=e.sourceData.bones,o=e.vertexCount,h=this._boneVtxCount/4,l=0,d=0;for(let e=0;e<o;e++){let o=s[d++],c=e*this._boneVtxCount,m=n+e*i+6;for(let e=0;e<o&&!(e>=h);e++){let n=l+2*e,i=c+4*e,s=m+4*e;r[s]=a[i]+t[n],r[s+1]=a[i+1]+t[n+1]}d+=o,l+=2*o}}}}class F extends O{_create(){return new F(this.vertexFlag,this.maxVertexCount,!1)}appendVertexArray(e,t,n,r){let i=e.vertexArray,a=e.uvs,s=e.color,o=e.darkColor,h=this.vertexSize,l=s.r,d=s.g,c=s.b,m=s.a,p=0,u=0,f=0,_=1;if(o&&(p=o.r,u=o.g,f=o.b,_=o.a),2==e.stride){let s=r.getBoneId(e.boneIndex);for(let r=0,o=i.length;r<o;r+=e.stride){if(t[n+0]=a[r],t[n+1]=a[r+1],t[n+2]=l,t[n+3]=d,t[n+4]=c,t[n+5]=m,t[n+6]=i[r],t[n+7]=i[r+1],t[n+8]=s,this.twoColorTint){let e=n+9;t[e]=p,t[e+1]=u,t[e+2]=f,t[e+3]=_}n+=h}}return n}appendDeform(e,t,n,r){if(!e.attachment)return;let i=this.vertexSize,a=e.vertexArray;if(2==e.stride)for(let s=0,o=a.length;s<o;s+=e.stride)r[n+6]=t[s],r[n+7]=t[s+1],n+=i}}class U{constructor(){this.blendModeMap=new Map,this.skinAttachArray=[],this.animators=[],this.canCache=U.cacheSwitch}_initSpineRender(e,t,n,r){let i;return U.normalRenderSwitch?i=new f:this.maxBoneNumber>U.MAX_BONES?(console.warn("The number of Bones :",this.maxBoneNumber," > ",U.MAX_BONES,", use CPU caculation"),i=new f):i=new M(this),i.init(e,t,n,r),i}_updateState(e){return this._state.update(e),this._state.getCurrent(0),this._state.apply(this.sketon),this.sketon.updateWorldTransform(2),this.sketon.bones}_play(e){let t=this._state.setAnimation(0,e,!0);return t.animationStart=0,t.animation.duration}checkMainAttach(e){this.sketon=new spine.Skeleton(e),this._stateData=new spine.AnimationStateData(this.sketon.data),this._state=new spine.AnimationState(this._stateData),this.attachMentParse(e),this.initAnimation(e.animations)}attachMentParse(e){let t,n=e.skins,r=e.slots;this._tempIbCreate=new B;for(let e=0,i=n.length;e<i;e++){let i=n[e],a=new z;a.name=i.name,a._tempIbCreate=this._tempIbCreate,0!=e&&a.copyFrom(t),a.attachMentParse(i,r),this.skinAttachArray.push(a),a.init(r),0==e&&(t=a)}}initAnimation(e){let t=0;for(let n=0,r=e.length;n<r;n++){let r=e[n],i=new D;i.check(r,this),this.animators.push(i),this.skinAttachArray.forEach(e=>{e.initAnimator(i)}),i.skinDataArray.forEach(e=>{if(!e.isNormalRender){let n=e.vb.boneArray.length/2;n>t&&(t=n)}})}this.maxBoneNumber=t}cacheBone(){if(!U.cacheSwitch)for(let e=0,t=this.animators.length;e<t;e++){let t=this.animators[e];0==t.boneFrames.length&&t.cacheBones(this)}}destroy(){for(let e=0,t=this.animators.length;e<t;e++)this.animators[e].destroy();this.animators.length=0}init(e){}}U.normalRenderSwitch=!1,U.MAX_BONES=100,U.cacheSwitch=!1;class z{constructor(){this.vertexBones=0,this.slotAttachMap=new Map,this.mainAttachMentOrder=[]}copyFrom(e){e.slotAttachMap.forEach((e,t)=>{this.slotAttachMap.set(t,new Map(e))})}attachMentParse(t,n){let r,i=e.ESpineRenderType.rigidBody,a=0,s=t.attachments,o=0,h=0,l=!1;for(let e=0,t=n.length;e<t;e++){let t=s[e],r=n[e],d=r.boneData.index,c=this.slotAttachMap.get(e),m=r.attachmentName;if(c||(c=new Map,this.slotAttachMap.set(e,c)),t)for(let n in t){let s=t[n],m=null,p=new I;p.init(s,d,e,m,r),a=Math.max(a,p.vertexBones);let u=E.checkAttachment(p?p.sourceData:null);u<i&&(i=u),h+=p.indexCount,o+=p.vertexCount,l=l||!!p.darkColor,c.set(n,p)}else if(m){let e=c.get(m);if(e){h+=e.indexCount,o+=e.vertexCount,a=Math.max(a,e.vertexBones);let t=E.checkAttachment(e?e.sourceData:null);t<i&&(i=t),l=l||!!e.darkColor}}if(!c.get(null)){let t=new I;t.slotId=e,t.color=r.color,t.boneIndex=d,t.attachment=null,c.set(t.attachment,t)}}switch(this.type=i,this.vertexBones=a,this.type){case e.ESpineRenderType.normal:case e.ESpineRenderType.boneGPU:r="UV,COLOR,POSITION,BONE",l&&(r+=",COLOR2"),this.mainVB=new V(r,o);break;case e.ESpineRenderType.rigidBody:r="UV,COLOR,POSITION,RIGIDBODY",l&&(r+=",COLOR2"),this.mainVB=new F(r,o)}this.mainIB=new B,this.mainIB.updateFormat(o),this.mainIB.setBufferLength(h)}init(e){let t=this.mainAttachMentOrder;e.forEach((e,n)=>{let r=e.attachmentName;if(r){let e=this.slotAttachMap.get(n).get(r);e?this.mainVB.appendVB(e):e=this.slotAttachMap.get(n).get(null),e.isClip&&(this.isNormalRender=!0),t.push(e)}else{let e=this.slotAttachMap.get(n).get(null);t.push(e)}}),this.mainVB.initBoneMat(),this.mainIB.createIB(t,this.mainVB)}initAnimator(e){let t=e.createSkinData(this.mainVB,this.mainIB,this._tempIbCreate,this.slotAttachMap,this.mainAttachMentOrder,this.type);t.name=this.name,this.isNormalRender&&(t.isNormalRender=!0),t.isNormalRender&&(this.hasNormalRender=!0)}}class j{getSpineColor(){return t.Color.WHITE}changeSkeleton(e){}init(e,t,n,r){}play(e){}render(e){}setSkinIndex(e){}initBake(e){}destroy(){}complete(){}}j.instance=new j;class W extends t.BaseRenderNode2D{static createRenderElement2D(){if(this._pool.length>0)return this._pool.pop();let e=t.LayaGL.render2DRenderPassFactory.createRenderElement2D();return e.renderStateIsBySprite=!1,e.nodeCommonMap=["spine2D"],e}static recoverRenderElement2D(e){e.canotPool||this._pool.push(e)}constructor(){super(),this._currentPlayTime=0,this._pause=!0,this._playbackRate=1,this._playAudio=!0,this._soundChannelArr=[],this.trackIndex=0,this._skinName="default",this._loop=!0,this._offset=new t.Vector2,this._nMatrix_0=new t.Vector3,this._nMatrix_1=new t.Vector3,this.physicsUpdate=2,this._useFastRender=!0,this._needUpdate=!1,this._renderElements=[],this._materials=[],this.spineItem=j.instance}_getcommonUniformMap(){return["BaseRender2D","Spine2D"]}_getRenderHandle(){return t.LayaGL.render2DRenderPassFactory.createSpineRenderDataHandle()}get externalSkins(){return this._externalSkins}set externalSkins(e){if(e)for(let t=e.length-1;t>=0;t--)e[t].target=this;this._externalSkins=e}renderUpdate(e){this._updateLight()}resetExternalSkin(){this._skeleton&&(this._skeleton=new spine.Skeleton(this._templet.skeletonData),this.spineItem.changeSkeleton(this._skeleton),this._renderHandle.skeleton=this._skeleton,this._flushExtSkin())}get source(){return this._source}set source(e){if(this._source=e,e){let n=t.ILaya.loader.getRes(e,t.Loader.SPINE);n?this.templet=n:t.ILaya.loader.load(e,t.Loader.SPINE).then(e=>{!this._source||e&&!e.isCreateFromURL(this._source)||this.destroyed||(this.templet=e)})}else this.templet=null}get skinName(){return this._skinName}set skinName(e){this._skinName=e,this._templet&&this.showSkinByName(e)}get animationName(){return this._animationName}set animationName(e){this._animationName=e,this._templet&&this.play(e,this._loop,!0)}get maxDetlaTime(){return this._timeKeeper.maxDelta}set maxDetlaTime(e){this._timeKeeper.maxDelta=e}get loop(){return this._loop}set loop(e){this._loop=e,this._templet&&this.play(this._animationName,this._loop,!0)}get url(){return this._skin}set url(e){this._skin!=e&&(this._skin=e,t.Laya.loader.load(e,t.Loader.SPINE).then(e=>{this.init(e)}))}get twoColorTint(){return this._spriteShaderData.hasDefine(a.SPINE_TWOCOLORTINT)}set twoColorTint(e){e?this._spriteShaderData.addDefine(a.SPINE_TWOCOLORTINT):this._spriteShaderData.removeDefine(a.SPINE_TWOCOLORTINT)}get templet(){return this._templet}set templet(e){this.init(e)}set currentTime(e){if(this._templet){if((e/=1e3)<this._playStart||this._playEnd&&e>this._playEnd||e>this._duration)throw new Error("AnimationPlayer: value must large than playStartTime,small than playEndTime.");this._state.update(e-this._currentPlayTime),this._currentPlayTime=e}}get playState(){return this._pause?this._currentPlayTime?W.PAUSED:W.STOPPED:W.PLAYING}get useFastRender(){return this._useFastRender}set useFastRender(e){this._useFastRender!==e&&(this._useFastRender=e,this._templet&&(e?this.changeFast():this.changeNormal(),this.play(this._animationName,this._loop,!0,this._currentPlayTime)))}onEnable(){this._offset.setValue(this.owner.pivotX,this.owner.pivotY),this._renderHandle.offset=this._offset,this.owner.on(t.Event.TRANSFORM_CHANGED,this,this.onTransformChanged),this._skeleton&&t.LayaEnv.isPlaying&&void 0!==this._animationName&&this.play(this._animationName,this._loop,!0)}onDisable(){this.owner.off(t.Event.TRANSFORM_CHANGED,this,this.onTransformChanged)}init(e){if(this.destroyed)return;if(this._templet&&(this.clear(),this.reset()),this._templet=e,!this._templet)return;if(this._templet._addReference(),this._skeleton=new spine.Skeleton(this._templet.skeletonData),this._renderHandle.skeleton=this._skeleton,this._stateData=new spine.AnimationStateData(this._skeleton.data),this._state=new spine.AnimationState(this._stateData),this._timeKeeper=new G(t.Laya.timer),this._useFastRender)this.spineItem=this._templet.sketonOptimise._initSpineRender(this._skeleton,this._templet,this,this._state);else{let e=U.normalRenderSwitch;U.normalRenderSwitch=!0,this.spineItem=this._templet.sketonOptimise._initSpineRender(this._skeleton,this._templet,this,this._state),U.normalRenderSwitch=e}let n=this._templet.getSkinIndexByName(this._skinName);-1!=n&&this.showSkinByIndex(n),this._state.addListener({start:e=>{},interrupt:e=>{},end:e=>{},dispose:e=>{},complete:e=>{this.event(t.Event.END),e.loop?this.complete():this.stop()},event:(n,r)=>{let i={audioValue:r.data.audioPath,audioPath:r.data.audioPath,floatValue:r.floatValue,intValue:r.intValue,name:r.data.name,stringValue:r.stringValue,time:1e3*r.time,balance:r.balance,volume:r.volume};if(this.event(t.Event.LABEL,i),this._playAudio&&i.audioValue){let n=t.SoundManager.playSound(e.basePath+i.audioValue,1,t.Handler.create(this,this._onAniSoundStoped),null,(1e3*this._currentPlayTime-i.time)/1e3);t.SoundManager.playbackRate=this._playbackRate,n&&this._soundChannelArr.push(n)}}}),this._flushExtSkin(),this.event(t.Event.READY),t.LayaEnv.isPlaying&&this.enabled&&void 0!==this._animationName&&this.play(this._animationName,this._loop,!0)}play(e,n,r=!0,i=0,a=0,s=!0,o=!0){if(this._playAudio=o,i/=1e3,a/=1e3,this._loop=n,i<0||a<0)throw new Error("SpineSkeleton: start and end must large than zero.");if(0!==a&&i>a)throw new Error("SpineSkeleton: start must less than end.");if("number"==typeof e)e=this.getAniNameByIndex(e);else{if(!!!this.templet.findAnimation(e))return}if(r||this._pause||this._animationName!=e){this._animationName=e,this.spineItem.play(e);let r=this._state.setAnimation(this.trackIndex,e,n);r.animationStart=i,a&&a<r.animationEnd&&(r.animationEnd=a);let s=r.animation.duration;this._duration=s,this._playStart=i,this._playEnd=a<=s?a:s,this._pause&&(this._pause=!1,this._beginUpdate()),this._update(),this.event(t.Event.PLAYED)}}_update(){this._timeKeeper.update();let e=this._state,t=this._timeKeeper.delta*this._playbackRate;e.update(t);let n=this._currentPlayTime=e.getCurrentPlayTime(this.trackIndex);e.apply(this._skeleton),this._state&&this._skeleton&&(this._skeleton.update&&this._skeleton.update(t),this._skeleton.updateWorldTransform(this.physicsUpdate),this.spineItem.render(n),this.owner.repaint())}_flushExtSkin(){if(null==this._skeleton)return;let e=this._externalSkins;if(e){for(let t=e.length-1;t>=0;t--)e[t].flush();this.useFastRender=!1}}getAnimNum(){return this._templet.skeletonData.getAnimationsSize()}getAniNameByIndex(e){return this._templet.getAniNameByIndex(e)}getSlotByName(e){return this._skeleton.findSlot(e)}playbackRate(e){this._playbackRate=e}showSkinByName(e){this.showSkinByIndex(this._templet.getSkinIndexByName(e))}showSkinByIndex(e){this.spineItem.setSkinIndex(e),this._skeleton.showSkinByIndex(e),this._skeleton.setSlotsToSetupPose()}event(e,t){this.owner.event(e,t)}complete(){this.spineItem.complete(),this.event(t.Event.COMPLETE)}stop(){this._pause||(this._pause=!0,this._clearUpdate(),this._state.update(-this._currentPlayTime),this._currentPlayTime=0,this.event(t.Event.STOPPED),this._soundChannelArr.length>0&&this._onAniSoundStoped(!0))}_clearUpdate(){this._needUpdate=!1}_beginUpdate(){this._needUpdate=!0}onUpdate(){this._needUpdate&&this._update()}paused(){if(!this._pause&&(this._pause=!0,this._clearUpdate(),this.event(t.Event.PAUSED),this._soundChannelArr.length>0))for(let e=this._soundChannelArr.length,t=0;t<e;t++){let e=this._soundChannelArr[t];e.isStopped||e.pause()}}resume(){if(this._pause&&(this._pause=!1,this._beginUpdate(),this._soundChannelArr.length>0))for(let e=this._soundChannelArr.length,t=0;t<e;t++){let e=this._soundChannelArr[t];e.audioBuffer&&e.resume()}}_onAniSoundStoped(e){for(let t=this._soundChannelArr.length,n=0;n<t;n++){let r=this._soundChannelArr[n];(r.isStopped||e)&&(!r.isStopped&&r.stop(),this._soundChannelArr.splice(n,1),t--,n--)}}reset(){this._templet._removeReference(1),this._templet=null,this._timeKeeper=null,this._skeleton=null,this._state.clearListeners(),this._state=null,this._pause=!0,this._clearUpdate(),this._soundChannelArr.length>0&&this._onAniSoundStoped(!0)}addAnimation(e,t=!1,n=0){n/=1e3;let r=e;"number"==typeof r&&(r=this.getAniNameByIndex(r)),this._animationName=r,this._state.addAnimation(this.trackIndex,r,t,n)}setMix(e,t,n){n/=1e3;let r=e;"number"==typeof r&&(r=this.getAniNameByIndex(r));let i=t;"number"==typeof i&&(i=this.getAniNameByIndex(i)),this._stateData.setMix(r,i,n)}getBoneByName(e){return this._skeleton.findBone(e)}getSkeleton(){return this._skeleton}physicsTranslate(e,t){this._templet.hasPhysics&&this._skeleton.physicsTranslate(e,t)}onTransformChanged(){if(this._skeleton){let e=this.owner.globalTrans.getMatrix();this._skeleton.x=e.tx,this._skeleton.y=e.ty,0!=this.owner.pivotX||0!=this.owner.pivotY?(this._offset.setValue(this.owner.pivotX,this.owner.pivotY),this._renderHandle.offset=this._offset):this._renderHandle.offset=null}}setSlotAttachment(e,t){this.useFastRender=!1,this._skeleton.setAttachment(e,t)}clear(){this._mesh=null,this._renderElements.forEach(e=>{W.recoverRenderElement2D(e)}),super.clear()}changeFast(){if(!(this.spineItem instanceof M)){this.spineItem.destroy();let e=U.normalRenderSwitch;U.normalRenderSwitch=!1,this.spineItem=this._templet.sketonOptimise._initSpineRender(this._skeleton,this._templet,this,this._state),this.spineItem.setSkinIndex(this._templet.getSkinIndexByName(this._skinName)),U.normalRenderSwitch=e}}changeNormal(){if(!(this.spineItem instanceof f)){this.spineItem.destroy();let e=U.normalRenderSwitch;U.normalRenderSwitch=!0,this.spineItem=this._templet.sketonOptimise._initSpineRender(this._skeleton,this._templet,this,this._state),this.spineItem.setSkinIndex(this._templet.getSkinIndexByName(this._skinName)),U.normalRenderSwitch=e}}onDestroy(){this._templet&&this.reset(),this.spineItem.destroy()}_updateMaterials(e){for(let t=0,n=e.length;t<n;t++)this._materials[t]=e[t]}_updateRenderElements(){let e=this._renderElements.length;for(let t=0;t<e;t++){let e=this._renderElements[t],n=this._materials[t];e.materialShaderData=n.shaderData,e.subShader=n._shader.getSubShaderAt(0),e.value2DShaderData=this.owner._shaderData}this.owner._struct.renderElements=this._renderElements}_onMeshChange(e,t=!1){let n=!1;if(this._mesh!=e||t){if(n=!0,e){let t=e._subMeshes,n=this._renderElements.length,r=Math.max(n,e.subMeshCount);for(let e=0;e<r;e++){let n=this._renderElements[e],r=t[e];if(r){n||(n=W.createRenderElement2D(),this._renderElements[e]=n);let t=this._materials[e];n.geometry=r,n.materialShaderData=t.shaderData,n.subShader=t._shader.getSubShaderAt(0),n.value2DShaderData=this.owner._shaderData,n.nodeCommonMap=this._getcommonUniformMap(),n.owner=this.owner._struct}else W.recoverRenderElement2D(n)}this._renderElements.length=e.subMeshCount,a.changeVertexDefine(this.owner._shaderData,e)}else{for(let e=0,t=this._renderElements.length;e<t;e++)W.recoverRenderElement2D(this._renderElements[e]);this._renderElements.length=0}this.owner._struct&&(this.owner._struct.renderElements=this._renderElements)}return this._mesh=e,n}}W._pool=[],W.STOPPED=0,W.PAUSED=1,W.PLAYING=2;class G{constructor(e){this.maxDelta=.064,this.timer=e}update(){this.delta=this.timer.delta/1e3,this.delta>this.maxDelta&&(this.delta=this.maxDelta)}}t.ClassUtils.regClass("Spine2DRenderNode",W);class X extends t.Sprite{constructor(){super(),this._spineComponent=this.addComponent(W)}get externalSkins(){return this._spineComponent.externalSkins}set externalSkins(e){this._spineComponent.externalSkins=e}resetExternalSkin(){this._spineComponent.resetExternalSkin()}get source(){return this._spineComponent.source}set source(e){this._spineComponent.source=e}get skinName(){return this._spineComponent.skinName}set skinName(e){this._spineComponent.skinName=e}get animationName(){return this._spineComponent.animationName}set animationName(e){this._spineComponent.animationName=e}get loop(){return this._spineComponent.loop}set loop(e){this._spineComponent.loop=e}get templet(){return this._spineComponent.templet}set templet(e){this._spineComponent.templet=e}set currentTime(e){this._spineComponent.currentTime=e}get playState(){return this._spineComponent.playState}get spineItem(){return this._spineComponent.spineItem}set spineItem(e){this._spineComponent.spineItem=e}play(e,t,n=!0,r=0,i=0,a=!0,s=!0){this._spineComponent.play(e,t,n,r,i,a,s)}getAnimNum(){return this._spineComponent.getAnimNum()}getAniNameByIndex(e){return this._spineComponent.getAniNameByIndex(e)}getSlotByName(e){return this._spineComponent.getSlotByName(e)}playbackRate(e){this._spineComponent.playbackRate(e)}showSkinByName(e){this._spineComponent.showSkinByName(e)}showSkinByIndex(e){this._spineComponent.showSkinByIndex(e)}stop(){this._spineComponent.stop()}paused(){this._spineComponent.paused()}resume(){this._spineComponent.resume()}destroy(e=!0){this._spineComponent.templet&&this._spineComponent.reset(),super.destroy(e)}addAnimation(e,t=!1,n=0){this._spineComponent.addAnimation(e,t,n)}setMix(e,t,n){this._spineComponent.setMix(e,t,n)}getBoneByName(e){return this._spineComponent.getBoneByName(e)}getSkeleton(){return this._spineComponent.getSkeleton()}setSlotAttachment(e,t){this._spineComponent.setSlotAttachment(e,t)}}e.ESpineRenderType=void 0,(k=e.ESpineRenderType||(e.ESpineRenderType={}))[k.boneGPU=0]="boneGPU",k[k.normal=1]="normal",k[k.rigidBody=2]="rigidBody";class H extends t.Resource{constructor(){super(),this.materialMap=new Map,this.hasPhysics=!1,this.mainBlendMode=0,this._premultipliedAlpha=!0,this._textures={},this.sketonOptimise=new U}get _mainTexture(){let e,t=0;for(let n in this._textures)if(e=this._textures[n],e&&(t++,t>1))return null;return e}get premultipliedAlpha(){return this._premultipliedAlpha}get basePath(){return this._basePath}getMaterial(e,n){e||(console.error("SpineError:cant Find Main Texture"),e=t.Texture2D.whiteTexture);let r=e.id+"_"+n,i=this.materialMap.get(r);return i||(i=new t.Material,i.setShaderName("SpineStandard"),a.initSpineMaterial(i),i.setTextureByIndex(a.SpineTexture,e),1!=e.gammaCorrection?i.addDefine(t.ShaderDefines2D.GAMMATEXTURE):i.removeDefine(t.ShaderDefines2D.GAMMATEXTURE),a.SetSpineBlendMode(n,i,this._premultipliedAlpha),this._premultipliedAlpha?i.addDefine(a.SPINE_PREMULTIPLYALPHA):i.removeDefine(a.SPINE_PREMULTIPLYALPHA),i._addReference(),this.materialMap.set(r,i)),i}getTexture(e){return this._textures[e]}setTexture(e,t){this._textures[e]=t}_parse(e,t,n,r=!0){var i;let a=new spine.AtlasAttachmentLoader(t);if(e instanceof ArrayBuffer){let t=new spine.SkeletonBinary(a,!1);this.skeletonData=t.readSkeletonData(new Uint8Array(e))}else{let t=new spine.SkeletonJson(a,!1);this.skeletonData=t.readSkeletonData(e)}this._textures=n,this._atlas=t,this.mainBlendMode=(null===(i=this.skeletonData.slots[0])||void 0===i?void 0:i.blendMode)||0,this.mainTexture=this._mainTexture,this.width=this.skeletonData.width,this.height=this.skeletonData.height,this.offsetX=this.skeletonData.x,this.offsetY=this.skeletonData.y,this._premultipliedAlpha=r,this.hasPhysics=this.skeletonData.physicsConstraints&&this.skeletonData.physicsConstraints.length>0,this.sketonOptimise.canCache=this.sketonOptimise.canCache&&!this.hasPhysics,this.sketonOptimise.checkMainAttach(this.skeletonData)}getAniNameByIndex(e){let t=this.skeletonData.getAnimationByIndex(e);return t?t.name:null}findAnimation(e){return this.skeletonData.findAnimation(e)}getSkinIndexByName(e){return this.skeletonData.getSkinIndexByName(e)}_disposeResource(){this.sketonOptimise.destroy();for(let e in this._textures){let t=this._textures[e];t&&t._removeReference()}this._referenceCount<=0?(this.materialMap.forEach(e=>{e._removeReference()}),this.materialMap.clear()):console.error("SpineTemplet is using"),this.skeletonData=null,this.sketonOptimise=null}}H.RuntimeVersion="3.8";class Y{constructor(e){this.realTexture=e}getImage(){var e,t,n,r;return{width:null!==(t=null===(e=this.realTexture)||void 0===e?void 0:e.width)&&void 0!==t?t:16,height:null!==(r=null===(n=this.realTexture)||void 0===n?void 0:n.height)&&void 0!==r?r:16}}setFilters(e,n){if(!this.realTexture)return;let r;r=n===window.spine.TextureFilter.Nearest?t.FilterMode.Point:t.FilterMode.Bilinear,this.realTexture.filterMode=r}convertWrapMode(e){return e==spine.TextureWrap.ClampToEdge?t.WrapMode.Clamp:e==spine.TextureWrap.MirroredRepeat?t.WrapMode.Mirrored:t.WrapMode.Repeat}setWraps(e,t){this.realTexture&&(this.realTexture.wrapModeU=this.convertWrapMode(e),this.realTexture.wrapModeV=this.convertWrapMode(t))}}const K=!1,q=!0;t.Loader.registerLoader(["skel"],class{load(e){let n=t.Utils.replaceFileExtension(e.url,"atlas");return Promise.all([e.loader.fetch(e.url,"skel"==e.ext?"arraybuffer":"json",e.progress.createCallback()),e.loader.fetch(n,"text",e.progress.createCallback())]).then(t=>{if(!t[0]||!t[1])return null;let n=new H,r=H.RuntimeVersion;return"4.1"==r&&(n.needSlot=!0),r.startsWith("4.")?this.parseAtlas4(t[0],t[1],e,n):this.parseAtlas3(t[0],t[1],e,n)})}parseAtlas3(e,n,r,i){var a;let s=[],o=t.URL.getPath(r.url),h=new spine.TextureAtlas(n,e=>{let n=o+e;return s.push({url:n,type:t.Loader.TEXTURE2D,propertyParams:{premultiplyAlpha:K},constructParams:[0,0,t.TextureFormat.R8G8B8A8,!1,!1,q,K]}),new Y(null)});return t.Laya.loader.load(s,null,null===(a=r.progress)||void 0===a?void 0:a.createCallback()).then(t=>{let n={},r=!0;for(var a=0;a<t.length;a++){let e=t[a];e&&e._addReference();let i=h.pages[a];r=i.pma||e&&e._premultiplyAlpha&&r,i.texture.realTexture=e,i.texture.setFilters(i.minFilter,i.magFilter),i.texture.setWraps(i.uWrap,i.vWrap),i.width=i.texture.getImage().width,i.height=i.texture.getImage().height,n[i.name]=e}let s=h.regions;for(const e of s){let t=e.page;e.u=e.x/t.width,e.v=e.y/t.height,e.rotate?(e.u2=(e.x+e.height)/t.width,e.v2=(e.y+e.width)/t.height):(e.u2=(e.x+e.width)/t.width,e.v2=(e.y+e.height)/t.height)}return i._parse(e,h,n,r),i})}parseAtlas4(e,n,r,i){var a;let s=new spine.TextureAtlas(n),o=t.URL.getPath(r.url);return t.Laya.loader.load(s.pages.map(e=>({url:o+e.name,type:t.Loader.TEXTURE2D,propertyParams:{premultiplyAlpha:K},constructParams:[0,0,t.TextureFormat.R8G8B8A8,!1,!1,q,K]})),null,null===(a=r.progress)||void 0===a?void 0:a.createCallback()).then(t=>{let n={},r=s.pages,a=!0;for(let e=0,i=t.length;e<i;e++){let i=t[e];i&&i._addReference();let s=r[e];a=s.pma||i._premultiplyAlpha&&a,n[s.name]=i,s.setTexture(new Y(i))}return i._parse(e,s,n,a),i})}},t.Loader.SPINE);let J=t.ClassUtils.regClass;J("SpineSkeleton",X),J("ExternalSkin",n),J("ExternalSkinItem",r),t.Laya.addBeforeInitCallback(()=>{t.PlayerConfig.spineVersion&&(H.RuntimeVersion=t.PlayerConfig.spineVersion)});class Z extends t.Script{constructor(){super()}onEnable(){this.bakeData&&this.initBake(JSON.parse(this.bakeData))}onDisable(){let e=this.owner.getComponent(W);e.spineItem&&e.spineItem.initBake(null)}async attach(e){let n=await t.Laya.loader.load({url:this.url,type:t.Loader.TEXTURE2D,constructParams:[256,256,t.TextureFormat.R32G32B32A32,!1,!1,!1,!1]});e.initBake({bonesNums:60,aniOffsetMap:{idle:0,skill:21480},texture2d:n})}async initBake(e){const n=e.aniOffsetMap.textureWidth||256;let r=await t.Laya.loader.load({url:e.simpPath,type:t.Loader.TEXTURE2D,constructParams:[n,n,t.TextureFormat.R32G32B32A32,!1,!1,!1,!1]});e.texture2d=r;let i=this.owner.getComponent(W);!i.spineItem||i.spineItem instanceof j?this.owner.on(t.Event.READY,this,()=>{i.spineItem.initBake(e)}):i.spineItem.initBake(e)}}t.ClassUtils.regClass("SpineBakeScript",Z);class ${constructor(){this._recoverList=new t.FastSinglelist}check(e,t){return e.materialShaderData==t.materialShaderData&&!e.geometry.instanceCount&&!t.geometry.instanceCount}batchRenderElement(e,t,n,r=1){let i=e.elements,a=-1;for(let r=0;r<n-1;r++){let n=t+r,s=i[n],o=i[n+1];this.check(s,o)?-1==a&&(a=r):(-1!=a&&this.batch(e,a+t,r-a),a=0)}-1!=a&&this.batch(e,a+t,n-a)}updateBuffer(e,t,n,r){let i=e.nMatrixInstanceVB,a=e.simpleAnimatorVB;i.setData(t.buffer,0,0,6*r*4),a.setData(n.buffer,0,0,4*r*4)}batch(e,n,r){let i,s,o,h=e.elements,l=Q._instanceBufferCreate(6*Q.MaxInstanceCount),d=Q._instanceBufferCreate(4*Q.MaxInstanceCount),c=0;for(let m=0;m<r;m++){let r=h[n+m],p=r.value2DShaderData;if(!i){let e=r.geometry;o=Q.getInstanceInfo(e),i=o.element,this._recoverList.add(o),s=i.geometry,c=s.instanceCount=0,i.subShader=r.subShader,i.materialShaderData=r.materialShaderData,i.value2DShaderData=r.value2DShaderData,i.renderStateIsBySprite=r.renderStateIsBySprite,i.nodeCommonMap=r.nodeCommonMap,i.value2DShaderData.addDefine(a.SPINE_GPU_INSTANCE)}let u=p.getVector3(t.ShaderDefines2D.UNIFORM_NMATRIX_0),f=p.getVector3(t.ShaderDefines2D.UNIFORM_NMATRIX_1),_=6*c;l[_]=u.x,l[_+1]=u.y,l[_+2]=u.z,l[_+3]=f.x,l[_+4]=f.y,l[_+5]=f.z;let g=p.getVector(a.SIMPLE_SIMPLEANIMATORPARAMS),x=4*c;d[x]=g.x,d[x+1]=g.y,d[x+2]=g.z,d[x+3]=g.w,c++,s.instanceCount=c,s.instanceCount==Q.MaxInstanceCount&&(this.updateBuffer(o,l,d,s.instanceCount),e.add(i),i=null)}i&&(this.updateBuffer(o,l,d,s.instanceCount),e.add(i)),Q._instanceBufferRecover(l),Q._instanceBufferRecover(d)}recover(){let e=this._recoverList.length,t=this._recoverList.elements;for(let n=0;n<e;n++){let e=t[n];Q.recover(e)}this._recoverList.length=0}}t.Laya.addAfterInitCallback(function(){$.instance=new $});class Q{static getInstanceInfo(e){let t=Q._instanceBufferInfoMap.get(e);return t||(t=[],Q._instanceBufferInfoMap.set(e,t)),t.pop()||Q.createInstanceInfo(e)}static createInstanceInfo(e){let n=t.LayaGL.render2DRenderPassFactory.createRenderElement2D(),r=n.geometry=t.LayaGL.renderDeviceFactory.createRenderGeometryElement(t.MeshTopology.Triangles,t.DrawType.DrawElementInstance),i=t.LayaGL.renderDeviceFactory.createBufferState(),s={state:i,element:n,source:e},o=e.bufferState._vertexBuffers.slice(),h=t.LayaGL.renderDeviceFactory.createVertexBuffer(t.BufferUsage.Dynamic);h.setDataLength(16*Q.MaxInstanceCount*4),h.vertexDeclaration=a.instanceNMatrixDeclaration,h.instanceBuffer=!0,o.push(h),s.nMatrixInstanceVB=h;let l=t.LayaGL.renderDeviceFactory.createVertexBuffer(t.BufferUsage.Dynamic);return l.setDataLength(4*Q.MaxInstanceCount*4),l.vertexDeclaration=a.instanceSimpleAnimatorDeclaration,l.instanceBuffer=!0,o.push(l),s.simpleAnimatorVB=l,i.applyState(o,e.bufferState._bindedIndexBuffer),r.drawParams.elements=e.drawParams.elements.slice(),r.drawParams.length=e.drawParams.length,r.indexFormat=e.indexFormat,r.bufferState=i,s}static recover(e){let t=e.element;t.value2DShaderData.removeDefine(a.SPINE_GPU_INSTANCE),t.value2DShaderData=null,t.materialShaderData=null,t.subShader=null,t.nodeCommonMap=null,Q._instanceBufferInfoMap.get(e.source).push(e)}static _instanceBufferCreate(e){let t=Q._bufferPool[e];return t||(t=Q._bufferPool[e]=[]),t.pop()||new Float32Array(e)}static _instanceBufferRecover(e){let t=e.length,n=Q._bufferPool[t];n||(n=Q._bufferPool[t]=[]),n.push(e)}}Q.MaxInstanceCount=2048,Q._instanceBufferInfoMap=new Map,Q._bufferPool=[],e.AnimationRender=D,e.AnimationRenderProxy=w,e.AttachmentParse=I,e.ChangeDeform=_,e.ChangeDrawOrder=g,e.ChangeRGBA=x,e.ChangeSlot=y,e.ExternalSkin=n,e.ExternalSkinItem=r,e.IBCreator=B,e.MultiRenderData=b,e.SketonOptimise=U,e.SkinAniRenderData=A,e.SkinAttach=z,e.SkinRenderUpdate=C,e.SlotUtils=E,e.Spine2DRenderNode=W,e.SpineAdapter=p,e.SpineBakeScript=Z,e.SpineEmptyRender=j,e.SpineInstanceBatch=$,e.SpineInstanceElement2DTool=Q,e.SpineMeshBase=s,e.SpineMeshUtils=i,e.SpineNormalRender=f,e.SpineNormalRenderBase=h,e.SpineOptimizeConst=v,e.SpineOptimizeRender=M,e.SpineShaderInit=a,e.SpineSkeleton=X,e.SpineSkeletonRenderer=d,e.SpineTemplet=H,e.SpineTexture=Y,e.SpineVirtualMesh=o,e.SpineWasmRender=m,e.SpineWasmVirturalMesh=c,e.VBBoneCreator=V,e.VBCreator=O,e.VBRigBodyCreator=F}(window.Laya=window.Laya||{},Laya);