!function(e,t){"use strict";class r{constructor(){this._num=0,this._updateRange=new t.Vector2(1e8,-1e8)}_modifyOneView(e){this._updateRange.y=Math.max(e.start+e.length,this._updateRange.y),this._updateRange.x=Math.min(e.start,this._updateRange.x)}addDataView(e){e._next=null,e._prev=null,this._first||(this._first=e,this._first.start=0),this._last&&(this._last._next=e,e._prev=this._last),e.owner=this,this._last=e,this._num++}removeDataView(e){e.owner=null,e._prev&&(e._prev._next=e._next),e._next&&(e._next._prev=e._prev),e==this._first&&(this._first=e._next),e==this._last&&(this._last=e._prev),e._next=null,e._prev=null,this._updateRange.x=Math.min(e.start,this._updateRange.x),this._updateRange.y=Math.max(e.start+e.length,this._updateRange.y),this._num--}destroy(){this._first=null,this._last=null,this._dataView=null,this.arrayBuffer=null}}class a extends r{resetData(e){this.arrayBuffer=new ArrayBuffer(e);let t=new Float32Array(this.arrayBuffer);this._dataView&&t.set(this._dataView),this._dataView=t,this._needResetData=!0}_upload(){if(this._needResetData){let e=this._first;for(;e;)e._updateView(this._dataView),e=e._next;this.buffer.setData(this.arrayBuffer,0,0,this.arrayBuffer.byteLength),this._needResetData=!1}else{if(this._updateRange.y<=this._updateRange.x)return;this.buffer.setData(this.arrayBuffer,4*this._updateRange.x,4*this._updateRange.x,4*(this._updateRange.y-this._updateRange.x))}this._updateRange.setValue(1e8,-1e8)}}class i extends r{resetData(e){this.arrayBuffer=new ArrayBuffer(e);let t=new Uint16Array(this.arrayBuffer);this._dataView&&t.set(this._dataView),this._dataView=t,this._needResetData=!0}_upload(){let e=this._first,t=0,r=0,a=e._geometry,i=!1,s=this._needResetData?0:this._updateRange.x;for(;e;)a!=e._geometry&&(i&&(a.clearRenderParams(),a.setDrawElemenParams(r,2*t)),a=e._geometry,t+=r,r=0),t+=r,i=this._needResetData||t>=s,i&&(e.start=t,e._updateView(this._dataView)),r+=e.length,e=e._next;i&&(a.clearRenderParams(),a.setDrawElemenParams(r,2*t));let n=this._last.start+this._last.length-s,_=2*s;_=4*Math.floor(_/4),this.buffer.setData(this.arrayBuffer,_,_,2*n+(2*s-_)),this._needResetData=!1}_modifyOneView(e){this.addDataView(e),e._prev?e.start=e._prev.start+e._prev.length:e.start=0,super._modifyOneView(e)}}class s extends i{clearBufferViews(){this._first=null,this._last=null,this._num=0,this._updateRange.setValue(1e8,-1e8)}_resetData(e){super.resetData(e)}}const n=new t.FastSinglelist;class _{constructor(){this.indexCount=0,this.maxIndexCount=0,this.bufferStates=new Map,this.geometryList=[],this.indexBuffer=t.LayaGL.renderDeviceFactory.createIndexBuffer(t.BufferUsage.Dynamic),this.indexBuffer.indexType=t.IndexFormat.UInt16,this.wholeBuffer=new s,this.wholeBuffer.buffer=this.indexBuffer}updateBufLength(){if(this.maxIndexCount<=this.indexCount){let e=Math.ceil(this.indexCount/_._STEP_)*_._STEP_,t=2*e;this.indexBuffer._setIndexDataLength(t),this.wholeBuffer._resetData(t),this.maxIndexCount=e}}bindBuffer(e){let r=this.bufferStates.get(e);return r||(r=t.LayaGL.renderDeviceFactory.createBufferState(),r.applyState([e],this.indexBuffer),this.bufferStates.set(e,r)),r}clear(){this.indexCount=0,this.wholeBuffer.clearBufferViews(),this.geometryList.length=0}destroy(){this.clear(),this.bufferStates.forEach(e=>{e.destroy()}),this.bufferStates.clear(),this.indexBuffer.destroy(),this.indexBuffer=null,this.wholeBuffer.destroy(),this.wholeBuffer=null}}_._STEP_=1024;class l{constructor(){this._batchBuffer=new _,this._list=new t.FastSinglelist}reset(){this._batchBuffer.clear();let e=this._list.elements,t=this._list.length,r=e.length;for(let a=0;a<r;a++){let r=e[a];r.geometry.clearRenderParams(),a>=t&&h._pool.recover(r)}this._list.clean(),this._list.length=0}getRenderElement(){let e=this._list.elements.length,t=this._list.length,r=null;return e>t?(r=this._list.elements[t],this._list.length++,r):(r=h._pool.take(),this._list.add(r),r)}destroy(){let e=this._list.elements,t=e.length;for(let r=0;r<t;r++){let t=e[r];h._pool.recover(t)}this._list.destroy(),this._batchBuffer.destroy()}}class h{createBatchContext(){return new l}batchRenderElement(e,t,r,a){let i=e.elements,s=-1,n=0,_=r-1,l=h.batchCtx;l.reset();for(let r=0;r<=_;r++){let _=i[t+r];this.canAddToBatch(_,l)?-1==s?(s=r,n=1,l.initFromElement(_)):n++:(n>1?this.batch(e,s+t,n,a,l):1===n&&e.add(i[s+t]),l.reset(),s=-1,n=0,this.canAddToBatch(_,l)?(s=r,n=1,l.initFromElement(_)):e.add(_))}n>1?this.batch(e,s+t,n,a,l):1===n&&e.add(i[s+t])}canAddToBatch(e,t){if(null===t.subShader){return!(32&e.type)}return t.isCompatible(e)}batch(e,t,r,a,i){let s=e.elements,_=a.getRenderElement(),l=[],h=0,o=[],d=a._batchBuffer;for(h=0;h<r;h++){let e=t+h,r=s[e],a=d.geometryList[e]||r.geometry;h||(_.geometry.bufferState=a.bufferState,_.materialShaderData=r.materialShaderData,_.value2DShaderData=r.value2DShaderData,_.subShader=r.subShader,_.renderStateIsBySprite=r.renderStateIsBySprite,_.primitiveShaderData=i.shaderData,_.owner=r.owner),a.getDrawDataParams(n),l.push(n.elements.slice()),o.push(n.length)}let u=_.geometry,c=l.length,f=0,m=0,p=!0;for(h=0;h<c;h++){let e=l[h],t=o[h];for(let r=0;r<t;r+=2){let t=e[r],a=e[r+1];p?(f=t,m=a,p=!1):f+2*m===t?m+=a:(u.setDrawElemenParams(m,f),f=t,m=a)}}p||u.setDrawElemenParams(m,f),e.add(_)}prepare(e,t,r){let a=e.renderDataHandler,i=a._getBlocks();if(!i)return;let s=t._batchBuffer,n=a.getCloneViews();for(let e=0,t=i.length;e<t;e++){let t=n[e],a=i[e].vertexBuffer,_=s.bindBuffer(a);s.indexCount+=t.length,s.wholeBuffer._modifyOneView(t),t._geometry.bufferState!==_&&(t._geometry.bufferState=_),s.geometryList[r+e]=t._geometry}c.setBuffer(s.wholeBuffer),s.updateBufLength()}recover(e){let t=e.length,r=e.elements;for(let e=0;e<t;e++){let t=r[e];h._pool.recover(t)}e.length=0}}h.instance=null,h.batchCtx=new class{constructor(){this.textureId=0,this.globalAlpha=1,this.clipInfo=null,this.subShader=null,this.bufferState=null,this.shaderData=null,this.type=0,this.lowType=0,this.globalRenderData=null}reset(){this.textureId=0,this.globalAlpha=1,this.clipInfo=null,this.subShader=null,this.bufferState=null,this.shaderData=null,this.type=0,this.lowType=0,this.globalRenderData=null}initFromElement(e){this.textureId=-64&e.type,this.shaderData=e.primitiveShaderData,this.globalAlpha=e.owner.globalAlpha,this.clipInfo=e.owner.getClipInfo(),this.subShader=e.subShader,this.bufferState=e.geometry.bufferState,this.type=e.type,this.lowType=63&e.type,this.globalRenderData=e.owner.globalRenderData}isCompatible(e){let t=e.type;if(32&t)return!1;let r=63&t,a=-64&t,i=e.owner;return this.lowType===r&&(this.globalAlpha===i.globalAlpha&&(this.subShader===e.subShader&&this.bufferState===e.geometry.bufferState&&this.clipInfo===i.getClipInfo()&&i.globalRenderData===this.globalRenderData&&(0===this.textureId?(0!==a&&(this.textureId=a,this.shaderData=e.primitiveShaderData),!0):0===a||a===this.textureId)))}},h._pool=t.Pool.createPool2(()=>{let e=t.LayaGL.render2DRenderPassFactory.createPrimitiveRenderElement2D();return e.geometry=t.LayaGL.renderDeviceFactory.createRenderGeometryElement(t.MeshTopology.Triangles,t.DrawType.DrawElement),e.geometry.indexFormat=t.IndexFormat.UInt16,e.nodeCommonMap=["Sprite2D"],e.renderStateIsBySprite=!1,e},null,e=>{e.geometry.clearRenderParams(),e.geometry.bufferState=null,e.materialShaderData=null,e.value2DShaderData=null,e.primitiveShaderData=null,e.subShader=null,e.owner=null,e.renderStateIsBySprite=!1,e.globalShaderData=null});class o{constructor(){this.batchFun=null,this.batchContext=null,this.batch=!1,this.indexStart=-1,this.elementLength=0,this.elementCount=0}}o._pool=t.Pool.createPool(o);class d{static registerBatch(e,t){if(d._batchMapManager[e])throw new Error("Overlapping batch optimization");d._batchMapManager[e]=t}}d._batchMapManager={};const u=new t.Matrix;class c{get priority(){return this._priority}set priority(e){this._priority=e,this._mask&&this._mask.pass&&(this._mask.pass._priority=e+1)}get mask(){return this._mask}set mask(e){this._mask=e,e&&e.pass&&(e.pass.priority=this.priority+1)}get enableBatch(){return this._enableBatch}set enableBatch(e){this.repaint=!0,this._enableBatch=e}setClearColor(e,t,r,a){this._clearColor.setValue(e,t,r,a)}constructor(){this._list=new f,this._priority=0,this.enable=!0,this.isSupport=!1,this.postProcess=null,this.repaint=!0,this._clearColor=new t.Color,this.doClearColor=!0,this.finalize=null,this._enableBatch=!0,this._rtsize=new t.Vector2,this.root=null,this.offsetMatrix=new t.Matrix,this._invertMat_0=new t.Vector3(1,1),this._invertMat_1=new t.Vector3(0,0),this.shaderData=null,this.destroyed=!1,this.shaderData=t.LayaGL.renderDeviceFactory.createShaderData(null)}needRender(){return this.enable&&!this.isSupport&&(this.repaint||!this.renderTexture)}addStruct(e){this._list.add(e,this._enableBatch)}removeStruct(e){this._list.remove(e)}cullAndSort(e,t){if(t&&t.enabled&&(t._handleInterData(),!t._parentGlobalRenderData||0!==(t.renderLayer&t._parentGlobalRenderData.renderLayerMask))){t.renderUpdate(e),this.addStruct(t);for(let r=0;r<t.children.length;r++){const a=t.children[r];this.cullAndSort(e,a)}}}updateRenderQueue(e){let t=this.root;t&&this.cullAndSort(e,t)}fowardRender(e){this._initRenderProcess(e),this.render(e)}render(e){this.repaint?(this._list.reset(),this.updateRenderQueue(e),this._list.updateRenderElements(this._enableBatch),c.uploadBuffer(),this._enableBatch&&this._list.batch(),e.drawRenderElementList(this._list.renderElements),this._mask&&(this._mask._handleInterData(),this._mask.renderUpdate(e),e.drawRenderElementOne(this._mask.renderElements[0])),this.postProcess&&this.postProcess.enabled&&this.postProcess._context.command.apply(!0)):(this._list.structs.forEach(t=>{for(let r=0,a=t.length;r<a;r++){let a=t.elements[r];a&&(a._handleInterData(),a.renderUpdate(e))}}),c.uploadBuffer(),e.drawRenderElementList(this._list.renderElements)),this.repaint=!1}_initRenderProcess(e){let r,a,i=this.renderTexture;i?(e.invertY=i._invertY,e.setRenderTarget(i._renderTarget,this.doClearColor,this._clearColor),r=i.width,a=i.height,this._updateInvertMatrix(),this.shaderData.addDefine(t.ShaderDefines2D.RENDERTEXTURE)):(e.invertY=!1,r=t.RenderState2D.width,a=t.RenderState2D.height,e.setOffscreenView(r,a),e.setRenderTarget(null,this.doClearColor,this._clearColor),this._setInvertMatrix(1,0,0,1,0,0),this.shaderData.removeDefine(t.ShaderDefines2D.RENDERTEXTURE)),e.passData=this.shaderData,this._setRenderSize(r,a)}static setBuffer(e){e._inPass||(e._inPass=!0,this.buffers.add(e))}static uploadBuffer(){c.buffers.size>0&&(c.buffers.forEach(e=>{e._upload(),e._inPass=!1}),c.buffers.clear())}_updateInvertMatrix(){let e=this.root.trans;if(!e)return this._setInvertMatrix(1,0,0,1,0,0);let r=u,a=this.mask,i=this.offsetMatrix;if(a&&a.trans){a.trans.matrix.copyTo(r)}else e.matrix.copyTo(r);t.Matrix.mul(i,r,r),r.invert(),this._setInvertMatrix(r.a,r.b,r.c,r.d,r.tx,r.ty)}_setInvertMatrix(e=1,r=0,a=0,i=1,s=0,n=0){e===this._invertMat_0.x&&r===this._invertMat_1.x&&a===this._invertMat_0.y&&i===this._invertMat_1.y&&s===this._invertMat_0.z&&n===this._invertMat_1.z||(this._invertMat_0.setValue(e,a,s),this._invertMat_1.setValue(r,i,n),this.shaderData.setVector3(t.ShaderDefines2D.UNIFORM_INVERTMAT_0,this._invertMat_0),this.shaderData.setVector3(t.ShaderDefines2D.UNIFORM_INVERTMAT_1,this._invertMat_1))}_setRenderSize(e,r){e===this._rtsize.x&&r===this._rtsize.y||(this._rtsize.setValue(e,r),this.shaderData.setVector2(t.ShaderDefines2D.UNIFORM_SIZE,this._rtsize))}destroy(){this.destroyed||(this.destroyed=!0,this._list.destroy(),this._list=null,this.root=null,this.renderTexture=null,this.postProcess=null,this.shaderData.destroy(),this.shaderData=null)}}c.buffers=new Set;class f{constructor(){this._batchInfoList=new t.FastSinglelist,this._currentType=-1,this._currentBatch=null,this.structs=[],this.renderElements=null,this.renderListType=-1,this.zOrder=0,this._dirtyFlag=0,this._batchContexts=[],this.renderElements=new t.FastSinglelist}add(e,r=!0){let a=e.zIndex;this.structs[a]||(this.structs[a]=new t.FastSinglelist),this.structs[a].add(e)}updateRenderElements(e){this.structs.forEach(t=>{for(let r=0,a=t.length;r<a;r++){let a=t.elements[r];this._updateRenderElements(a,e)}})}_updateRenderElements(e,t){let r=e.renderElements?e.renderElements.length:0;if(0!=r){if(1==r)t?(this._batchStart(e.renderType,1),this.renderElements.add(e.renderElements[0])):this.renderElements.add(e.renderElements[0]);else if(t){this._batchStart(e.renderType,r);for(var a=0;a<r;a++)this.renderElements.add(e.renderElements[a])}else for(a=0;a<r;a++)this.renderElements.add(e.renderElements[a]);if(t&&this._currentBatch.batchFun){let t=this._currentBatch.indexStart+this._currentBatch.elementLength-r;this._currentBatch.batchFun.prepare(e,this._currentBatch.batchContext,t)}}}_batchStart(e,t){if(this._currentBatch&&this._currentType==e)return this._currentBatch.batch=!!this._currentBatch.batchFun,void(this._currentBatch.elementLength+=t);if(this._currentBatch&&this._batchInfoList.add(this._currentBatch),this._currentBatch=o._pool.take(),this._currentBatch.batch=!1,this._currentBatch.batchFun=d._batchMapManager[e],this._currentBatch.batchFun){let t=this._batchContexts[e];t||(t=this._currentBatch.batchFun.createBatchContext(),this._batchContexts[e]=t),this._currentBatch.batchContext=t}this._currentBatch.indexStart=this.renderElements.length,this._currentBatch.elementLength=t,this._currentType=e}batch(){this._currentBatch&&this._batchInfoList.add(this._currentBatch),this.renderElements.length=0;for(var e=0,t=this._batchInfoList.length;e<t;e++){let t=this._batchInfoList.elements[e];if(t.batch)t.batchFun.batchRenderElement(this.renderElements,t.indexStart,t.elementLength,t.batchContext);else for(let e=t.indexStart,r=t.elementLength+t.indexStart;e<r;e++)this.renderElements.add(this.renderElements.elements[e])}}remove(e){let t=e.zIndex;this.structs[t]&&this.structs[t].remove(e)}destroy(){this.structs.length=0,this.clearRenderElements();for(let e=0,t=this._batchContexts.length;e<t;e++)this._batchContexts[e]&&this._batchContexts[e].destroy();this._batchContexts.length=0}clearRenderElements(){this.renderElements.clear(),this._batchInfoList.clear()}reset(){this.structs.forEach(e=>{e.length=0}),this.renderElements.length=0;for(let e=0,t=this._batchContexts.length;e<t;e++)this._batchContexts[e]&&this._batchContexts[e].reset();this._batchInfoList.length=0,this._currentBatch=null,this._currentType=-1}}class m{constructor(){this._modify=!1,this._passes=[]}removePass(e){let t=this._passes.indexOf(e);-1!==t&&(this._passes.splice(t,1),this._modify=!0)}apply(e){this._modify&&(this._modify=!1,this._sortPassesByPriority());for(const t of this._passes)t.needRender()&&t.fowardRender(e)}clear(){this._passes.length=0}addPass(e){-1===this._passes.indexOf(e)&&(this._passes.push(e),this._modify=!0)}_sortPassesByPriority(){this._passes.sort((e,t)=>t._priority-e._priority)}}h.instance=new h,d.registerBatch(t.BaseRender2DType.graphics,h.instance);class p{}class g extends p{_getData(){return this._view}_modify(){this.owner._modifyOneView(this),c.setBuffer(this.owner)}_updateView(e){this._view&&this._view.buffer===e.buffer||(this._view=new Float32Array(e.buffer,4*this.start,this.length))}setData(e){this._view.set(e),this._modify()}constructor(e,t,r,a=1){super(),this.stride=1,this.owner=e,this.start=t,this.length=r,this.stride=a,this._updateView(e._dataView),e.addDataView(this)}}class E extends p{setGeometry(e){this._geometry=e}setData(e){this._view.set(e),this._modify()}constructor(e,t,r=!0){super(),this.owner=e,this.length=t,r&&(this._view=new Uint16Array(t))}_updateView(e){e.set(this._view,this.start)}_modify(){this.owner._modifyOneView(this),c.setBuffer(this.owner)}_clone(e=!0,t=!0){let r=e?this.owner:null,a=new E(r,this.length,t);return t||this._cloneView(a),a}_cloneView(e){e._view=this._view,e.length=this.length}destroy(){this._view=null,this._geometry=null,this.owner=null,this._next=null,this._prev=null}}class T{get owner(){return this._owner}set owner(e){this._owner=e}constructor(){this._nMatrix_0=new t.Vector3,this._nMatrix_1=new t.Vector3,this._needUseMatrix=!0}get needUseMatrix(){return this._needUseMatrix}set needUseMatrix(e){this._needUseMatrix=e,e||(this._nMatrix_0.set(1,0,0),this._nMatrix_1.set(0,1,0),this._owner.spriteShaderData.setVector3(t.ShaderDefines2D.UNIFORM_NMATRIX_0,this._nMatrix_0),this._owner.spriteShaderData.setVector3(t.ShaderDefines2D.UNIFORM_NMATRIX_1,this._nMatrix_1))}destroy(){}inheriteRenderData(e){if(this._owner.spriteShaderData&&this._needUseMatrix){let e=this._owner.renderMatrix;this._nMatrix_0.setValue(e.a,e.c,e.tx),this._nMatrix_1.setValue(e.b,e.d,e.ty),this._owner.spriteShaderData.setVector3(t.ShaderDefines2D.UNIFORM_NMATRIX_0,this._nMatrix_0),this._owner.spriteShaderData.setVector3(t.ShaderDefines2D.UNIFORM_NMATRIX_1,this._nMatrix_1)}}}class S{}class R{}class x extends T{constructor(){super(...arguments),this.mask=null,this._bufferBlocks=null,this._needUpdateBuffer=!1,this._modifiedFrame=-1}applyVertexBufferBlock(e){this._bufferBlocks=e,this._needUpdateBuffer=e.length>0,this.updateCloneView()}_getBlocks(){return this._bufferBlocks}inheriteRenderData(e){if(!this._owner.spriteShaderData)return;let r=this._owner.trans;if(this._needUpdateBuffer||this._modifiedFrame<r.modifiedFrame){let e=r.matrix;if(this._bufferBlocks&&this._bufferBlocks.length){let t=0,r=0,a=0,i=null,s=e.a,n=e.b,_=e.c,l=e.d,h=e.tx,o=e.ty,d=null,u=this._bufferBlocks,c=0,f=null,m=null,p=this._bufferBlocks[0].vertexBuffer.vertexDeclaration.vertexStride/4;for(let e=0,g=this._bufferBlocks.length;e<g;e++){let g=u[e].vertexs;for(let e=0,u=g.length;e<u;e++){f=g[e].positions,m=g[e].vertexViews,c=f.length/2,i=null,t=0,a=0,r=0;for(let e=0;e<c;e++){(!i||i.length<=t)&&(i=m[r],i._modify(),r++,t=0,d=i._getData());let e=f[a],u=f[a+1];d[t]=e*s+u*_+h,d[t+1]=e*n+u*l+o,t+=p,a+=2}}}this._needUpdateBuffer=!1}else{if(this.mask&&this.mask.trans){let e=this.mask.renderMatrix;this._nMatrix_0.setValue(e.a,e.c,e.tx),this._nMatrix_1.setValue(e.b,e.d,e.ty)}else this._nMatrix_0.setValue(e.a,e.c,e.tx),this._nMatrix_1.setValue(e.b,e.d,e.ty);this._owner.spriteShaderData.setVector3(t.ShaderDefines2D.UNIFORM_NMATRIX_0,this._nMatrix_0),this._owner.spriteShaderData.setVector3(t.ShaderDefines2D.UNIFORM_NMATRIX_1,this._nMatrix_1)}this._modifiedFrame=r.modifiedFrame}}getCloneViews(){if(!this._clonesViews){this._clonesViews=[];for(let e=0,t=this._bufferBlocks.length;e<t;e++)this._clonesViews[e]=this._cloneView(this._bufferBlocks[e].indexView)}return this._clonesViews}updateCloneView(){let e=this.getCloneViews(),t=this._bufferBlocks.length,r=e.length;if(r>t)for(let a=t;a<r;a++){let t=e[a];t._geometry.destroy(),t.owner&&t.owner.removeDataView(t)}this._clonesViews.length=t;for(let r=0;r<t;r++){let t=e[r],a=this._bufferBlocks[r];a&&(e[r]=this._cloneView(a.indexView,t))}}_cloneView(e,r=null){let a;return r&&r._geometry?(a=r,e._cloneView(a)):(a=e._clone(!1,!1),a._geometry=t.LayaGL.renderDeviceFactory.createRenderGeometryElement(t.MeshTopology.Triangles,t.DrawType.DrawElement),a._geometry.indexFormat=t.IndexFormat.UInt16),a}destroy(){if(super.destroy(),this._clonesViews){for(let e=0,t=this._clonesViews.length;e<t;e++)this._clonesViews[e]._geometry.destroy();this._clonesViews=null}this._bufferBlocks=null}}class D extends T{constructor(){super(...arguments),this._lightReceive=!1}get lightReceive(){return this._lightReceive}set lightReceive(e){this._lightReceive=e,e?this._owner.spriteShaderData.addDefine(t.BaseRenderNode2D.SHADERDEFINE_LIGHT2D_ENABLE):this._owner.spriteShaderData.removeDefine(t.BaseRenderNode2D.SHADERDEFINE_LIGHT2D_ENABLE)}get owner(){return this._owner}set owner(e){e!=this.owner&&(this._owner&&this._owner.spriteShaderData.removeDefine(t.BaseRenderNode2D.SHADERDEFINE_BASERENDER2D),this._owner=e,this._owner&&this._owner.spriteShaderData.addDefine(t.BaseRenderNode2D.SHADERDEFINE_BASERENDER2D))}}class b extends D{constructor(){super(...arguments),this._baseColor=new t.Color(1,1,1,1),this._renderAlpha=-1}get baseColor(){return this._baseColor}set baseColor(e){e!=this._baseColor&&this._baseColor.equal(e)||((e=e||t.Color.BLACK).cloneTo(this._baseColor),this._renderAlpha=-1,this._owner.spriteShaderData.setColor(t.BaseRenderNode2D.BASERENDER2DCOLOR,this._baseColor))}get baseTexture(){return this._baseTexture}set baseTexture(e){null!=this._baseTexture&&e==this._baseTexture||(this._baseTexture&&this._baseTexture._removeReference(),this._baseTexture=e,e=e||t.Texture2D.whiteTexture,this._owner.spriteShaderData.setTexture(t.BaseRenderNode2D.BASERENDER2DTEXTURE,e),e&&(e._addReference(),1!=e.gammaCorrection?this._owner.spriteShaderData.addDefine(t.ShaderDefines2D.GAMMATEXTURE):this._owner.spriteShaderData.removeDefine(t.ShaderDefines2D.GAMMATEXTURE)))}get normal2DTexture(){return this._normal2DTexture}set normal2DTexture(e){e!==this._normal2DTexture&&(this._normal2DTexture&&this._normal2DTexture._removeReference(1),e&&e._addReference(),this._normal2DTexture=e,this._owner.spriteShaderData.setTexture(t.BaseRenderNode2D.NORMAL2DTEXTURE,e),this._normal2DStrength>0&&this._normal2DTexture?this._owner.spriteShaderData.addDefine(t.BaseRenderNode2D.SHADERDEFINE_LIGHT2D_NORMAL_PARAM):this._owner.spriteShaderData.removeDefine(t.BaseRenderNode2D.SHADERDEFINE_LIGHT2D_NORMAL_PARAM))}get normal2DStrength(){return this._normal2DStrength}set normal2DStrength(e){e=Math.max(0,Math.min(1,e)),this._normal2DStrength!==e&&(this._normal2DStrength=e,this._owner.spriteShaderData.setNumber(t.BaseRenderNode2D.NORMAL2DSTRENGTH,e),e>0&&this._normal2DTexture?this._owner.spriteShaderData.addDefine(t.BaseRenderNode2D.SHADERDEFINE_LIGHT2D_NORMAL_PARAM):this._owner.spriteShaderData.removeDefine(t.BaseRenderNode2D.SHADERDEFINE_LIGHT2D_NORMAL_PARAM))}inheriteRenderData(e){if(super.inheriteRenderData(e),this._renderAlpha!=this._owner.globalAlpha){let e=this._owner.globalAlpha*this._baseColor.a;b._setRenderColor.setValue(this._baseColor.r*e,this._baseColor.g*e,this._baseColor.b*e,e),this._owner.spriteShaderData.setColor(t.BaseRenderNode2D.BASERENDER2DCOLOR,b._setRenderColor),this._renderAlpha=this._owner.globalAlpha}}}b._setRenderColor=new t.Color(1,1,1,1);class B extends D{get owner(){return this._owner}set owner(e){if(e!=this.owner){if(this._owner){let e=this._owner.spriteShaderData;e.removeDefine(t.BaseRenderNode2D.SHADERDEFINE_BASERENDER2D),e.removeDefine(t.SpineShaderInit.SPINE_UV),e.removeDefine(t.SpineShaderInit.SPINE_COLOR)}if(this._owner=e,this._owner){let e=this._owner.spriteShaderData;e.addDefine(t.BaseRenderNode2D.SHADERDEFINE_BASERENDER2D),e.addDefine(t.SpineShaderInit.SPINE_UV),e.addDefine(t.SpineShaderInit.SPINE_COLOR)}}}get offset(){return this._offset}set offset(e){this._offset=e}inheriteRenderData(e){if(!this._owner||!this._owner.spriteShaderData||!this.skeleton)return;let r=this.owner.spriteShaderData,a=this.owner.renderMatrix;if(this._offset){let e=this._offset.x,t=this._offset.y;this._nMatrix_0.setValue(a.a,a.b,a.tx+a.a*e+a.c*t),this._nMatrix_1.setValue(a.c,a.d,a.ty+a.b*e+a.d*t)}else this._nMatrix_0.setValue(a.a,a.b,a.tx),this._nMatrix_1.setValue(a.c,a.d,a.ty);r.setVector3(t.ShaderDefines2D.UNIFORM_NMATRIX_0,this._nMatrix_0),r.setVector3(t.ShaderDefines2D.UNIFORM_NMATRIX_1,this._nMatrix_1)}}const A={clipMatrix:new t.Matrix,clipMatDir:new t.Vector4(t.Const.MAX_CLIP_SIZE,0,0,t.Const.MAX_CLIP_SIZE),clipMatPos:new t.Vector4(0,0,0,0),_updateFrame:0};class P{}var C,M,F;!function(e){e[e.All=-1]="All",e[e.Clip=1]="Clip",e[e.Blend=2]="Blend",e[e.Alpha=4]="Alpha",e[e.Pass=8]="Pass",e[e.Global=16]="Global"}(C||(C={}));class y{get renderMatrix(){return this.trans.matrix}set renderMatrix(e){this.trans?(this.trans.matrix=e,this.trans.modifiedFrame=t.Stat.loopCount):this.trans={matrix:e,modifiedFrame:t.Stat.loopCount}}get alpha(){return this._alpha}set alpha(e){this._alpha=e,this.parent?this.globalAlpha=this.parent.globalAlpha*e:this.globalAlpha=e,this.updateChildren(C.Alpha)}get blendMode(){return this._blendMode||this._parentBlendMode||t.BlendMode.normal}set blendMode(e){this._blendMode=e,this._updateBlendMode(),this.updateChildren(C.Blend)}get renderDataHandler(){return this._renderDataHandler}set renderDataHandler(e){this._renderDataHandler=e,e&&(this._renderDataHandler.owner=this)}get globalRenderData(){return this._globalRenderData||this._parentGlobalRenderData}set globalRenderData(e){this._globalShaderData=e?e.globalShaderData:null,this._globalRenderData=e,this.updateChildren(C.Global)}get pass(){return this._pass||this._parentPass}set pass(e){e!==this._pass&&(this._pass=e,this._parentPass&&(e.priority=this._parentPass.priority+1),this.updateChildren(C.Pass))}constructor(){this.zIndex=0,this.rect=new t.Rectangle(0,0,0,0),this.renderLayer=1,this.children=[],this.renderType=-1,this.renderUpdateMask=0,this.globalAlpha=1,this._alpha=1,this._blendMode=t.BlendMode.invalid,this._parentBlendMode=t.BlendMode.invalid,this._destroyed=!1,this.needUploadClip=-1,this.needUploadAlpha=!0,this.enabled=!0,this.isRenderStruct=!1,this.renderElements=null,this.spriteShaderData=null,this._globalShaderData=null,this._globalRenderData=null,this._parentGlobalRenderData=null,this._clipRect=null,this._parentClipInfo=null,this._clipInfo=null,this._rnUpdateCall=null,this._rnUpdateFun=null}set_renderNodeUpdateCall(e,t){this._rnUpdateCall=e,this._rnUpdateFun=t}_handleInterData(){let e=this._clipRect;if(e){let t=this._clipInfo,r=this.trans,a=this._parentClipInfo&&this._parentClipInfo!==A?this._parentClipInfo._updateFrame:-1;if(r&&(t._updateFrame<r.modifiedFrame||t._updateFrame<a)){let i=r.matrix,s=t.clipMatrix,{x:n,y:_,width:l,height:h}=e,o=i.tx,d=i.ty;if(s.tx=n*i.a+_*i.c+o,s.ty=n*i.b+_*i.d+d,s.a=l*i.a,s.b=l*i.b,s.c=h*i.c,s.d=h*i.d,-1!==a){let e=this._parentClipInfo.clipMatPos,t=e.z-e.x,r=e.w-e.y;if(s.a>0&&s.d>0){let e=this._parentClipInfo.clipMatrix,t=e.tx,r=e.ty,a=t+e.a,i=r+e.d,n=o+s.a,_=d+s.d;n<=t||_<=r||o>=a||d>=i?(s.a=-.1,s.d=-.1):(o<t&&(s.a-=t-o,o=s.tx=t),n>a&&(s.a-=n-a),d<r&&(s.d-=r-d,d=s.ty=r),_>i&&(s.d-=_-i),s.a<=0&&(s.a=-.1),s.d<=0&&(s.d=-.1))}o+=t,d+=r}t.clipMatDir.setValue(s.a,s.b,s.c,s.d),t.clipMatPos.setValue(s.tx,s.ty,o,d),t._updateFrame=Math.max(r.modifiedFrame,a)}}if(this._renderDataHandler){let e=this.spriteShaderData,r=this.getClipInfo();this.needUploadClip<r._updateFrame&&(e.setVector(t.ShaderDefines2D.UNIFORM_CLIPMATDIR,r.clipMatDir),e.setVector(t.ShaderDefines2D.UNIFORM_CLIPMATPOS,r.clipMatPos),this.needUploadClip=r._updateFrame),this.needUploadAlpha&&(e.setNumber(t.ShaderDefines2D.UNIFORM_VERTALPHA,this.globalAlpha),this.needUploadAlpha=!1)}}_updateBlendMode(){this.spriteShaderData&&t.BlendModeHandler.setShaderData(this.blendMode,this.spriteShaderData)}setClipRect(e){this._clipRect=e,e?this._initClipInfo():this._clipInfo=null,this.updateChildren(C.Clip)}_initClipInfo(){this._clipInfo?this._clipInfo._updateFrame=-1:this._clipInfo={clipMatDir:new t.Vector4,clipMatPos:new t.Vector4,clipMatrix:new t.Matrix,_updateFrame:-1}}getClipInfo(){return this._clipInfo||this._parentClipInfo||A}updateChildren(e){let r,a,i,s=0,n=null,_=null,l=null,h=!1,o=!1,d=!1,u=!1,c=!1;e&C.Clip&&(r=this.getClipInfo(),this.needUploadClip=-1,o=!0),e&C.Blend&&(a=this.blendMode,h=!0),e&C.Alpha&&(i=this.globalAlpha,this.needUploadAlpha=!0,d=!0),e&C.Pass&&(n=this.pass,s=n?n.priority+1:0,u=!0),e&C.Global&&(c=!0,_=this._globalShaderData,l=this._globalRenderData);for(const f of this.children){let m=!1;o&&(f._parentClipInfo=r,f._clipInfo||(m=!0)),h&&f._blendMode===t.BlendMode.invalid&&(f._parentBlendMode=a,f._updateBlendMode(),m=!0),d&&(f.globalAlpha=i*f.alpha,m=!0),u&&(f._parentPass=n,f._pass&&f._pass!==n&&(f._pass.priority=s),m=!0),c&&(f._globalRenderData||(m=!0,f._globalShaderData=_),f._parentGlobalRenderData=l),m&&f.updateChildren(e)}}setRepaint(){this.pass&&(this.pass.repaint=!0)}addChild(e,t){e.parent=this,this.children.splice(t,0,e),e._parentClipInfo=this.getClipInfo(),e._parentBlendMode=this.blendMode;let r=this.pass;e._parentPass=r,e._pass&&r&&(e._pass.priority=r.priority+1),e._parentGlobalRenderData=this.globalRenderData,e._globalRenderData||(e._globalShaderData=this._globalShaderData),e.updateChildren(C.All)}updateChildIndex(e,t,r){t!==r&&(this.children.splice(t,1),r>=this.children.length?this.children.push(e):this.children.splice(r,0,e))}removeChild(e){const r=this.children.indexOf(e);-1!==r&&(e.parent=null,this.children.splice(r,1),e._parentPass=null,e._pass&&(e._pass.priority=0),e._parentClipInfo=null,e._parentBlendMode=t.BlendMode.invalid,e.globalAlpha=e._alpha,e._parentGlobalRenderData=null,e._globalRenderData||(e._globalShaderData=null),e.updateChildren(C.All))}renderUpdate(e){this.renderDataHandler&&this.renderDataHandler.inheriteRenderData(e),this._rnUpdateFun&&this._rnUpdateFun.call(this._rnUpdateCall,e)}destroy(){this._destroyed=!0,this._clipInfo=null,this._parentClipInfo=null,this._clipRect=null,this.renderElements.length=0,this.renderElements=null,this.spriteShaderData=null,this.parent=null,this.children.length=0,this.children=null,this.pass=null}}class L{constructor(){this._changeFlags=new Set,this._mask=[],this._length=0}_intersectionDefineDatas(e){for(var t=e._mask,r=this._mask,a=this._length-1;a>=0;a--){var i=r[a]&t[a];0===i&&a===this._length-1?this._length--:r[a]=i}}add(e){let t=!1;var r=e._index,a=r+1,i=this._mask,s=this._length;if(s<a){for(i.length<a&&(i.length=a);s<r;s++)i[s]=0;i[r]=e._value,this._length=a,t=!0}else{let a=i[r];i[r]|=e._value,t=a!=i[r]}return t&&this._notifyChangeFlag(),t}remove(e){var t=e._index,r=this._mask,a=this._length-1;if(t>a)return!1;let i=r[t];var s=r[t]&~e._value;t==a&&0===s?this._length--:r[t]=s;let n=i!=s;return n&&this._notifyChangeFlag(),n}addDefineDatas(e){var t=e._mask,r=e._length,a=this._mask,i=this._length;if(i<r){a.length=r;for(var s=0;s<i;s++)a[s]|=t[s];for(;s<r;s++)a[s]=t[s];this._length=r}else for(s=0;s<r;s++)a[s]|=t[s];this._notifyChangeFlag()}removeDefineDatas(e){for(var t=e._mask,r=this._mask,a=this._length-1,i=Math.min(e._length,a);i>=0;i--){var s=r[i]&~t[i];i==a&&0===s?(a--,this._length--):r[i]=s}this._notifyChangeFlag()}has(e){var t=e._index;return!(t>=this._length)&&0!==(this._mask[t]&e._value)}_notifyChangeFlag(){if(this._changeFlags.size>0)for(var e=0,r=this._changeFlags.size;e<r;e++)this._changeFlags.forEach(e=>{e.setValue(t.Stat.loopCount,t.LayaGL.renderEngine._framePassCount)})}addChangeFlagInfo(e){this._changeFlags.has(e)||(e.setValue(t.Stat.loopCount,t.LayaGL.renderEngine._framePassCount),this._changeFlags.add(e))}removeChangeFlagInfo(e){this._changeFlags.has(e)&&(e.setValue(t.Stat.loopCount,t.LayaGL.renderEngine._framePassCount),this._changeFlags.delete(e))}clear(){this._length=0,this._notifyChangeFlag()}cloneTo(e){var t=e._mask,r=this._mask,a=this._length;t.length=a;for(var i=0;i<a;i++)t[i]=r[i];e._length=a,e._notifyChangeFlag()}clone(){var e=new L;return this.cloneTo(e),e}destroy(){delete this._mask}isEual(e){var t=this._length;if(t!=e._length)return!1;let r=this._mask,a=e._mask;for(var i=0;i<t;i++)if(r[i]!=a[i])return!1;return!0}}e.WebGLExtension=void 0,(M=e.WebGLExtension||(e.WebGLExtension={}))[M.OES_vertex_array_object=0]="OES_vertex_array_object",M[M.ANGLE_instanced_arrays=1]="ANGLE_instanced_arrays",M[M.OES_texture_half_float=2]="OES_texture_half_float",M[M.OES_texture_half_float_linear=3]="OES_texture_half_float_linear",M[M.OES_texture_float=4]="OES_texture_float",M[M.OES_element_index_uint=5]="OES_element_index_uint",M[M.OES_texture_float_linear=6]="OES_texture_float_linear",M[M.EXT_color_buffer_half_float=7]="EXT_color_buffer_half_float",M[M.EXT_shader_texture_lod=8]="EXT_shader_texture_lod",M[M.WEBGL_depth_texture=9]="WEBGL_depth_texture",M[M.EXT_sRGB=10]="EXT_sRGB",M[M.EXT_color_buffer_float=11]="EXT_color_buffer_float",M[M.EXT_texture_filter_anisotropic=12]="EXT_texture_filter_anisotropic",M[M.WEBGL_compressed_texture_s3tc=13]="WEBGL_compressed_texture_s3tc",M[M.WEBGL_compressed_texture_s3tc_srgb=14]="WEBGL_compressed_texture_s3tc_srgb",M[M.WEBGL_compressed_texture_pvrtc=15]="WEBGL_compressed_texture_pvrtc",M[M.WEBGL_compressed_texture_etc1=16]="WEBGL_compressed_texture_etc1",M[M.WEBGL_compressed_texture_etc=17]="WEBGL_compressed_texture_etc",M[M.WEBGL_compressed_texture_astc=18]="WEBGL_compressed_texture_astc",M[M.OES_standard_derivatives=19]="OES_standard_derivatives";class G{constructor(e){this._destroyed=!1,this._engine=e,this._gl=this._engine.gl,this._id=this._engine._IDCounter++}get destroyed(){return this._destroyed}destroy(){this._destroyed||(this._destroyed=!0)}}class I extends G{get gpuMemory(){return this._gpuMemory}set gpuMemory(e){this._changeTexMemory(e),this._gpuMemory=e}_changeTexMemory(e){this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.M_GPUMemory,-this._gpuMemory+e),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.M_ALLRenderTexture,-this._gpuMemory+e)}constructor(e,r,a,i,s,n){super(e),this._gpuMemory=0,this.colorFormat=r,this.depthStencilFormat=a,this._isCube=i,this._generateMipmap=s,this._samples=n,this._textures=[],this._depthTexture=null,this._framebuffer=this._gl.createFramebuffer(),n>1&&(this._msaaFramebuffer=this._gl.createFramebuffer()),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.RC_ALLRenderTexture,1)}dispose(){this._textures.forEach(e=>{e&&e.dispose()}),this._textures=null,this._depthTexture&&this._depthTexture.dispose(),this._depthTexture=null,this._framebuffer&&this._gl.deleteFramebuffer(this._framebuffer),this._framebuffer=null,this._depthbuffer&&this._gl.deleteRenderbuffer(this._depthbuffer),this._depthbuffer=null,this._msaaFramebuffer&&this._gl.deleteFramebuffer(this._msaaFramebuffer),this._msaaFramebuffer=null,this._msaaRenderbuffer&&this._gl.deleteRenderbuffer(this._msaaRenderbuffer),this._msaaRenderbuffer=null,this._changeTexMemory(0),this._gpuMemory=0,this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.RC_ALLRenderTexture,-1)}}class U extends G{get mipmap(){return this._mipmap}get mipmapCount(){return this._mipmapCount}_getSource(){return this.resource}get gpuMemory(){return this._gpuMemory}set gpuMemory(e){this._changeTexMemory(e),this._gpuMemory=e}constructor(e,r,a,i,s,n,_,l,h){super(e),this._gpuMemory=0,this._baseMipmapLevel=0,this._maxMipmapLevel=0,this.resource=this._gl.createTexture(),this.width=a,this.height=i,this.depth=s;const o=e=>!(e&e-1);switch(this.isPotSize=o(a)&&o(i),n==t.TextureDimension.Tex3D&&(this.isPotSize=this.isPotSize&&o(this.depth)),n){case t.TextureDimension.Tex2D:this._statistics_M_Texture=t.GPUEngineStatisticsInfo.M_Texture2D,this._statistics_RC_Texture=t.GPUEngineStatisticsInfo.RC_Texture2D;break;case t.TextureDimension.Tex3D:this._statistics_M_Texture=t.GPUEngineStatisticsInfo.M_Texture3D,this._statistics_RC_Texture=t.GPUEngineStatisticsInfo.RC_Texture3D;break;case t.TextureDimension.Cube:this._statistics_M_Texture=t.GPUEngineStatisticsInfo.M_TextureCube,this._statistics_RC_Texture=t.GPUEngineStatisticsInfo.RC_TextureCube;break;case t.TextureDimension.Texture2DArray:this._statistics_M_Texture=t.GPUEngineStatisticsInfo.M_Texture2DArray,this._statistics_RC_Texture=t.GPUEngineStatisticsInfo.RC_Texture2DArray}this._mipmap=_&&this.isPotSize,this._mipmapCount=this._mipmap?Math.max(Math.ceil(Math.log2(a))+1,Math.ceil(Math.log2(i))+1):1,this._maxMipmapLevel=this._mipmapCount-1,this._baseMipmapLevel=0,this.useSRGBLoad=l,this.gammaCorrection=h,this.target=r,this.filterMode=t.FilterMode.Bilinear,this.wrapU=t.WrapMode.Repeat,this.wrapV=t.WrapMode.Repeat,this.wrapW=t.WrapMode.Repeat,this.anisoLevel=4,this.compareMode=t.TextureCompareMode.None,z.instance._addStatisticsInfo(this._statistics_RC_Texture,1),z.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.RC_ALLTexture,1)}get filterMode(){return this._filterMode}set filterMode(e){if(this._filterMode!=e&&this.resource){let t=this._gl,r=this.mipmap,a=this.getFilteMinrParam(e,r);this._setTexParameteri(t.TEXTURE_MIN_FILTER,a);let i=this.getFilterMagParam(e);this._setTexParameteri(t.TEXTURE_MAG_FILTER,i),this._filterMode=e}}get wrapU(){return this._warpU}set wrapU(e){if(this._warpU!=e&&this.resource){let t=this._gl,r=this.getWrapParam(e);this._setWrapMode(t.TEXTURE_WRAP_S,r),this._warpU=e}}get wrapV(){return this._warpV}set wrapV(e){if(this._warpV!=e&&this.resource){let t=this._gl,r=this.getWrapParam(e);this._setWrapMode(t.TEXTURE_WRAP_T,r),this._warpV=e}}get wrapW(){return this._warpW}set wrapW(e){if(this._warpW!=e&&this.resource){if(this._engine.getCapable(t.RenderCapable.Texture3D)){let t=this._gl,r=this.getWrapParam(e);this._setWrapMode(t.TEXTURE_WRAP_R,r)}this._warpW=e}}get anisoLevel(){return this._anisoLevel}set anisoLevel(r){let a=this._engine._supportCapatable.getExtension(e.WebGLExtension.EXT_texture_filter_anisotropic);if(a){this._gl;let e=this._engine.getParams(t.RenderParams.Max_AnisoLevel_Count),i=Math.max(1,Math.min(e,r));this._setTexParametexf(a.TEXTURE_MAX_ANISOTROPY_EXT,i),this._anisoLevel=i}else this._anisoLevel=1}set baseMipmapLevel(e){this._engine.isWebGL2&&this._setTexParameteri(this._gl.TEXTURE_BASE_LEVEL,e),this._baseMipmapLevel=e}get baseMipmapLevel(){return this._baseMipmapLevel}set maxMipmapLevel(e){this._engine.isWebGL2&&this._setTexParameteri(this._gl.TEXTURE_MAX_LEVEL,e),this._maxMipmapLevel=e}get maxMipmapLevel(){return this._maxMipmapLevel}get compareMode(){return this._compareMode}set compareMode(e){this._compareMode=e}_setTexParameteri(e,t){let r=this._gl,a=this.target;this._engine._bindTexture(a,this.resource),r.texParameteri(a,e,t),this._engine._bindTexture(a,null)}_setTexParametexf(e,t){let r=this._gl,a=this.target;this._engine._bindTexture(a,this.resource),r.texParameterf(a,e,t),this._engine._bindTexture(a,null)}getFilteMinrParam(e,r){let a=this._gl;switch(e){case t.FilterMode.Point:return r?a.NEAREST_MIPMAP_NEAREST:a.NEAREST;case t.FilterMode.Bilinear:return r?a.LINEAR_MIPMAP_NEAREST:a.LINEAR;case t.FilterMode.Trilinear:return r?a.LINEAR_MIPMAP_LINEAR:a.LINEAR;default:return r?a.LINEAR_MIPMAP_NEAREST:a.LINEAR}}getFilterMagParam(e){let r=this._gl;switch(e){case t.FilterMode.Point:return r.NEAREST;case t.FilterMode.Bilinear:case t.FilterMode.Trilinear:default:return r.LINEAR}}getWrapParam(e){let r=this._gl;switch(e){case t.WrapMode.Repeat:return r.REPEAT;case t.WrapMode.Clamp:return r.CLAMP_TO_EDGE;case t.WrapMode.Mirrored:return r.MIRRORED_REPEAT;default:return r.REPEAT}}_setWrapMode(e,t){let r=this._gl;this.isPotSize||(t=r.CLAMP_TO_EDGE),this._setTexParameteri(e,t)}_changeTexMemory(e){this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.M_GPUMemory,-this._gpuMemory+e),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.M_ALLTexture,-this._gpuMemory+e),this._engine._addStatisticsInfo(this._statistics_M_Texture,-this._gpuMemory+e)}dispose(){this._gl.deleteTexture(this.resource),this._changeTexMemory(0),this._gpuMemory=0,z.instance._addStatisticsInfo(this._statistics_RC_Texture,-1),z.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.RC_ALLTexture,-1)}}class N extends G{constructor(t){super(t),this._glParam={internalFormat:0,format:0,type:0},this.needBitmap=!1,this._sRGB=this._engine._supportCapatable.getExtension(e.WebGLExtension.EXT_sRGB),this._oesTextureHalfFloat=this._engine._supportCapatable.getExtension(e.WebGLExtension.OES_texture_half_float),this._compressdTextureS3tc_srgb=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_s3tc_srgb),this._compressedTextureEtc1=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_etc1),this._compressedTextureS3tc=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_s3tc),this._compressedTextureETC=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_etc),this._compressedTextureASTC=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_astc),this._webgl_depth_texture=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_depth_texture)}createTexture3DInternal(e,t,r,a,i,s,n,_){return null}setTexture3DImageData(e,t,r,a,i){return null}setTexture3DPixelsData(e,t,r,a,i){return null}setTexture3DSubPixelsData(e,t,r,a,i,s,n,_,l,h,o,d){return null}glTextureParam(e,r){let a=this._gl;switch(this._glParam.internalFormat=null,this._glParam.format=null,this._glParam.type=null,e){case t.TextureFormat.R8G8B8:this._glParam.internalFormat=r?this._sRGB.SRGB_EXT:a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.R8G8B8A8:this._glParam.internalFormat=r?this._sRGB.SRGB_ALPHA_EXT:a.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.R5G6B5:this._glParam.internalFormat=a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_SHORT_5_6_5;break;case t.TextureFormat.R32G32B32A32:this._glParam.internalFormat=a.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.FLOAT;break;case t.TextureFormat.R32G32B32:this._glParam.internalFormat=a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.FLOAT;break;case t.TextureFormat.R16G16B16A16:this._glParam.internalFormat=a.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._oesTextureHalfFloat.HALF_FLOAT_OES;break;case t.TextureFormat.R16G16B16:this._glParam.internalFormat=a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._oesTextureHalfFloat.HALF_FLOAT_OES;break;case t.TextureFormat.DXT1:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT1_EXT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.DXT3:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT3_EXT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.DXT5:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT5_EXT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ETC1RGB:this._glParam.internalFormat=this._compressedTextureEtc1.COMPRESSED_RGB_ETC1_WEBGL,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ETC2RGBA:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ETC2RGB:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGB8_ETC2,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ETC2SRGB:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_ETC2,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ETC2SRGB_Alpha8:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ETC2RGB_Alpha1:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ETC2SRGB_Alpha1:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC4x4:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC6x6:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_6x6_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC8x8:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_8x8_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC10x10:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_10x10_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC12x12:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_12x12_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC4x4SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC6x6SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC8x8SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC10x10SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.ASTC12x12SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;default:throw"Unknown Texture Format."}return this._glParam}glRenderTextureParam(e,r){let a=this._gl;switch(this._glParam.internalFormat=null,this._glParam.format=null,this._glParam.type=null,e){case t.RenderTargetFormat.R8G8B8:this._glParam.internalFormat=r?this._sRGB.SRGB_EXT:a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.RenderTargetFormat.R8G8B8A8:this._glParam.internalFormat=r?this._sRGB.SRGB_EXT:a.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case t.RenderTargetFormat.R16G16B16:this._glParam.internalFormat=a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._oesTextureHalfFloat.HALF_FLOAT_OES;break;case t.RenderTargetFormat.R16G16B16A16:this._glParam.internalFormat=a.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._oesTextureHalfFloat.HALF_FLOAT_OES;break;case t.RenderTargetFormat.R32G32B32:this._glParam.internalFormat=a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.FLOAT;break;case t.RenderTargetFormat.R32G32B32A32:this._glParam.internalFormat=a.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.FLOAT;break;case t.RenderTargetFormat.DEPTH_16:this._glParam.internalFormat=a.DEPTH_COMPONENT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_SHORT;break;case t.RenderTargetFormat.DEPTHSTENCIL_24_8:this._glParam.internalFormat=a.DEPTH_STENCIL,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._webgl_depth_texture.UNSIGNED_INT_24_8_WEBGL;break;case t.RenderTargetFormat.DEPTH_32:this._glParam.internalFormat=a.DEPTH_COMPONENT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_INT;break;case t.RenderTargetFormat.STENCIL_8:default:throw"render texture format wrong."}return this._glParam}glRenderBufferParam(e,r){let a=this._gl;switch(e){case t.RenderTargetFormat.DEPTH_16:return{internalFormat:a.DEPTH_COMPONENT16,attachment:a.DEPTH_ATTACHMENT};case t.RenderTargetFormat.DEPTHSTENCIL_24_8:case t.RenderTargetFormat.DEPTH_32:return{internalFormat:a.DEPTH_STENCIL,attachment:a.DEPTH_STENCIL_ATTACHMENT};case t.RenderTargetFormat.STENCIL_8:return{internalFormat:a.STENCIL_INDEX8,attachment:a.STENCIL_ATTACHMENT};default:return null}}glRenderTargetAttachment(e){let r=this._gl;switch(e){case t.RenderTargetFormat.DEPTH_16:return r.DEPTH_ATTACHMENT;case t.RenderTargetFormat.DEPTHSTENCIL_24_8:return r.DEPTH_STENCIL_ATTACHMENT;case t.RenderTargetFormat.DEPTH_32:return r.DEPTH_ATTACHMENT;case t.RenderTargetFormat.STENCIL_8:return r.STENCIL_ATTACHMENT;case t.RenderTargetFormat.R8G8B8:case t.RenderTargetFormat.R8G8B8A8:case t.RenderTargetFormat.R16G16B16:case t.RenderTargetFormat.R16G16B16A16:case t.RenderTargetFormat.R32G32B32:case t.RenderTargetFormat.R32G32B32A32:return r.COLOR_ATTACHMENT0;default:throw"render format."}}getTarget(e){let r=this._gl;switch(e){case t.TextureDimension.Tex2D:return r.TEXTURE_2D;case t.TextureDimension.Cube:return r.TEXTURE_CUBE_MAP;default:throw"texture dimension wrong in WebGL1."}}getFormatPixelsParams(e){let r={channels:0,bytesPerPixel:0,dataTypedCons:Uint8Array,typedSize:1};switch(e){case t.TextureFormat.R8G8B8A8:return r.channels=4,r.bytesPerPixel=4,r.dataTypedCons=Uint8Array,r.typedSize=1,r;case t.TextureFormat.R8G8B8:return r.channels=3,r.bytesPerPixel=3,r.dataTypedCons=Uint8Array,r.typedSize=1,r;case t.TextureFormat.R5G6B5:return r.channels=3,r.bytesPerPixel=2,r.dataTypedCons=Uint16Array,r.typedSize=2,r;case t.TextureFormat.R16G16B16:return r.channels=3,r.bytesPerPixel=6,r.dataTypedCons=Uint16Array,r.typedSize=2,r;case t.TextureFormat.R16G16B16A16:return r.channels=4,r.bytesPerPixel=8,r.dataTypedCons=Uint16Array,r.typedSize=2,r;case t.TextureFormat.R32G32B32:return r.channels=3,r.bytesPerPixel=12,r.dataTypedCons=Float32Array,r.typedSize=4,r;case t.TextureFormat.R32G32B32A32:return r.channels=4,r.bytesPerPixel=16,r.dataTypedCons=Float32Array,r.typedSize=4,r;default:return r}}getGLtexMemory(e,t=1){let r=this._gl,a=0,i=0,s=0,n=this._sRGB?this._sRGB.SRGB_EXT:r.RGB,_=this._sRGB?this._sRGB.SRGB_ALPHA_EXT:r.RGBA;switch(e.internalFormat){case n:case r.RGB:a=3;break;case _:case r.RGBA:a=4;break;default:a=0}switch(e.type){case r.UNSIGNED_BYTE:i=1;break;case r.UNSIGNED_SHORT_5_6_5:i=2/3;break;case r.FLOAT:i=4;break;case this._oesTextureHalfFloat.HALF_FLOAT_OES:i=2;break;default:i=0}return s=a*i*e.width*e.height,e.mipmap&&(s*=1.333),e.target==r.TEXTURE_CUBE_MAP?s*=6:e.target==r.TEXTURE_2D&&(s*=1),s}getGLRTTexMemory(e,r,a,i,s,n,_){let l=e=>{let r=0;switch(e){case t.RenderTargetFormat.R8G8B8:r=3;break;case t.RenderTargetFormat.R8G8B8A8:r=4;break;case t.RenderTargetFormat.R16G16B16A16:r=8;break;case t.RenderTargetFormat.R32G32B32:r=12;break;case t.RenderTargetFormat.R32G32B32A32:r=16;break;case t.RenderTargetFormat.R16G16B16:r=6;break;case t.RenderTargetFormat.DEPTH_16:r=2;break;case t.RenderTargetFormat.STENCIL_8:r=1;break;case t.RenderTargetFormat.DEPTHSTENCIL_24_8:case t.RenderTargetFormat.DEPTH_32:r=4}return r},h=l(a);return n>1&&(h*=2),_&&(h*=6),s&&(h*=1.333),h*e*r+l(i)*e*r}supportSRGB(e,r){switch(e){case t.TextureFormat.R8G8B8:case t.TextureFormat.R8G8B8A8:return this._engine.getCapable(t.RenderCapable.Texture_SRGB)&&!r;case t.TextureFormat.DXT1:case t.TextureFormat.DXT3:case t.TextureFormat.DXT5:return this._engine.getCapable(t.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB)&&!r;default:return!1}}supportGenerateMipmap(e){switch(e){case t.RenderTargetFormat.DEPTH_16:case t.RenderTargetFormat.DEPTHSTENCIL_24_8:case t.RenderTargetFormat.DEPTH_32:case t.RenderTargetFormat.STENCIL_8:return!1;default:return!0}}isSRGBFormat(e){switch(e){case t.TextureFormat.ETC2SRGB:case t.TextureFormat.ETC2SRGB_Alpha8:case t.TextureFormat.ETC2SRGB_Alpha1:case t.TextureFormat.ASTC4x4SRGB:case t.TextureFormat.ASTC6x6SRGB:case t.TextureFormat.ASTC8x8SRGB:case t.TextureFormat.ASTC10x10SRGB:case t.TextureFormat.ASTC12x12SRGB:return!0;default:return!1}}createTextureInternal(e,t,r,a,i,s,n){let _=this.isSRGBFormat(a)||s&&this.supportSRGB(a,i);n&&(_=!1);let l=1;!_&&s&&(l=2.2);let h=this.getTarget(e),o=new U(this._engine,h,t,r,1,e,i,_,l),d=this.glTextureParam(a,_);return o.internalFormat=d.internalFormat,o.format=d.format,o.type=d.type,o}setTextureImageData(e,t,r,a){e.width==t.width&&e.height==t.height||console.warn("setTextureImageData: size not match");let i=e.target,s=e.internalFormat,n=e.format,_=e.type;e.width,e.height;let l=e._gl;r&&l.pixelStorei(l.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),l.texImage2D(i,0,s,n,_,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&l.generateMipmap(e.target),this._engine._bindTexture(e.target,null),r&&l.pixelStorei(l.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,!1)}setTextureSubImageData(e,t,r,a,i,s){let n=e.target;e.internalFormat;let _=e.format,l=e.type;t.width,t.height;let h=e._gl;i&&h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),s&&h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),h.texSubImage2D(n,0,r,a,_,l,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&h.generateMipmap(e.target),this._engine._bindTexture(e.target,null),i&&h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),s&&h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,!1)}initVideoTextureData(e){let t=e.target;e.internalFormat;let r=e.format,a=e.type,i=e.width,s=e.height,n=e._gl;this._engine._bindTexture(e.target,e.resource),n.texImage2D(t,0,e.internalFormat,i,s,0,r,a,null),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&n.generateMipmap(e.target),this._engine._bindTexture(e.target,null)}setTexturePixelsData(e,t,r,a){let i=e.target,s=e.internalFormat,n=e.format,_=e.type,l=e.width,h=e.height,o=l%4==0&&h%4==0,d=e._gl;r&&d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!0),o||d.pixelStorei(d.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),d.texImage2D(i,0,s,l,h,0,n,_,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&d.generateMipmap(e.target),this._engine._bindTexture(e.target,null),r&&d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!1),o||d.pixelStorei(d.UNPACK_ALIGNMENT,4)}setTextureSubPixelsData(e,t,r,a,i,s,n,_,l,h){a=a&&0==r;let o=e.target;e.internalFormat;let d=e.format,u=e.type,c=n%4==0&&_%4==0,f=e._gl;l&&f.pixelStorei(f.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),h&&f.pixelStorei(f.UNPACK_FLIP_Y_WEBGL,!0),c||f.pixelStorei(f.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),f.texSubImage2D(o,r,i,s,n,_,d,u,t),e.mipmap&&a&&f.generateMipmap(e.target),this._engine._bindTexture(e.target,null),l&&f.pixelStorei(f.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),h&&f.pixelStorei(f.UNPACK_FLIP_Y_WEBGL,!1),c||f.pixelStorei(f.UNPACK_ALIGNMENT,4)}setTextureDDSData(e,t){let r=e.target,a=e.internalFormat,i=e.format,s=e.type,n=e.width,_=e.height,l=t.source,h=t.dataOffset,o=t.bpp,d=t.blockBytes,u=t.mipmapCount,c=t.compressed;e.maxMipmapLevel=u-1;let f=n%4==0&&_%4==0,m=e._gl;f||m.pixelStorei(m.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource);let p=this.getFormatPixelsParams(t.format),g=p.bytesPerPixel/p.channels,E=p.dataTypedCons,T=n,S=_,R=0;for(let e=0;e<u;e++){if(c){let t=Math.max(4,T)/4*Math.max(4,S)/4*d,i=new Uint8Array(l,h,t);m.compressedTexImage2D(r,e,a,T,S,0,i),R+=i.length,h+=o?T*S*(o/8):t}else{let t=T*S*p.channels,n=new E(l,h,t);R+=n.length,m.texImage2D(r,e,a,T,S,0,i,s,n),h+=t*g}T*=.5,S*=.5,T=Math.max(1,T),S=Math.max(1,S)}e.gpuMemory=R,this._engine._bindTexture(e.target,null),f||m.pixelStorei(m.UNPACK_ALIGNMENT,4)}setTextureKTXData(e,t){let r=t.source,a=t.compress,i=e.target,s=e.internalFormat,n=e.format,_=e.type,l=e.mipmapCount,h=e.width,o=e.height;e.maxMipmapLevel=l-1;let d=h%4==0&&o%4==0,u=e._gl;d||u.pixelStorei(u.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource);let c=h,f=o,m=t.headerOffset+t.bytesOfKeyValueData,p=0;for(let e=0;e<t.mipmapCount;e++){let l=new Int32Array(r,m,1)[0];if(m+=4,a){let t=new Uint8Array(r,m,l);u.compressedTexImage2D(i,e,s,c,f,0,t),p+=t.length}else{let a=this.getFormatPixelsParams(t.format),h=l/a.typedSize,o=new a.dataTypedCons(r,m,h);u.texImage2D(i,e,s,c,f,0,n,_,o),p+=o.byteLength}m+=l,m+=3-(l+3)%4,c=Math.max(1,.5*c),f=Math.max(1,.5*f)}for(let r=t.mipmapCount;r<e.mipmapCount;r++)a||u.texImage2D(i,r,s,c,f,0,n,_,null),c=Math.max(1,.5*c),f=Math.max(1,.5*f);e.gpuMemory=p,this._engine._bindTexture(e.target,null),d||u.pixelStorei(u.UNPACK_ALIGNMENT,4)}setTextureHDRData(e,t){let r=t.readScanLine();this.setTexturePixelsData(e,r,!1,!1)}setCubeImageData(e,t,r,a){let i=e._gl;const s=[i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z,i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y];let n=e.internalFormat,_=e.format,l=e.type;e.width,e.height,r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource);for(let e=0;e<s.length;e++){let r=s[e];i.texImage2D(r,0,n,_,l,t[e])}e.mipmap&&i.generateMipmap(e.target),this._engine._bindTexture(e.target,null),e.gpuMemory=this.getGLtexMemory(e),r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1)}setCubePixelsData(e,t,r,a){let i=e._gl;const s=[i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z,i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y];e.target;let n=e.internalFormat,_=e.format,l=e.type,h=e.width,o=e.height,d=h%4==0;if(r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0),d||i.pixelStorei(i.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),t){for(let e=0;e<s.length;e++){let r=s[e];i.texImage2D(r,0,n,h,o,0,_,l,t[e])}e.mipmap&&i.generateMipmap(e.target)}else{for(let e=0;e<s.length;e++){let t=s[e];i.texImage2D(t,0,n,h,o,0,_,l,null)}e.mipmap&&i.generateMipmap(e.target)}this._engine._bindTexture(e.target,null),e.gpuMemory=this.getGLtexMemory(e),r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1),d||i.pixelStorei(i.UNPACK_ALIGNMENT,4)}setCubeSubPixelData(e,t,r,a,i,s,n,_,l,h){a=a&&0==r;let o=e._gl;const d=[o.TEXTURE_CUBE_MAP_POSITIVE_Z,o.TEXTURE_CUBE_MAP_NEGATIVE_Z,o.TEXTURE_CUBE_MAP_POSITIVE_X,o.TEXTURE_CUBE_MAP_NEGATIVE_X,o.TEXTURE_CUBE_MAP_POSITIVE_Y,o.TEXTURE_CUBE_MAP_NEGATIVE_Y];e.target,e.internalFormat;let u=e.format,c=e.type,f=n%4==0;l&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),h&&o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,!0),f||o.pixelStorei(o.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource);for(let e=0;e<d.length;e++){let a=d[e];o.texSubImage2D(a,r,i,s,n,_,u,c,t[e])}e.mipmap&&a&&o.generateMipmap(e.target),this._engine._bindTexture(e.target,null),l&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),h&&o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,!1),f||o.pixelStorei(o.UNPACK_ALIGNMENT,4)}setCubeDDSData(e,t){let r=e.internalFormat,a=e.format,i=e.type,s=e.width,n=e.height,_=t.source,l=t.dataOffset,h=t.bpp,o=t.blockBytes,d=t.mipmapCount;e.maxMipmapLevel=d-1;let u=s%4==0&&n%4==0;u=!0;let c=e._gl;this._engine._bindTexture(e.target,e.resource);const f=[c.TEXTURE_CUBE_MAP_POSITIVE_X,c.TEXTURE_CUBE_MAP_NEGATIVE_X,c.TEXTURE_CUBE_MAP_POSITIVE_Y,c.TEXTURE_CUBE_MAP_NEGATIVE_Y,c.TEXTURE_CUBE_MAP_POSITIVE_Z,c.TEXTURE_CUBE_MAP_NEGATIVE_Z];let m=this.getFormatPixelsParams(t.format),p=m.bytesPerPixel/m.channels,g=m.dataTypedCons,E=0;if(t.compressed)for(let t=0;t<6;t++){let a=f[t],i=s,u=n;for(let t=0;t<d;t++){let s=Math.max(4,i)/4*Math.max(4,u)/4*o,n=new Uint8Array(_,l,s);(e.mipmap||0==t)&&c.compressedTexImage2D(a,t,r,i,u,0,n),E+=n.byteLength,l+=h?i*u*(h/8):s,i*=.5,u*=.5,i=Math.max(1,i),u=Math.max(1,u)}}else for(let e=0;e<6;e++){let t=f[e],h=s,o=n;for(let e=0;e<d;e++){let s=h*o*m.channels,n=new g(_,l,s);c.texImage2D(t,e,r,h,o,0,a,i,n),E+=n.byteLength,l+=s*p,h*=.5,o*=.5,h=Math.max(1,h),o=Math.max(1,o)}}e.gpuMemory=E,this._engine._bindTexture(e.target,null)}setCubeKTXData(e,t){let r=t.source,a=t.compress,i=e.internalFormat,s=e.format,n=e.type,_=t.mipmapCount,l=e.width,h=e.height;e.maxMipmapLevel=_-1;let o=l%4==0&&h%4==0,d=e._gl;const u=[d.TEXTURE_CUBE_MAP_POSITIVE_X,d.TEXTURE_CUBE_MAP_NEGATIVE_X,d.TEXTURE_CUBE_MAP_POSITIVE_Y,d.TEXTURE_CUBE_MAP_NEGATIVE_Y,d.TEXTURE_CUBE_MAP_POSITIVE_Z,d.TEXTURE_CUBE_MAP_NEGATIVE_Z];o||d.pixelStorei(d.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource);let c=l,f=h,m=t.headerOffset+t.bytesOfKeyValueData,p=0;for(let e=0;e<t.mipmapCount;e++){let _=new Int32Array(r,m,1)[0];m+=4;for(let l=0;l<6;l++){let h=u[l];if(a){let t=new Uint8Array(r,m,_);d.compressedTexImage2D(h,e,i,c,f,0,t),p+=t.byteLength}else{let a=this.getFormatPixelsParams(t.format),l=_/a.typedSize,o=new a.dataTypedCons(r,m,l);d.texImage2D(h,e,i,c,f,0,s,n,o),p+=o.byteLength}m+=_,m+=3-(_+3)%4}c=Math.max(1,.5*c),f=Math.max(1,.5*f)}for(let r=t.mipmapCount;r<e.mipmapCount;r++){for(let e=0;e<6;e++){let t=u[e];a||d.texImage2D(t,r,i,c,f,0,s,n,null)}c=Math.max(1,.5*c),f=Math.max(1,.5*f)}this._engine._bindTexture(e.target,null),e.gpuMemory=p,o||d.pixelStorei(d.UNPACK_ALIGNMENT,4)}setTextureCompareMode(e,r){return t.TextureCompareMode.None}bindRenderTarget(e,t=0){this.currentActiveRT&&this.unbindRenderTarget(this.currentActiveRT);let r=this._gl,a=e._framebuffer;if(r.bindFramebuffer(r.FRAMEBUFFER,a),e._isCube){let a=e._textures[0];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_CUBE_MAP_POSITIVE_X+t,a.resource,0)}this.currentActiveRT=e}bindoutScreenTarget(){this.currentActiveRT!=z._lastFrameBuffer&&this.unbindRenderTarget(this.currentActiveRT)}unbindRenderTarget(e){let t=e._gl;e&&e._generateMipmap&&e._textures.forEach(e=>{let r=e.target;this._engine._bindTexture(r,e.resource),t.generateMipmap(r),this._engine._bindTexture(r,null)}),t.bindFramebuffer(t.FRAMEBUFFER,z._lastFrameBuffer_WebGLOBJ),this.currentActiveRT=z._lastFrameBuffer}createRenderTextureCubeInternal(e,r,a,i,s){let n=!1;i=i&&this.supportGenerateMipmap(a);let _=this.getTarget(e),l=new U(this._engine,_,r,r,1,e,i,n,1),h=this.glRenderTextureParam(a,n);l.internalFormat=h.internalFormat,l.format=h.format,l.type=h.type;let o=l.internalFormat,d=l.format,u=l.type,c=l._gl;const f=[c.TEXTURE_CUBE_MAP_POSITIVE_Z,c.TEXTURE_CUBE_MAP_NEGATIVE_Z,c.TEXTURE_CUBE_MAP_POSITIVE_X,c.TEXTURE_CUBE_MAP_NEGATIVE_X,c.TEXTURE_CUBE_MAP_POSITIVE_Y,c.TEXTURE_CUBE_MAP_NEGATIVE_Y];this._engine._bindTexture(l.target,l.resource);for(let e=0;e<f.length;e++){let t=f[e];c.texImage2D(t,0,o,r,r,0,d,u,null)}return this._engine._bindTexture(l.target,null),a!=t.RenderTargetFormat.DEPTH_16&&a!=t.RenderTargetFormat.DEPTH_32&&a!=t.RenderTargetFormat.DEPTHSTENCIL_24_8||(l.filterMode=t.FilterMode.Point),l}createRenderTargetInternal(e,r,a,i,s,n,_,l){let h=this.createRenderTextureInternal(t.TextureDimension.Tex2D,e,r,a,s,n),o=new I(this._engine,a,i,!1,h.mipmap,1);o.gpuMemory=this.getGLRTTexMemory(e,r,a,i,s,1,!1),o.colorFormat=a,o.depthStencilFormat=i,o._textures.push(h);let d=o._framebuffer,u=o._gl;u.bindFramebuffer(u.FRAMEBUFFER,d);let c=this.glRenderTargetAttachment(a);u.framebufferTexture2D(u.FRAMEBUFFER,c,u.TEXTURE_2D,h.resource,0);let f=this.glRenderBufferParam(i,!1);if(f){let t=this.createRenderbuffer(e,r,f.internalFormat,o._samples);o._depthbuffer=t,u.framebufferRenderbuffer(u.FRAMEBUFFER,f.attachment,u.RENDERBUFFER,t)}return u.bindFramebuffer(u.FRAMEBUFFER,z._lastFrameBuffer_WebGLOBJ),o}createRenderTargetCubeInternal(e,r,a,i,s,n){let _=this.createRenderTextureCubeInternal(t.TextureDimension.Cube,e,r,i,s),l=new I(this._engine,r,a,!0,_.mipmap,1);l.gpuMemory=this.getGLRTTexMemory(e,e,r,a,i,1,!0),l._textures.push(_);let h=l._framebuffer,o=l._gl;o.bindFramebuffer(o.FRAMEBUFFER,h);let d=this.glRenderBufferParam(a,!1);if(d){let t=this.createRenderbuffer(e,e,d.internalFormat,l._samples);l._depthbuffer=t,o.framebufferRenderbuffer(o.FRAMEBUFFER,d.attachment,o.RENDERBUFFER,t)}return o.bindFramebuffer(o.FRAMEBUFFER,z._lastFrameBuffer_WebGLOBJ),l}createRenderbuffer(e,t,r,a){let i=this._gl,s=i.createRenderbuffer();return i.bindRenderbuffer(i.RENDERBUFFER,s),i.renderbufferStorage(i.RENDERBUFFER,r,e,t),i.bindRenderbuffer(i.RENDERBUFFER,null),s}createRenderTextureInternal(e,r,a,i,s,n){let _=!1;s=s&&this.supportGenerateMipmap(i);let l=this.getTarget(e),h=new U(this._engine,l,r,a,1,e,s,_,1),o=this.glRenderTextureParam(i,_);h.internalFormat=o.internalFormat,h.format=o.format,h.type=o.type;let d=h.internalFormat,u=h.format,c=h.type,f=h._gl;return this._engine._bindTexture(h.target,h.resource),f.texImage2D(l,0,d,r,a,0,u,c,null),this._engine._bindTexture(h.target,null),i!=t.RenderTargetFormat.DEPTH_16&&i!=t.RenderTargetFormat.DEPTH_32&&i!=t.RenderTargetFormat.DEPTHSTENCIL_24_8||(h.filterMode=t.FilterMode.Point),h}createRenderTargetDepthTexture(e,r,a,i){let s=e._gl;if(e.depthStencilFormat==t.RenderTargetFormat.None)return null;let n=e._depthbuffer;n&&s.deleteRenderbuffer(n),e._depthbuffer=null;let _=e.depthStencilFormat,l=e._generateMipmap,h=e.isSRGB;e._depthTexture&&s.deleteTexture(e._depthTexture);let o=this.createRenderTextureInternal(r,a,i,_,l,h);e._depthTexture=o;let d=this.glRenderTargetAttachment(e.depthStencilFormat),u=e._framebuffer;return s.bindFramebuffer(s.FRAMEBUFFER,u),s.framebufferTexture2D(s.FRAMEBUFFER,d,s.TEXTURE_2D,o.resource,0),s.bindFramebuffer(s.FRAMEBUFFER,z._lastFrameBuffer_WebGLOBJ),o}readRenderTargetPixelData(e,r,a,i,s,n){let _=e._gl;if(this.bindRenderTarget(e),!(_.checkFramebufferStatus(_.FRAMEBUFFER)==_.FRAMEBUFFER_COMPLETE))return this.unbindRenderTarget(e),null;switch(e.colorFormat){case t.RenderTargetFormat.R8G8B8:_.readPixels(r,a,i,s,_.RGB,_.UNSIGNED_BYTE,n);break;case t.RenderTargetFormat.R8G8B8A8:_.readPixels(r,a,i,s,_.RGBA,_.UNSIGNED_BYTE,n);break;case t.RenderTargetFormat.R16G16B16:_.readPixels(r,a,i,s,_.RGB,_.FLOAT,n);break;case t.RenderTargetFormat.R16G16B16A16:_.readPixels(r,a,i,s,_.RGBA,_.FLOAT,n);break;case t.RenderTargetFormat.R32G32B32:_.readPixels(r,a,i,s,_.RGB,_.FLOAT,n);break;case t.RenderTargetFormat.R32G32B32A32:_.readPixels(r,a,i,s,_.RGBA,_.FLOAT,n)}return this.unbindRenderTarget(e),n}readRenderTargetPixelDataAsync(e,t,r,a,i,s){return Promise.resolve(this.readRenderTargetPixelData(e,t,r,a,i,s))}updateVideoTexture(e,t,r,a){let i=e._gl,s=e.target,n=e.internalFormat,_=e.format,l=e.type;e.width,e.height,r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0),i.pixelStorei(i.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),i.texImage2D(s,0,n,_,l,t),this._engine._bindTexture(e.target,null),r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1),i.pixelStorei(i.UNPACK_ALIGNMENT,4)}}class w extends N{constructor(e){super(e)}getTarget(e){let r=-1;switch(e){case t.TextureDimension.Cube:r=this._gl.TEXTURE_CUBE_MAP;break;case t.TextureDimension.Tex2D:r=this._gl.TEXTURE_2D;break;case t.TextureDimension.Texture2DArray:r=this._gl.TEXTURE_2D_ARRAY;break;case t.TextureDimension.Tex3D:r=this._gl.TEXTURE_3D;break;default:throw"Unknow Texture Target"}return r}glTextureParam(e,r){let a=this._gl;switch(this._glParam.internalFormat=null,this._glParam.format=null,this._glParam.type=null,e){case t.TextureFormat.R8G8B8:this._glParam.internalFormat=r?a.SRGB8:a.RGB8,this._glParam.format=a.RGB,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.R8G8B8A8:this._glParam.internalFormat=r?a.SRGB8_ALPHA8:a.RGBA8,this._glParam.format=a.RGBA,this._glParam.type=a.UNSIGNED_BYTE;break;case t.TextureFormat.R5G6B5:this._glParam.internalFormat=a.RGB565,this._glParam.format=a.RGB,this._glParam.type=a.UNSIGNED_SHORT_5_6_5;break;case t.TextureFormat.R32G32B32A32:this._glParam.internalFormat=a.RGBA32F,this._glParam.format=a.RGBA,this._glParam.type=a.FLOAT;break;case t.TextureFormat.R32G32B32:this._glParam.internalFormat=a.RGB32F,this._glParam.format=a.RGB,this._glParam.type=a.FLOAT;break;case t.TextureFormat.R16G16B16:this._glParam.internalFormat=a.RGB16F,this._glParam.format=a.RGB,this._glParam.type=a.HALF_FLOAT;break;case t.TextureFormat.R16G16B16A16:this._glParam.internalFormat=a.RGBA16F,this._glParam.format=a.RGBA,this._glParam.type=a.HALF_FLOAT;break;case t.TextureFormat.DXT1:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT1_EXT;break;case t.TextureFormat.DXT3:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case t.TextureFormat.DXT5:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case t.TextureFormat.ETC1RGB:this._glParam.internalFormat=this._compressedTextureEtc1.COMPRESSED_RGB_ETC1_WEBGL;break;case t.TextureFormat.ETC2RGBA:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC;break;case t.TextureFormat.ETC2RGB:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGB8_ETC2;break;case t.TextureFormat.ETC2SRGB:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_ETC2;break;case t.TextureFormat.ETC2SRGB_Alpha8:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;break;case t.TextureFormat.ETC2RGB_Alpha1:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;break;case t.TextureFormat.ETC2SRGB_Alpha1:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;break;case t.TextureFormat.ASTC4x4:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case t.TextureFormat.ASTC6x6:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_6x6_KHR;break;case t.TextureFormat.ASTC8x8:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_8x8_KHR;break;case t.TextureFormat.ASTC10x10:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_10x10_KHR;break;case t.TextureFormat.ASTC12x12:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_12x12_KHR;break;case t.TextureFormat.ASTC4x4SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case t.TextureFormat.ASTC6x6SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;break;case t.TextureFormat.ASTC8x8SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;break;case t.TextureFormat.ASTC10x10SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;break;case t.TextureFormat.ASTC12x12SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;break;default:throw"Unknown Texture Format."}return this._glParam}glRenderBufferParam(e,r){let a=this._gl;switch(e){case t.RenderTargetFormat.DEPTH_16:return{internalFormat:a.DEPTH_COMPONENT16,attachment:a.DEPTH_ATTACHMENT};case t.RenderTargetFormat.DEPTHSTENCIL_24_8:return{internalFormat:a.DEPTH24_STENCIL8,attachment:a.DEPTH_STENCIL_ATTACHMENT};case t.RenderTargetFormat.DEPTH_32:return{internalFormat:a.DEPTH_COMPONENT32F,attachment:a.DEPTH_ATTACHMENT};case t.RenderTargetFormat.STENCIL_8:return{internalFormat:a.STENCIL_INDEX8,attachment:a.STENCIL_ATTACHMENT};case t.RenderTargetFormat.R8G8B8:return{internalFormat:r?a.SRGB8:a.RGB8,attachment:a.COLOR_ATTACHMENT0};case t.RenderTargetFormat.R8G8B8A8:return{internalFormat:r?a.SRGB8_ALPHA8:a.RGBA8,attachment:a.COLOR_ATTACHMENT0};case t.RenderTargetFormat.R16G16B16:return{internalFormat:a.RGB16F,attachment:a.COLOR_ATTACHMENT0};case t.RenderTargetFormat.R16G16B16A16:return{internalFormat:a.RGBA16F,attachment:a.COLOR_ATTACHMENT0};case t.RenderTargetFormat.R32G32B32:return{internalFormat:a.RGB32F,attachment:a.COLOR_ATTACHMENT0};case t.RenderTargetFormat.R32G32B32A32:return{internalFormat:a.RGBA32F,attachment:a.COLOR_ATTACHMENT0};default:return null}}glRenderTextureParam(e,r){let a=this._gl;switch(this._glParam.internalFormat=null,this._glParam.format=null,this._glParam.type=null,e){case t.RenderTargetFormat.R8G8B8:this._glParam.internalFormat=r?a.SRGB8:a.RGB8,this._glParam.format=a.RGB,this._glParam.type=a.UNSIGNED_BYTE;break;case t.RenderTargetFormat.R8G8B8A8:this._glParam.internalFormat=r?a.SRGB8_ALPHA8:a.RGBA8,this._glParam.format=a.RGBA,this._glParam.type=a.UNSIGNED_BYTE;break;case t.RenderTargetFormat.R16G16B16:this._glParam.internalFormat=a.RGB16F,this._glParam.format=a.RGB,this._glParam.type=a.HALF_FLOAT;break;case t.RenderTargetFormat.R16G16B16A16:this._glParam.internalFormat=a.RGBA16F,this._glParam.format=a.RGBA,this._glParam.type=a.HALF_FLOAT;break;case t.RenderTargetFormat.R32G32B32:this._glParam.internalFormat=a.RGB32F,this._glParam.format=a.RGB,this._glParam.type=a.FLOAT;break;case t.RenderTargetFormat.R32G32B32A32:this._glParam.internalFormat=a.RGBA32F,this._glParam.format=a.RGBA,this._glParam.type=a.FLOAT;break;case t.RenderTargetFormat.DEPTH_16:this._glParam.internalFormat=a.DEPTH_COMPONENT16,this._glParam.format=a.DEPTH_COMPONENT,this._glParam.type=a.UNSIGNED_INT;break;case t.RenderTargetFormat.DEPTHSTENCIL_24_8:this._glParam.internalFormat=a.DEPTH24_STENCIL8,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_INT_24_8;break;case t.RenderTargetFormat.DEPTH_32:this._glParam.internalFormat=a.DEPTH_COMPONENT32F,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_INT;break;case t.RenderTargetFormat.STENCIL_8:break;default:throw"depth texture format wrong."}return this._glParam}getGLtexMemory(e,t=1){let r=this._gl,a=0,i=0,s=0;switch(e.internalFormat){case r.SRGB8:case r.RGB8:case r.RGB565:case r.RGB32F:case r.RGB16F:a=3;break;case r.SRGB8_ALPHA8:case r.RGBA8:case r.RGBA32F:case r.RGBA16F:a=4;break;default:a=0}switch(e.type){case r.UNSIGNED_BYTE:i=1;break;case r.UNSIGNED_SHORT_5_6_5:i=2/3;break;case r.FLOAT:i=4;break;case r.HALF_FLOAT:i=2;break;default:i=0}return s=a*i*e.width*e.height,e.mipmap&&(s*=1.333),e.target==r.TEXTURE_CUBE_MAP?s*=6:e.target==r.TEXTURE_2D?s*=1:e.target==r.TEXTURE_2D_ARRAY&&(s*=t),s}supportSRGB(e,r){switch(e){case t.TextureFormat.R8G8B8:return this._engine.getCapable(t.RenderCapable.Texture_SRGB)&&!r;case t.TextureFormat.R8G8B8A8:return this._engine.getCapable(t.RenderCapable.Texture_SRGB);case t.TextureFormat.DXT1:case t.TextureFormat.DXT3:case t.TextureFormat.DXT5:return this._engine.getCapable(t.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB)&&!r;default:return!1}}setTextureImageData(e,t,r,a){e.width==t.width&&e.height==t.height||console.warn("setTextureImageData: size not match");let i=e.target,s=e.internalFormat,n=e.format,_=e.type,l=e.width,h=e.height,o=e.mipmapCount,d=this._gl;r&&d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),d.texStorage2D(i,o,s,l,h),d.texSubImage2D(i,0,0,0,l,h,n,_,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&d.generateMipmap(e.target),this._engine._bindTexture(e.target,null),r&&d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!1)}setTextureSubImageData(e,t,r,a,i,s){let n=e.target;e.internalFormat;let _=e.format,l=e.type;e.width,e.height,e.mipmapCount;let h=this._gl;i&&h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),s&&h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),h.texSubImage2D(n,0,r,a,t.width,t.height,_,l,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&h.generateMipmap(e.target),this._engine._bindTexture(e.target,null),i&&h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),s&&h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,!1)}setTexturePixelsData(e,t,r,a){let i=e.target,s=e.internalFormat,n=e.format,_=e.type,l=e.width,h=e.height,o=e.mipmapCount,d=l%4==0&&h%4==0,u=this._gl;r&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!0),d||u.pixelStorei(u.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),u.texStorage2D(i,o,s,l,h),e.gpuMemory=this.getGLtexMemory(e),t&&(u.texSubImage2D(i,0,0,0,l,h,n,_,t),e.mipmap&&u.generateMipmap(e.target)),this._engine._bindTexture(e.target,null),r&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!1),d||u.pixelStorei(u.UNPACK_ALIGNMENT,4)}createTexture3DInternal(e,t,r,a,i,s,n,_){let l=this.isSRGBFormat(i)||n&&this.supportSRGB(i,s);_&&(l=!1);let h=1;!l&&n&&(h=2.2);let o=this.getTarget(e),d=new U(this._engine,o,t,r,a,e,s,l,h),u=this.glTextureParam(i,l);return d.internalFormat=u.internalFormat,d.format=u.format,d.type=u.type,d}setTexture3DImageData(e,t,r,a,i){let s=e.target,n=e.internalFormat,_=e.format,l=e.type,h=e.width,o=e.height,d=e.mipmapCount,u=this._gl;a&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),i&&u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),u.texStorage3D(s,d,n,h,o,r),e.gpuMemory=this.getGLtexMemory(e,r);for(let e=0;e<r;e++)u.texSubImage3D(s,0,0,0,e,h,o,1,_,l,t[e]);e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&u.generateMipmap(e.target),this._engine._bindTexture(e.target,null),a&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),i&&u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!1)}setTexture3DPixelsData(e,t,r,a,i){let s=e.target,n=e.internalFormat,_=e.format,l=e.type,h=e.width,o=e.height,d=e.mipmapCount,u=h%4==0&&o%4==0,c=this._gl;a&&c.pixelStorei(c.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),i&&c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!0),u||c.pixelStorei(c.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),c.texStorage3D(s,d,n,h,o,r),e.gpuMemory=this.getGLtexMemory(e,r),t&&(c.texSubImage3D(s,0,0,0,0,h,o,r,_,l,t),e.mipmap&&c.generateMipmap(e.target)),this._engine._bindTexture(e.target,null),a&&c.pixelStorei(c.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),i&&c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!1),u||c.pixelStorei(c.UNPACK_ALIGNMENT,4)}setTexture3DSubPixelsData(e,t,r,a,i,s,n,_,l,h,o,d){a=a&&0==r;let u=e.target;e.internalFormat;let c=e.format,f=e.type,m=_%4==0&&l%4==0,p=this._gl;o&&p.pixelStorei(p.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),d&&p.pixelStorei(p.UNPACK_FLIP_Y_WEBGL,!0),m||p.pixelStorei(p.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),p.texSubImage3D(u,r,i,s,n,_,l,h,c,f,t),e.mipmap&&a&&p.generateMipmap(e.target),this._engine._bindTexture(e.target,null),o&&p.pixelStorei(p.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),d&&p.pixelStorei(p.UNPACK_FLIP_Y_WEBGL,!1),m||p.pixelStorei(p.UNPACK_ALIGNMENT,4)}setTextureHDRData(e,t){let r=t.readScanLine();this.setTexturePixelsData(e,r,!1,!1)}setTextureKTXData(e,t){let r=e.target,a=e.internalFormat,i=e.format,s=e.type,n=e.mipmapCount,_=e.width,l=e.height;e.maxMipmapLevel=n-1;let h=t.source,o=t.compress,d=_%4==0&&l%4==0,u=this._gl;d||u.pixelStorei(u.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),o||u.texStorage2D(r,t.mipmapCount,a,_,l);let c=_,f=l,m=t.headerOffset+t.bytesOfKeyValueData,p=0;for(let e=0;e<t.mipmapCount;e++){let n=new Int32Array(h,m,1)[0];if(m+=4,o){let t=new Uint8Array(h,m,n);u.compressedTexImage2D(r,e,a,c,f,0,t),p+=t.length}else{let a=this.getFormatPixelsParams(t.format),_=n/a.typedSize,l=new a.dataTypedCons(h,m,_);u.texSubImage2D(r,e,0,0,c,f,i,s,l),p+=l.length}m+=n,m+=3-(n+3)%4,c=Math.max(1,.5*c),f=Math.max(1,.5*f)}this._engine._bindTexture(e.target,null),e.gpuMemory=p,d||u.pixelStorei(u.UNPACK_ALIGNMENT,4)}setCubeImageData(e,t,r,a){let i=this._gl;const s=[i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z,i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y];let n=e.target,_=e.internalFormat,l=e.format,h=e.type,o=e.width,d=e.height,u=e.mipmapCount;r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),i.texStorage2D(n,u,_,o,d),e.gpuMemory=this.getGLtexMemory(e);for(let e=0;e<s.length;e++){let r=s[e];i.texSubImage2D(r,0,0,0,l,h,t[e])}e.mipmap&&i.generateMipmap(e.target),this._engine._bindTexture(e.target,null),r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1)}setCubePixelsData(e,t,r,a){let i=this._gl;const s=[i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z,i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y];let n=e.target,_=e.internalFormat,l=e.format,h=e.type,o=e.width,d=e.height,u=e.mipmapCount,c=o%4==0;if(r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0),c||i.pixelStorei(i.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),i.texStorage2D(n,u,_,o,d),t){for(let e=0;e<s.length;e++){let r=s[e];i.texSubImage2D(r,0,0,0,o,d,l,h,t[e])}e.mipmap&&i.generateMipmap(e.target)}this._engine._bindTexture(e.target,null),e.gpuMemory=this.getGLtexMemory(e),r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1),c||i.pixelStorei(i.UNPACK_ALIGNMENT,4)}setCubeKTXData(e,t){let r=this._gl;const a=[r.TEXTURE_CUBE_MAP_POSITIVE_X,r.TEXTURE_CUBE_MAP_NEGATIVE_X,r.TEXTURE_CUBE_MAP_POSITIVE_Y,r.TEXTURE_CUBE_MAP_NEGATIVE_Y,r.TEXTURE_CUBE_MAP_POSITIVE_Z,r.TEXTURE_CUBE_MAP_NEGATIVE_Z];let i=e.target,s=e.internalFormat,n=e.format,_=e.type;e.mipmapCount;let l=e.width,h=e.height;e.maxMipmapLevel=t.mipmapCount-1;let o=t.source,d=t.compress,u=l,c=h,f=t.headerOffset+t.bytesOfKeyValueData,m=l%4==0&&h%4==0;m||r.pixelStorei(r.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),d||r.texStorage2D(i,t.mipmapCount,s,l,h);let p=0;for(let e=0;e<t.mipmapCount;e++){let i=new Int32Array(o,f,1)[0];f+=4;for(let l=0;l<6;l++){let h=a[l];if(d){let t=new Uint8Array(o,f,i);r.compressedTexImage2D(h,e,s,u,c,0,t),p+=t.byteLength}else{let a=this.getFormatPixelsParams(t.format),s=i/a.typedSize,l=new a.dataTypedCons(o,f,s);r.texSubImage2D(h,e,0,0,u,c,n,_,l),p+=l.byteLength}f+=i,f+=3-(i+3)%4}u=Math.max(1,.5*u),c=Math.max(1,.5*c)}e.gpuMemory=p,this._engine._bindTexture(e.target,null),m||r.pixelStorei(r.UNPACK_ALIGNMENT,4)}getCubeKTXRGBMData(e,t){let r=this._gl;const a=[r.TEXTURE_CUBE_MAP_POSITIVE_X,r.TEXTURE_CUBE_MAP_NEGATIVE_X,r.TEXTURE_CUBE_MAP_POSITIVE_Y,r.TEXTURE_CUBE_MAP_NEGATIVE_Y,r.TEXTURE_CUBE_MAP_POSITIVE_Z,r.TEXTURE_CUBE_MAP_NEGATIVE_Z];let i=e.target,s=e.internalFormat,n=e.format,_=e.type,l=e.mipmapCount,h=e.width,o=e.height;e.maxMipmapLevel=l-1;let d=t.source,u=t.compress,c=h,f=o,m=t.headerOffset+t.bytesOfKeyValueData,p=h%4==0&&o%4==0;p||r.pixelStorei(r.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),u||r.texStorage2D(i,t.mipmapCount,s,h,o);let g=0;for(let e=0;e<t.mipmapCount;e++){let i=new Int32Array(d,m,1)[0];m+=4;for(let s=0;s<6;s++){let l=a[s],h=this.getFormatPixelsParams(t.format),o=i/h.typedSize,u=new h.dataTypedCons(d,m,o);r.texSubImage2D(l,e,0,0,c,f,n,_,u),g+=u.byteLength}m+=i,m+=3-(i+3)%4}c=Math.max(1,.5*c),f=Math.max(1,.5*f),e.gpuMemory=g,this._engine._bindTexture(e.target,null),p||r.pixelStorei(r.UNPACK_ALIGNMENT,4)}setTextureCompareMode(e,r){let a=this._gl;switch(r){case t.TextureCompareMode.LEQUAL:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.LEQUAL),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.GEQUAL:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.GEQUAL),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.LESS:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.LESS),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.GREATER:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.GREATER),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.EQUAL:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.EQUAL),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.NOTEQUAL:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.NOTEQUAL),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.ALWAYS:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.ALWAYS),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.NEVER:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.NEVER),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case t.TextureCompareMode.None:default:e._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.LEQUAL),e._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.NONE)}return r}createRenderbuffer(e,t,r,a){let i=this._gl,s=i.createRenderbuffer();return i.bindRenderbuffer(i.RENDERBUFFER,s),a>1?i.renderbufferStorageMultisample(i.RENDERBUFFER,a,r,e,t):i.renderbufferStorage(i.RENDERBUFFER,r,e,t),i.bindRenderbuffer(i.RENDERBUFFER,null),s}createRenderTextureInternal(e,r,a,i,s,n){s=s&&this.supportGenerateMipmap(i);let _=this.isSRGBFormat(i)||n&&this.supportSRGB(i,s),l=this.getTarget(e),h=new U(this._engine,l,r,a,1,e,s,_,1),o=this.glRenderTextureParam(i,_);h.internalFormat=o.internalFormat,h.format=o.format,h.type=o.type;let d=h.internalFormat;h.format,h.type;let u=this._gl;return this._engine._bindTexture(h.target,h.resource),u.texStorage2D(l,h.mipmapCount,d,r,a),this._engine._bindTexture(h.target,null),i!=t.RenderTargetFormat.DEPTH_16&&i!=t.RenderTargetFormat.DEPTH_32&&i!=t.RenderTargetFormat.DEPTHSTENCIL_24_8||(h.filterMode=t.FilterMode.Point),h}createRenderTargetInternal(e,r,a,i,s,n,_,l){let h=this.createRenderTextureInternal(t.TextureDimension.Tex2D,e,r,a,s,n),o=new I(this._engine,a,i,!1,h.mipmap,_);o.gpuMemory=this.getGLRTTexMemory(e,r,a,i,s,_,!1),o._textures.push(h);let d=o._gl;if(o._samples>1){let t=o._msaaFramebuffer,s=this.glRenderBufferParam(a,n),_=o._msaaRenderbuffer=this.createRenderbuffer(e,r,s.internalFormat,o._samples);d.bindFramebuffer(d.FRAMEBUFFER,t),d.framebufferRenderbuffer(d.FRAMEBUFFER,s.attachment,d.RENDERBUFFER,_);let l=this.glRenderBufferParam(i,!1);if(l){let t=this.createRenderbuffer(e,r,l.internalFormat,o._samples);o._depthbuffer=t,d.framebufferRenderbuffer(d.FRAMEBUFFER,l.attachment,d.RENDERBUFFER,t)}d.bindFramebuffer(d.FRAMEBUFFER,z._lastFrameBuffer_WebGLOBJ);let u=o._framebuffer;d.bindFramebuffer(d.FRAMEBUFFER,u);let c=this.glRenderTargetAttachment(a);d.framebufferTexture2D(d.FRAMEBUFFER,c,d.TEXTURE_2D,h.resource,0),d.bindFramebuffer(d.FRAMEBUFFER,z._lastFrameBuffer_WebGLOBJ)}else{let t=o._framebuffer;d.bindFramebuffer(d.FRAMEBUFFER,t);let s=this.glRenderTargetAttachment(a);d.framebufferTexture2D(d.FRAMEBUFFER,s,d.TEXTURE_2D,h.resource,0);let n=this.glRenderBufferParam(i,!1);if(n){let t=this.createRenderbuffer(e,r,n.internalFormat,o._samples);o._depthbuffer=t,d.framebufferRenderbuffer(d.FRAMEBUFFER,n.attachment,d.RENDERBUFFER,t)}d.bindFramebuffer(d.FRAMEBUFFER,z._lastFrameBuffer_WebGLOBJ)}return o}createRenderTargetCubeInternal(e,r,a,i,s,n){let _=this.createRenderTextureCubeInternal(t.TextureDimension.Cube,e,r,i,s),l=new I(this._engine,r,a,!0,_.mipmap,n);l.gpuMemory=this.getGLRTTexMemory(e,e,r,a,i,n,!0),l.colorFormat=r,l.depthStencilFormat=a,l._textures.push(_),l.isSRGB=s;let h=l._gl;if(l._samples>1){let t=l._msaaFramebuffer,i=this.glRenderBufferParam(r,!1),s=l._msaaRenderbuffer=this.createRenderbuffer(e,e,i.internalFormat,l._samples);h.bindFramebuffer(h.FRAMEBUFFER,t),h.framebufferRenderbuffer(h.FRAMEBUFFER,i.attachment,h.RENDERBUFFER,s);let n=this.glRenderBufferParam(a,!1);if(n){let t=this.createRenderbuffer(e,e,n.internalFormat,l._samples);l._depthbuffer=t,h.framebufferRenderbuffer(h.FRAMEBUFFER,n.attachment,h.RENDERBUFFER,t)}h.bindFramebuffer(h.FRAMEBUFFER,z._lastFrameBuffer_WebGLOBJ)}else{let t=l._framebuffer;h.bindFramebuffer(h.FRAMEBUFFER,t);let r=this.glRenderBufferParam(a,!1);if(r){let t=this.createRenderbuffer(e,e,r.internalFormat,l._samples);l._depthbuffer=t,h.framebufferRenderbuffer(h.FRAMEBUFFER,r.attachment,h.RENDERBUFFER,t)}h.bindFramebuffer(h.FRAMEBUFFER,z._lastFrameBuffer_WebGLOBJ)}return l}createRenderTextureCubeInternal(e,t,r,a,i){a=a&&this.supportGenerateMipmap(r);let s=this.isSRGBFormat(r)||i&&this.supportSRGB(r,a),n=this.getTarget(e),_=new U(this._engine,n,t,t,1,e,a,s,1),l=this.glRenderTextureParam(r,s);_.internalFormat=l.internalFormat,_.format=l.format,_.type=l.type;let h=_.internalFormat;_.format,_.type;let o=this._gl;return this._engine._bindTexture(_.target,_.resource),o.texStorage2D(n,_.mipmapCount,h,t,t),this._engine._bindTexture(_.target,null),_}bindRenderTarget(e,t=0){this.currentActiveRT&&this.unbindRenderTarget(this.currentActiveRT);let r=this._gl;if(e._isCube){let a=e._framebuffer;r.bindFramebuffer(r.FRAMEBUFFER,a);let i=e._textures[0];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_CUBE_MAP_POSITIVE_X+t,i.resource,0)}if(e._samples>1)r.bindFramebuffer(r.FRAMEBUFFER,e._msaaFramebuffer);else{let t=e._framebuffer;r.bindFramebuffer(r.FRAMEBUFFER,t)}this.currentActiveRT=e}unbindRenderTarget(e){let t=this._gl;if(e&&e._samples>1){t.bindFramebuffer(t.READ_FRAMEBUFFER,e._msaaFramebuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e._framebuffer);let r=e._textures[0],a=t.COLOR_BUFFER_BIT;e._depthTexture&&(a|=t.DEPTH_BUFFER_BIT),t.blitFramebuffer(0,0,r.width,r.height,0,0,r.width,r.height,a,t.NEAREST)}e&&e._generateMipmap&&e._textures.forEach(e=>{let r=e.target;this._engine._bindTexture(r,e.resource),t.generateMipmap(r),this._engine._bindTexture(r,null)}),t.bindFramebuffer(t.FRAMEBUFFER,z._lastFrameBuffer_WebGLOBJ),this.currentActiveRT=z._lastFrameBuffer}}class v extends G{constructor(e,r,a){super(e),this._byteLength=0,this._glTargetType=r,this._glBufferUsageType=a,this._getGLTarget(this._glTargetType),this._getGLUsage(this._glBufferUsageType),this._glBuffer=this._gl.createBuffer(),z.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.RC_GPUBuffer,1)}_getGLUsage(e){switch(e){case t.BufferUsage.Static:this._glUsage=this._gl.STATIC_DRAW;break;case t.BufferUsage.Dynamic:this._glUsage=this._gl.DYNAMIC_DRAW;break;case t.BufferUsage.Stream:this._glUsage=this._gl.STREAM_DRAW;break;default:console.error("usage is not standard")}}_getGLTarget(e){switch(e){case t.BufferTargetType.ARRAY_BUFFER:this._glTarget=this._gl.ARRAY_BUFFER;break;case t.BufferTargetType.UNIFORM_BUFFER:this._glTarget=this._gl.UNIFORM_BUFFER;break;case t.BufferTargetType.ELEMENT_ARRAY_BUFFER:this._glTarget=this._gl.ELEMENT_ARRAY_BUFFER}}_memorychange(e){this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.M_GPUBuffer,-this._byteLength+e),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.M_GPUMemory,-this._byteLength+e)}bindBuffer(){return this._engine._getbindBuffer(this._glTargetType)!=this&&(this._gl.bindBuffer(this._glTarget,this._glBuffer),this._engine._setbindBuffer(this._glTargetType,this),!0)}unbindBuffer(){this._engine._getbindBuffer(this._glTargetType)==this&&(this._gl.bindBuffer(this._glTarget,null),this._engine._setbindBuffer(this._glTargetType,null))}orphanStorage(){this.bindBuffer(),this.setDataLength(this._byteLength)}setDataLength(e){let t=this._gl;this.bindBuffer(),this._memorychange(e),this._byteLength=e,t.bufferData(this._glTarget,this._byteLength,this._glUsage),this.unbindBuffer()}setData(e,r){let a=this._gl;this.bindBuffer(),a.bufferSubData(this._glTarget,r,e),z.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_GeometryBufferUploadCount,1),this.unbindBuffer()}setDataEx(e,r,a){let i=this._gl;this.bindBuffer(),i.bufferSubData(this._glTarget,r,e,0,a),z.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_GeometryBufferUploadCount,1),this.unbindBuffer()}bindBufferBase(e){const t=this._gl;let r=this._engine._uboBindingMap[e];r&&r.buffer!=this._glBuffer&&(this._engine._getbindBuffer(this._glTargetType)!=this&&this._engine._setbindBuffer(this._glTargetType,this),t.bindBufferBase(this._glTarget,e,this._glBuffer),r.buffer=this._glBuffer,r.offset=0,r.size=this._byteLength)}bindBufferRange(e,t,r){const a=this._gl;let i=this._engine._uboBindingMap[e];i&&(i.buffer==this._glBuffer&&i.offset==t&&i.size==r||(this._engine._getbindBuffer(this._glTargetType)!=this&&this._engine._setbindBuffer(this._glTargetType,this),a.bindBufferRange(this._glTarget,e,this._glBuffer,t,r),i.buffer=this._glBuffer,i.offset=t,i.size=r))}resizeBuffer(e){this.bindBuffer();const t=this._gl;this._byteLength=e,t.bufferData(this._glTarget,this._byteLength,this._glUsage)}destroy(){super.destroy();const e=this._gl;z.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.RC_GPUBuffer,-1),e.deleteBuffer(this._glBuffer),this._memorychange(0),this._byteLength=0,this._engine=null,this._glBuffer=null,this._glTarget=null,this._glUsage=null,this._gl=null}}e.WebGLMode=void 0,(F=e.WebGLMode||(e.WebGLMode={}))[F.Auto=0]="Auto",F[F.WebGL2=1]="WebGL2",F[F.WebGL1=2]="WebGL1";class O{constructor(e){this._engine=e,this._gl=this._engine.gl,this._initParams()}_initParams(){const r=this._gl;this._glParamsData=new Map,this._glParamsData.set(t.RenderParams.Max_Active_Texture_Count,r.getParameter(r.MAX_VERTEX_TEXTURE_IMAGE_UNITS));const a=r.getParameter(r.MAX_VERTEX_UNIFORM_VECTORS),i=r.getParameter(r.MAX_FRAGMENT_UNIFORM_VECTORS);if(this._glParamsData.set(t.RenderParams.Max_Uniform_Count,Math.min(a,i)),this._glParamsData.set(t.RenderParams.MAX_Texture_Size,r.getParameter(r.MAX_TEXTURE_SIZE)),this._glParamsData.set(t.RenderParams.MAX_Texture_Image_Uint,r.getParameter(r.MAX_TEXTURE_IMAGE_UNITS)),this._engine.getCapable(t.RenderCapable.Texture_anisotropic)){const a=this._engine._supportCapatable.getExtension(e.WebGLExtension.EXT_texture_filter_anisotropic);this._glParamsData.set(t.RenderParams.Max_AnisoLevel_Count,r.getParameter(a.MAX_TEXTURE_MAX_ANISOTROPY_EXT))}this._engine.isWebGL2?this._glParamsData.set(t.RenderParams.SHADER_CAPAILITY_LEVEL,35):this._glParamsData.set(t.RenderParams.SHADER_CAPAILITY_LEVEL,30),this._glParamsData.set(t.RenderParams.FLOAT,r.FLOAT),this._glParamsData.set(t.RenderParams.UNSIGNED_BYTE,r.UNSIGNED_BYTE),this._glParamsData.set(t.RenderParams.UNSIGNED_SHORT,r.UNSIGNED_SHORT),this._glParamsData.set(t.RenderParams.BYTE,r.BYTE)}getParams(e){return this._glParamsData.get(e)}}class V extends G{constructor(t){super(t),this._engine.isWebGL2||(this._angleInstancedArrays=this._engine._supportCapatable.getExtension(e.WebGLExtension.ANGLE_instanced_arrays))}getMeshTopology(e){switch(e){case t.MeshTopology.Points:return this._gl.POINTS;case t.MeshTopology.Lines:return this._gl.LINES;case t.MeshTopology.LineLoop:return this._gl.LINE_LOOP;case t.MeshTopology.LineStrip:return this._gl.LINE_STRIP;case t.MeshTopology.Triangles:return this._gl.TRIANGLES;case t.MeshTopology.TriangleStrip:return this._gl.TRIANGLE_STRIP;case t.MeshTopology.TriangleFan:return this._gl.TRIANGLE_FAN}}getIndexType(e){switch(e){case t.IndexFormat.UInt8:return this._gl.UNSIGNED_BYTE;case t.IndexFormat.UInt16:return this._gl.UNSIGNED_SHORT;case t.IndexFormat.UInt32:return this._gl.UNSIGNED_INT}}drawElementsInstanced(e,r,a,i,s){this._engine.isWebGL2?this._gl.drawElementsInstanced(e,r,a,i,s):this._angleInstancedArrays.drawElementsInstancedANGLE(e,r,a,i,s),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_DrawCallCount,1),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_Instancing_DrawCallCount,1),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_TriangleCount,r/3*s)}drawArraysInstanced(e,r,a,i){this._engine.isWebGL2?this._gl.drawArraysInstanced(e,r,a,i):this._angleInstancedArrays.drawArraysInstancedANGLE(e,r,a,i),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_DrawCallCount,1),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_Instancing_DrawCallCount,1),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_TriangleCount,(a-2)*i)}drawArrays(e,r,a){this._gl.drawArrays(e,r,a),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_DrawCallCount,1),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_TriangleCount,a-2)}drawElements(e,r,a,i){this._gl.drawElements(e,r,a,i),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_DrawCallCount,1),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_TriangleCount,r/3)}drawElements2DTemp(e,r,a,i){e=this.getMeshTopology(e),a=this.getIndexType(a),this._gl.drawElements(e,r,a,i),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_DrawCallCount,1),this._engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_TriangleCount,r/3)}drawGeometryElement(e){e.bufferState.bind();let r=e.drawParams.elements,a=e.drawParams.length;switch(e.drawType){case t.DrawType.DrawArray:for(let t=0;t<a;t+=2)this.drawArrays(e._glmode,r[t],r[t+1]);break;case t.DrawType.DrawElement:for(let t=0;t<a;t+=2)this.drawElements(e._glmode,r[t+1],e._glindexFormat,r[t]);break;case t.DrawType.DrawArrayInstance:for(let t=0;t<a;t+=2)this.drawArraysInstanced(e._glmode,r[t],r[t+1],e.instanceCount);break;case t.DrawType.DrawElementInstance:for(let t=0;t<a;t+=2)this.drawElementsInstanced(e._glmode,r[t+1],e._glindexFormat,r[t],e.instanceCount)}}}class W{constructor(e){this._engine=e,this._gl=this._engine.gl}_initState(){this.setDepthFunc(t.CompareFunction.Less),this.setBlendEquationSeparate(t.BlendEquationSeparate.ADD,t.BlendEquationSeparate.ADD),this._blendEquation=t.BlendEquationSeparate.ADD,this._sFactor=t.BlendFactor.One,this._dFactor=t.BlendFactor.Zero,this._sFactorAlpha=t.BlendFactor.One,this._dFactorAlpha=t.BlendFactor.One}_getBlendFactor(e){const r=this._gl;switch(e){case t.BlendFactor.Zero:return r.ZERO;case t.BlendFactor.One:return r.ONE;case t.BlendFactor.SourceColor:return r.SRC_COLOR;case t.BlendFactor.OneMinusSourceColor:return r.ONE_MINUS_SRC_COLOR;case t.BlendFactor.DestinationColor:return r.DST_COLOR;case t.BlendFactor.OneMinusDestinationColor:return r.ONE_MINUS_DST_COLOR;case t.BlendFactor.SourceAlpha:return r.SRC_ALPHA;case t.BlendFactor.OneMinusSourceAlpha:return r.ONE_MINUS_SRC_ALPHA;case t.BlendFactor.DestinationAlpha:return r.DST_ALPHA;case t.BlendFactor.OneMinusDestinationAlpha:return r.ONE_MINUS_DST_ALPHA;case t.BlendFactor.SourceAlphaSaturate:return r.SRC_ALPHA_SATURATE;case t.BlendFactor.BlendColor:return r.CONSTANT_COLOR;case t.BlendFactor.OneMinusBlendColor:return r.ONE_MINUS_CONSTANT_COLOR}}_getBlendOperation(e){const r=this._gl;switch(e){case t.BlendEquationSeparate.ADD:return r.FUNC_ADD;case t.BlendEquationSeparate.SUBTRACT:return r.FUNC_SUBTRACT;case t.BlendEquationSeparate.REVERSE_SUBTRACT:return r.FUNC_REVERSE_SUBTRACT;default:throw"Unknow type"}}_getGLCompareFunction(e){const r=this._gl;switch(e){case t.CompareFunction.Never:return r.NEVER;case t.CompareFunction.Less:return r.LESS;case t.CompareFunction.Equal:return r.EQUAL;case t.CompareFunction.LessEqual:return r.LEQUAL;case t.CompareFunction.Greater:return r.GREATER;case t.CompareFunction.NotEqual:return r.NOTEQUAL;case t.CompareFunction.GreaterEqual:return r.GEQUAL;case t.CompareFunction.Always:return r.ALWAYS;default:return r.LEQUAL}}_getGLStencilOperation(e){const r=this._gl;switch(e){case t.StencilOperation.Keep:return r.KEEP;case t.StencilOperation.Zero:return r.ZERO;case t.StencilOperation.Replace:return r.REPLACE;case t.StencilOperation.IncrementSaturate:return r.INCR;case t.StencilOperation.DecrementSaturate:return r.DECR;case t.StencilOperation.Invert:return r.INVERT;case t.StencilOperation.IncrementWrap:return r.INCR_WRAP;case t.StencilOperation.DecrementWrap:return r.DECR_WRAP}}_getGLFrontfaceFactor(e){return e==t.CullMode.Front?this._gl.CCW:this._gl.CW}setDepthTest(e){e!==this._depthTest&&(this._depthTest=e,e?this._gl.enable(this._gl.DEPTH_TEST):this._gl.disable(this._gl.DEPTH_TEST))}setDepthMask(e){e!==this._depthMask&&(this._depthMask=e,this._gl.depthMask(e))}setDepthFunc(e){e!==this._depthFunc&&(this._depthFunc=e,this._gl.depthFunc(this._getGLCompareFunction(e)))}setStencilTest(e){e!==this._stencilTest&&(this._stencilTest=e,e?this._gl.enable(this._gl.STENCIL_TEST):this._gl.disable(this._gl.STENCIL_TEST))}setStencilWrite(e){this._stencilWrite=e}setStencilWriteMask(e){(e=this._stencilWrite?e:0)!==this._stencilWriteMask&&(this._stencilWriteMask=e,this._gl.stencilMask(e))}setStencilFunc(e,t,r){e==this._stencilFunc&&t==this._stencilRef&&r==this._stencilReadMask||(this._stencilFunc=e,this._stencilRef=t,this._stencilReadMask=r,this._gl.stencilFunc(this._getGLCompareFunction(e),t,r))}setstencilOp(e,t,r){this._stencilOp_fail==e&&this._stencilOp_zfail==t&&this._stencilOp_zpass==r||(this._stencilOp_fail=e,this._stencilOp_zfail=t,this._stencilOp_zpass=r,this._gl.stencilOp(this._getGLStencilOperation(e),this._getGLStencilOperation(t),this._getGLStencilOperation(r)))}setDepthBias(e){e!==this._depthBias&&(this._depthBias=e,e?this._gl.enable(this._gl.POLYGON_OFFSET_FILL):this._gl.disable(this._gl.POLYGON_OFFSET_FILL))}setDepthBiasFactor(e,t,r=0){e===this._depthBiasConstant&&t===this._depthBiasSlope&&r===this._depthBiasClamp||(this._depthBiasConstant=e,this._depthBiasSlope=t,this._depthBiasClamp=r,this._gl.polygonOffset(e,t))}setBlend(e){e!==this._blend&&(this._blend=e,e?this._gl.enable(this._gl.BLEND):this._gl.disable(this._gl.BLEND))}setBlendEquation(e){e!==this._blendEquation&&(this._blendEquation=e,this._blendEquationRGB=this._blendEquationAlpha=null,this._gl.blendEquation(this._getBlendOperation(e)))}setBlendEquationSeparate(e,t){e===this._blendEquationRGB&&t===this._blendEquationAlpha||(this._blendEquationRGB=e,this._blendEquationAlpha=t,this._blendEquation=null,this._gl.blendEquationSeparate(this._getBlendOperation(e),this._getBlendOperation(t)))}setBlendFunc(e,t,r=!1){(r||e!==this._sFactor||t!==this._dFactor)&&(this._sFactor=e,this._dFactor=t,this._sFactorRGB=null,this._dFactorRGB=null,this._sFactorAlpha=null,this._dFactorAlpha=null,this._gl.blendFunc(this._getBlendFactor(e),this._getBlendFactor(t)))}setBlendFuncSeperate(e,t,r,a){e===this._sFactorRGB&&t===this._dFactorRGB&&r===this._sFactorAlpha&&a===this._dFactorAlpha||(this._sFactorRGB=e,this._dFactorRGB=t,this._sFactorAlpha=r,this._dFactorAlpha=a,this._sFactor=null,this._dFactor=null,this._gl.blendFuncSeparate(this._getBlendFactor(e),this._getBlendFactor(t),this._getBlendFactor(r),this._getBlendFactor(a)))}setCullFace(e){e!==this._cullFace&&(this._cullFace=e,e?this._gl.enable(this._gl.CULL_FACE):this._gl.disable(this._gl.CULL_FACE))}setFrontFace(e){e!==this._frontFace&&(this._frontFace=e,this._gl.frontFace(this._getGLFrontfaceFactor(e)))}}class X extends G{constructor(e,t,r,a){super(e),this._vs=t,this._ps=r,this._attributeMap=a,this._uniformMap=[],this._create()}_create(){z._lastShaderError=null,z.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_ShaderCompile,1);let e=performance.now();const r=this._gl;if(z.instance.lost)return;let a,i=this._program=r.createProgram();if(this._vshader=this._createShader(r,this._vs,r.VERTEX_SHADER),r.getShaderParameter(this._vshader,r.COMPILE_STATUS)||(a=r.getShaderInfoLog(this._vshader)),this._pshader=this._createShader(r,this._ps,r.FRAGMENT_SHADER),r.getShaderParameter(this._pshader,r.COMPILE_STATUS)||(a&&(a+="\n"),a+=r.getShaderInfoLog(this._pshader)),r.attachShader(i,this._vshader),r.attachShader(i,this._pshader),a)return void(z._lastShaderError=a);for(var s in this._attributeMap)r.bindAttribLocation(i,this._attributeMap[s][0],s);if(r.linkProgram(i),!r.getProgramParameter(i,r.LINK_STATUS))return void(z._lastShaderError=r.getProgramInfoLog(i));const n=r.getProgramParameter(i,r.ACTIVE_UNIFORMS);let _,l;for(this.useProgram(),this._curActTexIndex=0,l=0;l<n;l++){var h=r.getActiveUniform(i,l),o=h.name;let e=r.getUniformLocation(i,o);(e||0==e)&&(_=new t.ShaderVariable,_.location=e,o.indexOf("[0]")>0?(_.name=o=o.substr(0,o.length-3),_.isArray=!0):(_.name=o,_.isArray=!1),_.type=h.type,this._addShaderUnifiormFun(_),this._uniformMap.push(_),_.dataOffset=this._engine.propertyNameToID(o))}if(this._engine.isWebGL2){const e=r;this._uniformObjectMap={};var d=r.getProgramParameter(i,r.ACTIVE_UNIFORM_BLOCKS);for(l=0;l<d;l++){var u=e.getActiveUniformBlockName(this._program,l);_=new t.ShaderVariable,_.name=u,_.isArray=!1,_.type=r.UNIFORM_BUFFER,_.dataOffset=this._engine.propertyNameToID(u);let a=_.location=e.getUniformBlockIndex(i,u),s=l;e.uniformBlockBinding(this._program,a,s),this._uniformObjectMap[_.name]=_,this._uniformMap.push(_),this._addShaderUnifiormFun(_)}}z.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.T_ShaderCompile,performance.now()-e|0),this._complete=!0}_createShader(e,t,r){let a=e.createShader(r);return e.shaderSource(a,t),e.compileShader(a),a}_addShaderUnifiormFun(e){var t=this._gl;e.caller=this;var r=e.isArray;switch(e.type){case t.BOOL:e.fun=this._uniform1i,e.uploadedValue=new Array(1);break;case t.INT:e.fun=r?this._uniform1iv:this._uniform1i,e.uploadedValue=new Array(1);break;case t.FLOAT:e.fun=r?this._uniform1fv:this._uniform1f,e.uploadedValue=new Array(1);break;case t.FLOAT_VEC2:e.fun=r?this._uniform_vec2v:this._uniform_vec2,e.uploadedValue=new Array(2);break;case t.FLOAT_VEC3:e.fun=r?this._uniform_vec3v:this._uniform_vec3,e.uploadedValue=new Array(3);break;case t.FLOAT_VEC4:e.fun=r?this._uniform_vec4v:this._uniform_vec4,e.uploadedValue=new Array(4);break;case t.FLOAT_MAT2:e.fun=this._uniformMatrix2fv;break;case t.FLOAT_MAT3:e.fun=r?this._uniformMatrix3fv:this._uniformMatrix3f;break;case t.FLOAT_MAT4:e.fun=r?this._uniformMatrix4fv:this._uniformMatrix4f;break;case t.SAMPLER_2D:case t.SAMPLER_2D_SHADOW:t.uniform1i(e.location,this._curActTexIndex),e.textureID=this._engine._glTextureIDParams[this._curActTexIndex++],e.fun=this._uniform_sampler2D;break;case t.SAMPLER_2D_ARRAY:t.uniform1i(e.location,this._curActTexIndex),e.textureID=this._engine._glTextureIDParams[this._curActTexIndex++],e.fun=this._uniform_sampler2DArray;break;case 35679:t.uniform1i(e.location,this._curActTexIndex),e.textureID=this._engine._glTextureIDParams[this._curActTexIndex++],e.fun=this._uniform_sampler3D;break;case t.SAMPLER_CUBE:t.uniform1i(e.location,this._curActTexIndex),e.textureID=this._engine._glTextureIDParams[this._curActTexIndex++],e.fun=this._uniform_samplerCube;break;case t.UNIFORM_BUFFER:e.fun=this._uniform_UniformBuffer;break;default:z._lastShaderError=`unknown uniform type (${e.type})`}}getUniformMap(){return this._uniformMap}bind(){return this.useProgram()}useProgram(){return this._engine._glUseProgram!==this&&(this._gl.useProgram(this._program),this._engine._glUseProgram=this,z.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_SetRenderPassCount,1),!0)}_uniform1f(e,t){var r=e.uploadedValue;return r[0]!==t?(this._gl.uniform1f(e.location,r[0]=t),1):0}_uniform1fv(e,t){if(t.length<4){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]||r[3]!==t[3]?(this._gl.uniform1fv(e.location,t),r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],1):0}return this._gl.uniform1fv(e.location,t),1}_uniform_vec2(e,t){var r=e.uploadedValue;return r[0]!==t.x||r[1]!==t.y?(this._gl.uniform2f(e.location,r[0]=t.x,r[1]=t.y),1):0}_uniform_vec2v(e,t){if(t.length<2){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]||r[3]!==t[3]?(this._gl.uniform2fv(e.location,t),r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],1):0}return this._gl.uniform2fv(e.location,t),1}_uniform_vec3(e,t){var r=e.uploadedValue;return r[0]!==t.x||r[1]!==t.y||r[2]!==t.z?(this._gl.uniform3f(e.location,r[0]=t.x,r[1]=t.y,r[2]=t.z),1):0}_uniform_vec3v(e,t){return this._gl.uniform3fv(e.location,t),1}_uniform_vec4(e,t){var r=e.uploadedValue;return r[0]!==t.x||r[1]!==t.y||r[2]!==t.z||r[3]!==t.w?(this._gl.uniform4f(e.location,r[0]=t.x,r[1]=t.y,r[2]=t.z,r[3]=t.w),1):0}_uniform_vec4v(e,t){return this._gl.uniform4fv(e.location,t),1}_uniformMatrix2fv(e,t){return this._gl.uniformMatrix2fv(e.location,!1,t),1}_uniformMatrix3f(e,t){return this._gl.uniformMatrix3fv(e.location,!1,t.elements),1}_uniformMatrix3fv(e,t){return this._gl.uniformMatrix3fv(e.location,!1,t),1}_uniformMatrix4f(e,t){var r=t.elements;return this._gl.uniformMatrix4fv(e.location,!1,r),1}_uniformMatrix4fv(e,t){return this._gl.uniformMatrix4fv(e.location,!1,t),1}_uniform1i(e,t){var r=e.uploadedValue;return r[0]!==t?(this._gl.uniform1i(e.location,r[0]=t),1):0}_uniform1iv(e,t){return this._gl.uniform1iv(e.location,t),1}_uniform_ivec2(e,t){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]?(this._gl.uniform2i(e.location,r[0]=t[0],r[1]=t[1]),1):0}_uniform_ivec2v(e,t){return this._gl.uniform2iv(e.location,t),1}_uniform_vec3i(e,t){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]?(this._gl.uniform3i(e.location,r[0]=t[0],r[1]=t[1],r[2]=t[2]),1):0}_uniform_vec3vi(e,t){return this._gl.uniform3iv(e.location,t),1}_uniform_vec4i(e,t){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]||r[3]!==t[3]?(this._gl.uniform4i(e.location,r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3]),1):0}_uniform_vec4vi(e,t){return this._gl.uniform4iv(e.location,t),1}_uniform_sampler2D(e,r){var a=r?r._getSource():t.Texture2D.errorTexture._getSource(),i=this._gl;return this._bindTexture(e.textureID,i.TEXTURE_2D,a),0}_uniform_sampler2DArray(e,r){var a=r?r._getSource():t.Texture2D.errorTexture._getSource(),i=this._gl;return this._bindTexture(e.textureID,i.TEXTURE_2D_ARRAY,a),0}_uniform_sampler3D(e,r){var a=r?r._getSource():t.Texture2D.errorTexture._getSource(),i=this._gl;return this._bindTexture(e.textureID,i.TEXTURE_3D,a),0}_uniform_samplerCube(e,r){var a=r?r._getSource():t.TextureCube.errorTexture._getSource(),i=this._gl;return this._bindTexture(e.textureID,i.TEXTURE_CUBE_MAP,a),0}_uniform_UniformBuffer(e,t){return t.bind(e.location),1}_bindTexture(e,t,r){const a=this._gl;this._engine._activedTextureID!==e&&(a.activeTexture(e),this._engine._activedTextureID=e);const i=this._engine._activedTextureID-this._gl.TEXTURE0;this._engine._activeTextures[i]!==r&&(a.bindTexture(t,r),this._engine._activeTextures[i]=r)}destroy(){super.destroy();const e=this._gl;e.deleteShader(this._vshader),e.deleteShader(this._pshader),e.deleteProgram(this._program),this._vshader=null,this._pshader=null,this._program=null,this._attributeMap=null,this._uniformMap=null,this._uniformObjectMap=null,this._gl=null,this._engine=null}}class k extends G{constructor(t){super(t),this._vertexDeclaration=[],t.isWebGL2||(this._vaoExt=t._supportCapatable.getExtension(e.WebGLExtension.OES_vertex_array_object)),this._vao=this.createVertexArray(),this._angleInstancedArrays=this._engine._supportCapatable.getExtension(e.WebGLExtension.ANGLE_instanced_arrays)}createVertexArray(){return this._engine.isWebGL2?this._gl.createVertexArray():this._vaoExt.createVertexArrayOES()}deleteVertexArray(){this._engine.isWebGL2?this._gl.deleteVertexArray(this._vao):this._vaoExt.deleteVertexArrayOES(this._vao)}bindVertexArray(){this._engine._GLBindVertexArray!=this&&(this._engine.isWebGL2?this._gl.bindVertexArray(this._vao):this._vaoExt.bindVertexArrayOES(this._vao),this._engine._GLBindVertexArray=this)}unbindVertexArray(){this._engine.isWebGL2?this._gl.bindVertexArray(null):this._vaoExt.bindVertexArrayOES(null),this._engine._GLBindVertexArray=null}isVertexArray(){this._engine.isWebGL2?this._gl.isVertexArray(this._vao):this._vaoExt.isVertexArrayOES(this._vao)}applyVertexBuffer(e){if(this.clearVAO(),this._vertexBuffers=e,this._engine._GLBindVertexArray!=this)throw"BufferState: must call bind() function first.";this._vertexDeclaration.length=e.length;var t=0;e.forEach(e=>{var r=e._shaderValues;for(var a in this._vertexDeclaration[t++]=e._shaderValues,e.bind(),r){var i=parseInt(a),s=r[a];this._gl.enableVertexAttribArray(i),this._gl.vertexAttribPointer(i,s.elementCount,s.elementType,!!s.normalized,s.vertexStride,s.elementOffset),e.instanceBuffer&&this.vertexAttribDivisor(i,1)}})}clearVAO(){for(let a=0,i=this._vertexDeclaration.length;a<i;a++){var e=this._vertexDeclaration[a];for(var t in e){var r=parseInt(t);this._gl.disableVertexAttribArray(r)}}}applyIndexBuffer(e){if(null!=e){if(this._engine._GLBindVertexArray!=this)throw"BufferState: must call bind() function first.";this._bindedIndexBuffer!==e&&(e._glBuffer.bindBuffer(),this._bindedIndexBuffer=e)}}vertexAttribDivisor(e,t){this._engine.isWebGL2?this._gl.vertexAttribDivisor(e,t):this._angleInstancedArrays.vertexAttribDivisorANGLE(e,t)}destroy(){super.destroy(),this._gl,this.deleteVertexArray(),this._gl=null,this._engine=null}}!function(){var e={};function t(t,r){var a;e[t]=!0,void 0!==r&&(a=r,window.console&&window.console.error&&window.console.error(a))}var r=function e(t){var r=t.gl;this.ext=t,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(t.maxVertexAttribs);for(var a=0;a<this.attribs.length;a++){var i=new e.VertexAttrib(r);this.attribs[a]=i}this.maxAttrib=0};(r.VertexAttrib=function(e){this.enabled=!1,this.buffer=null,this.size=4,this.type=e.FLOAT,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()}).prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};var a=function(t){var r=this;this.gl=t,function(t){var r=t.getError;t.getError=function(){var a;do{(a=r.apply(t))!=t.NO_ERROR&&(e[a]=!0)}while(a!=t.NO_ERROR);for(var i in e)if(e[i])return delete e[i],parseInt(i);return t.NO_ERROR}}(t);var a=this.original={getParameter:t.getParameter,enableVertexAttribArray:t.enableVertexAttribArray,disableVertexAttribArray:t.disableVertexAttribArray,bindBuffer:t.bindBuffer,getVertexAttrib:t.getVertexAttrib,vertexAttribPointer:t.vertexAttribPointer};t.getParameter=function(e){return e==r.VERTEX_ARRAY_BINDING_OES?r.currentVertexArrayObject==r.defaultVertexArrayObject?null:r.currentVertexArrayObject:a.getParameter.apply(this,arguments)},t.enableVertexAttribArray=function(e){var t=r.currentVertexArrayObject;return t.maxAttrib=Math.max(t.maxAttrib,e),t.attribs[e].enabled=!0,a.enableVertexAttribArray.apply(this,arguments)},t.disableVertexAttribArray=function(e){var t=r.currentVertexArrayObject;return t.maxAttrib=Math.max(t.maxAttrib,e),t.attribs[e].enabled=!1,a.disableVertexAttribArray.apply(this,arguments)},t.bindBuffer=function(e,i){switch(e){case t.ARRAY_BUFFER:r.currentArrayBuffer=i;break;case t.ELEMENT_ARRAY_BUFFER:r.currentVertexArrayObject.elementArrayBuffer=i}return a.bindBuffer.apply(this,arguments)},t.getVertexAttrib=function(e,i){var s=r.currentVertexArrayObject.attribs[e];switch(i){case t.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:return s.buffer;case t.VERTEX_ATTRIB_ARRAY_ENABLED:return s.enabled;case t.VERTEX_ATTRIB_ARRAY_SIZE:return s.size;case t.VERTEX_ATTRIB_ARRAY_STRIDE:return s.stride;case t.VERTEX_ATTRIB_ARRAY_TYPE:return s.type;case t.VERTEX_ATTRIB_ARRAY_NORMALIZED:return s.normalized;default:return a.getVertexAttrib.apply(this,arguments)}},t.vertexAttribPointer=function(e,t,i,s,n,_){var l=r.currentVertexArrayObject;l.maxAttrib=Math.max(l.maxAttrib,e);var h=l.attribs[e];return h.buffer=r.currentArrayBuffer,h.size=t,h.type=i,h.normalized=s,h.stride=n,h.offset=_,h.recache(),a.vertexAttribPointer.apply(this,arguments)},t.instrumentExtension&&t.instrumentExtension(this,"OES_vertex_array_object"),t.canvas.addEventListener("webglcontextrestored",function(){var e;e="OESVertexArrayObject emulation library context restored",window.console&&window.console.log&&window.console.log(e),r.reset_()},!0),this.reset_()};a.prototype.VERTEX_ARRAY_BINDING_OES=34229,a.prototype.reset_=function(){if(void 0!==this.vertexArrayObjects)for(var e=0;e<this.vertexArrayObjects.length;++e)this.vertexArrayObjects.isAlive=!1;var t=this.gl;this.maxVertexAttribs=t.getParameter(t.MAX_VERTEX_ATTRIBS),this.defaultVertexArrayObject=new r(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)},a.prototype.createVertexArrayOES=function(){var e=new r(this);return this.vertexArrayObjects.push(e),e},a.prototype.deleteVertexArrayOES=function(e){e.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(e),1),this.currentVertexArrayObject==e&&this.bindVertexArrayOES(null)},a.prototype.isVertexArrayOES=function(e){return!!(e&&e instanceof r&&e.hasBeenBound&&e.ext==this)},a.prototype.bindVertexArrayOES=function(e){var r=this.gl;if(!e||e.isAlive){var a=this.original,i=this.currentVertexArrayObject;this.currentVertexArrayObject=e||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;var s=this.currentVertexArrayObject;if(i!=s){i&&s.elementArrayBuffer==i.elementArrayBuffer||a.bindBuffer.call(r,r.ELEMENT_ARRAY_BUFFER,s.elementArrayBuffer);for(var n=this.currentArrayBuffer,_=Math.max(i?i.maxAttrib:0,s.maxAttrib),l=0;l<=_;l++){var h=s.attribs[l],o=i?i.attribs[l]:null;if(i&&h.enabled==o.enabled||(h.enabled?a.enableVertexAttribArray.call(r,l):a.disableVertexAttribArray.call(r,l)),h.enabled){var d=!1;i&&h.buffer==o.buffer||(n!=h.buffer&&(a.bindBuffer.call(r,r.ARRAY_BUFFER,h.buffer),n=h.buffer),d=!0),(d||h.cached!=o.cached)&&a.vertexAttribPointer.call(r,l,h.size,h.type,h.normalized,h.stride,h.offset)}}this.currentArrayBuffer!=n&&a.bindBuffer.call(r,r.ARRAY_BUFFER,this.currentArrayBuffer)}}else t(r.INVALID_OPERATION,"bindVertexArrayOES: attempt to bind deleted arrayObject")},window._setupVertexArrayObject=function(e){var t=e.getSupportedExtensions;e.getSupportedExtensions=function(){var e=t.call(this)||[];return e.indexOf("OES_vertex_array_object")<0&&e.push("OES_vertex_array_object"),e};var r=e.getExtension;e.getExtension=function(e){var t=r.call(this,e);return t||("OES_vertex_array_object"!==e?null:(this.__OESVertexArrayObject||(console.log("Setup OES_vertex_array_object polyfill"),this.__OESVertexArrayObject=new a(this)),this.__OESVertexArrayObject))}}}();const H=["","WEBKIT_","MOZ_"];class Y{constructor(e){this._gl=e.gl,this.initExtension(e.isWebGL2),this.initCapable(e.isWebGL2)}initCapable(r){this._capabilityMap=new Map;let a=r||!!this.getExtension(e.WebGLExtension.OES_element_index_uint);this._capabilityMap.set(t.RenderCapable.Element_Index_Uint32,a),this._capabilityMap.set(t.RenderCapable.Element_Index_Uint8,!0),a=r||!!this.getExtension(e.WebGLExtension.OES_texture_float),this._capabilityMap.set(t.RenderCapable.TextureFormat_R32G32B32A32,a),a=r||!!this.getExtension(e.WebGLExtension.OES_texture_half_float),this._capabilityMap.set(t.RenderCapable.TextureFormat_R16G16B16A16,a),a=!!this.getExtension(e.WebGLExtension.EXT_texture_filter_anisotropic),this._capabilityMap.set(t.RenderCapable.Texture_anisotropic,a),a=r?!!this.getExtension(e.WebGLExtension.EXT_color_buffer_float)||!!this.getExtension(e.WebGLExtension.EXT_color_buffer_half_float):!(!this.getExtension(e.WebGLExtension.OES_texture_half_float)&&!this.getExtension(e.WebGLExtension.EXT_color_buffer_half_float)||!this.getExtension(e.WebGLExtension.OES_texture_half_float_linear)),this._capabilityMap.set(t.RenderCapable.RenderTextureFormat_R16G16B16A16,a),a=r?!!this.getExtension(e.WebGLExtension.EXT_color_buffer_float)&&!!this.getExtension(e.WebGLExtension.OES_texture_float_linear):!!this.getExtension(e.WebGLExtension.OES_texture_float)&&!!this.getExtension(e.WebGLExtension.OES_texture_float_linear),this._capabilityMap.set(t.RenderCapable.RenderTextureFormat_R32G32B32A32,a),a=r||!!this.getExtension(e.WebGLExtension.WEBGL_depth_texture),this._capabilityMap.set(t.RenderCapable.RenderTextureFormat_Depth,a),a=r,this._capabilityMap.set(t.RenderCapable.RenderTextureFormat_ShadowMap,a),a=r||!!this.getExtension(e.WebGLExtension.OES_vertex_array_object),this._capabilityMap.set(t.RenderCapable.Vertex_VAO,a),a=r||!!this.getExtension(e.WebGLExtension.ANGLE_instanced_arrays),this._capabilityMap.set(t.RenderCapable.DrawElement_Instance,a),a=r||!!this.getExtension(e.WebGLExtension.EXT_shader_texture_lod),this._capabilityMap.set(t.RenderCapable.Shader_TextureLod,a),a=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_s3tc),this._capabilityMap.set(t.RenderCapable.COMPRESS_TEXTURE_S3TC,a),a=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_s3tc_srgb),this._capabilityMap.set(t.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB,a),a=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_pvrtc),this._capabilityMap.set(t.RenderCapable.COMPRESS_TEXTURE_PVRTC,a),a=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_etc1),this._capabilityMap.set(t.RenderCapable.COMPRESS_TEXTURE_ETC1,a),a=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_etc),this._capabilityMap.set(t.RenderCapable.COMPRESS_TEXTURE_ETC,a),a=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_astc),this._capabilityMap.set(t.RenderCapable.COMPRESS_TEXTURE_ASTC,a),a=r||!!this.getExtension(e.WebGLExtension.EXT_sRGB),this._capabilityMap.set(t.RenderCapable.Texture_SRGB,a),a=!!this.getExtension(e.WebGLExtension.OES_texture_float_linear),this._capabilityMap.set(t.RenderCapable.Texture_FloatLinearFiltering,a),a=r||!!this.getExtension(e.WebGLExtension.OES_texture_half_float_linear),this._capabilityMap.set(t.RenderCapable.Texture_HalfFloatLinearFiltering,a),a=r,this._capabilityMap.set(t.RenderCapable.MSAA,a),this._capabilityMap.set(t.RenderCapable.UnifromBufferObject,a),this._capabilityMap.set(t.RenderCapable.Texture3D,a),this._capabilityMap.set(t.RenderCapable.ComputeShader,!1),this._capabilityMap.set(t.RenderCapable.StorageBuffer,!1)}initExtension(t){this._extensionMap=new Map;const r=e=>{for(const t in H){let r=this._gl.getExtension(H[t]+e);if(r)return r}return null},a=(e,t,r)=>{t&&r.set(e,t)},i=r("EXT_texture_filter_anisotropic");a(e.WebGLExtension.EXT_texture_filter_anisotropic,i,this._extensionMap);const s=r("WEBGL_compressed_texture_s3tc");a(e.WebGLExtension.WEBGL_compressed_texture_s3tc,s,this._extensionMap);const n=r("WEBGL_compressed_texture_s3tc_srgb");a(e.WebGLExtension.WEBGL_compressed_texture_s3tc_srgb,n,this._extensionMap);const _=r("WEBGL_compressed_texture_pvrtc");a(e.WebGLExtension.WEBGL_compressed_texture_pvrtc,_,this._extensionMap);const l=r("WEBGL_compressed_texture_etc1");a(e.WebGLExtension.WEBGL_compressed_texture_etc1,l,this._extensionMap);const h=r("WEBGL_compressed_texture_etc");a(e.WebGLExtension.WEBGL_compressed_texture_etc,h,this._extensionMap);const o=r("WEBGL_compressed_texture_astc");a(e.WebGLExtension.WEBGL_compressed_texture_astc,o,this._extensionMap);const d=r("OES_texture_float_linear");a(e.WebGLExtension.OES_texture_float_linear,d,this._extensionMap);const u=r("EXT_color_buffer_half_float");if(a(e.WebGLExtension.EXT_color_buffer_half_float,u,this._extensionMap),t){const t=r("EXT_color_buffer_float");a(e.WebGLExtension.EXT_color_buffer_float,t,this._extensionMap)}else{window._setupVertexArrayObject&&window._setupVertexArrayObject(this._gl);const t=r("OES_vertex_array_object");a(e.WebGLExtension.OES_vertex_array_object,t,this._extensionMap);const i=r("ANGLE_instanced_arrays");a(e.WebGLExtension.ANGLE_instanced_arrays,i,this._extensionMap);const s=r("OES_texture_half_float");a(e.WebGLExtension.OES_texture_half_float,s,this._extensionMap);const n=r("OES_texture_half_float_linear");a(e.WebGLExtension.OES_texture_half_float_linear,n,this._extensionMap);const _=r("OES_texture_float");a(e.WebGLExtension.OES_texture_float,_,this._extensionMap);const l=r("OES_element_index_uint");a(e.WebGLExtension.OES_element_index_uint,l,this._extensionMap);const h=r("EXT_shader_texture_lod");a(e.WebGLExtension.EXT_shader_texture_lod,h,this._extensionMap);const o=r("WEBGL_depth_texture");a(e.WebGLExtension.WEBGL_depth_texture,o,this._extensionMap);const d=r("EXT_sRGB");a(e.WebGLExtension.EXT_sRGB,d,this._extensionMap);const u=r("OES_standard_derivatives");a(e.WebGLExtension.OES_standard_derivatives,u,this._extensionMap)}}getCapable(e){return this._capabilityMap.get(e)}getExtension(e){return this._extensionMap.get(e)||null}turnOffSRGB(){this._extensionMap.set(e.WebGLExtension.EXT_sRGB,null),this._capabilityMap.set(t.RenderCapable.Texture_SRGB,!1)}}class K extends t.UniformBufferManager{constructor(e,t){super(!0),this.engine=e,this.byteAlign=t,e.on("endFrame",this,this.endFrame),e.on("startFrame",this,this.startFrame)}createGPUBuffer(e,r,a){let i=this.engine.createBuffer(t.BufferTargetType.UNIFORM_BUFFER,t.BufferUsage.Dynamic);return i.bindBuffer(),i.setDataLength(e),a&&i.setData(a,0),i}writeBuffer(e,t,r,a){e.bindBuffer(),this.engine.gl.bufferSubData(e._glTarget,r,new Float32Array(t,r,a/4))}statisGPUMemory(e){this.engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.M_GPUMemory,e),this.engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.M_GPUBuffer,e)}statisUpload(e,r){this.engine._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_UniformBufferUploadCount,e)}}class z extends t.EventDispatcher{get lost(){return this._lost}constructor(r,a=e.WebGLMode.Auto){super(),this._framePassCount=0,this._lost=!1,this._propertyNameMap={},this._propertyNameCounter=0,this._IDCounter=0,this._isShaderDebugMode=!0,this._enableStatistics=!1,this._lastClearColor=new t.Color,this._lastClearDepth=-1,this._remapZ=!0,this._screenInvertY=!1,this._lodTextureSample=!0,this._breakTextureSample=!0,this._GLStatisticsInfo=new Map,this._config=r,this._isWebGL2=!1,this._lastViewport=new t.Vector4(0,0,0,0),this._lastClearColor=new t.Color(0,0,0,0),this._lastScissor=new t.Vector4(0,0,0,0),this._webglMode=a,this._initStatisticsInfo(),z.instance=this}startFrame(){this.event("startFrame",null)}endFrame(){this.event("endFrame",null)}getInnerWidth(){return t.LayaEnv.isConch?window.getInnerWidth():this._globalWidth}getInnerHeight(){return t.LayaEnv.isConch?window.getInnerHeight():this._globalHeight}resizeOffScreen(e,r){this._globalWidth=e,this._globalHeight=r,t.LayaEnv.isConch&&(z._lastFrameBuffer&&(z._lastFrameBuffer.dispose(),z._lastFrameBuffer_WebGLOBJ=null),z._lastFrameBuffer=this.getTextureContext().createRenderTargetInternal(e,r,t.RenderTargetFormat.R8G8B8A8,t.RenderTargetFormat.None,!1,!1,1,!1),z._lastFrameBuffer_WebGLOBJ=z._lastFrameBuffer._framebuffer)}addTexGammaDefine(e,t){z._texGammaDefine[e]=t}get gl(){return this._context}get isWebGL2(){return this._isWebGL2}get webglConfig(){return this._config}_initStatisticsInfo(){for(var e=0;e<t.GPUEngineStatisticsInfo.Count;e++)this._GLStatisticsInfo.set(e,0)}_addStatisticsInfo(e,t){this._enableStatistics&&this._GLStatisticsInfo.set(e,this._GLStatisticsInfo.get(e)+t)}clearStatisticsInfo(){if(this._enableStatistics)for(var e=0;e<t.GPUEngineStatisticsInfo.FrameClearCount;e++)this._GLStatisticsInfo.set(e,0)}getStatisticsInfo(e){return this._GLStatisticsInfo.get(e)}initRenderEngine(r){let a,i;switch(this._webglMode){case e.WebGLMode.Auto:a=["webgl2","experimental-webgl2","webgl","experimental-webgl"];break;case e.WebGLMode.WebGL1:a=["webgl","experimental-webgl"];break;case e.WebGLMode.WebGL2:a=["webgl2","experimental-webgl2"]}for(let e=0;e<a.length;e++){try{i=r.getContext(a[e],this._config)}catch(e){}if(i){"webgl2"!==a[e]&&"experimental-webgl2"!==a[e]||(this._isWebGL2=!0);break}}this._context=i,this.scissorTest(!0),this._initBindBufferMap(),this._supportCapatable=new Y(this),this._GLParams=new O(this),this._GLRenderState=new W(this),this._glTextureIDParams=[i.TEXTURE0,i.TEXTURE1,i.TEXTURE2,i.TEXTURE3,i.TEXTURE4,i.TEXTURE5,i.TEXTURE6,i.TEXTURE7,i.TEXTURE8,i.TEXTURE9,i.TEXTURE10,i.TEXTURE11,i.TEXTURE12,i.TEXTURE13,i.TEXTURE14,i.TEXTURE15,i.TEXTURE16,i.TEXTURE17,i.TEXTURE18,i.TEXTURE19,i.TEXTURE20,i.TEXTURE21,i.TEXTURE22,i.TEXTURE23,i.TEXTURE24,i.TEXTURE25,i.TEXTURE26,i.TEXTURE27,i.TEXTURE28,i.TEXTURE29,i.TEXTURE30,i.TEXTURE31],this._activedTextureID=i.TEXTURE0,this._activeTextures=[],this._GLTextureContext=this.isWebGL2?new w(this):new N(this),this._GLRenderDrawContext=new V(this),r.addEventListener("webglcontextlost",this.webglContextLost),t.Config._uniformBlock=t.Config.enableUniformBufferObject&&this.getCapable(t.RenderCapable.UnifromBufferObject),t.Config.matUseUBO=t.Config.matUseUBO&&this.getCapable(t.RenderCapable.UnifromBufferObject),this._initBufferBlock()}_initBufferBlock(){if(t.Config._uniformBlock||t.Config.matUseUBO){const e=this._context;let t=e.getParameter(e.UNIFORM_BUFFER_OFFSET_ALIGNMENT);this.bufferMgr=new K(this,t);let r=e.getParameter(e.MAX_UNIFORM_BUFFER_BINDINGS);this._uboBindingMap=new Array(r);for(let e=0;e<r;e++)this._uboBindingMap[e]={buffer:null,offset:0,size:0}}}webglContextLost(e){console.log("lost webgl context"),t.Laya.stage.event("GraphicContextLost",e),this._lost=!0}_initBindBufferMap(){this._GLBufferBindMap={},this._GLBufferBindMap[t.BufferTargetType.ARRAY_BUFFER]=null,this._GLBufferBindMap[t.BufferTargetType.ELEMENT_ARRAY_BUFFER]=null,this._GLBufferBindMap[t.BufferTargetType.UNIFORM_BUFFER]=null}_getbindBuffer(e){return this._GLBufferBindMap[e]}_setbindBuffer(e,t){this._GLBufferBindMap[e]=t}_bindTexture(e,t){const r=this._activedTextureID-this._context.TEXTURE0;this._activeTextures[r]!==t&&(this._context.bindTexture(e,t),this._activeTextures[r]=t)}getCapable(e){return this._supportCapatable.getCapable(e)}viewport(e,r,a,i){const s=this._context,n=this._lastViewport;t.LayaEnv.isConch?s.viewport(e,r,a,i):e===n.x&&r===n.y&&a===n.z&&i===n.w||(s.viewport(e,r,a,i),n.setValue(e,r,a,i))}scissor(e,r,a,i){const s=this._context,n=this._lastScissor;t.LayaEnv.isConch?s.scissor(e,r,a,i):e===n.x&&r===n.y&&a===n.z&&i===n.w||(s.scissor(e,r,a,i),n.setValue(e,r,a,i))}scissorTest(e){this._scissorState!=e&&(this._scissorState=e,e?this._context.enable(this._context.SCISSOR_TEST):this._context.disable(this._context.SCISSOR_TEST))}clearRenderTexture(e,r=null,a=1,i=0){var s;e&t.RenderClearFlag.Color&&(r&&!this._lastClearColor.equal(r)&&(this._context.clearColor(r.r,r.g,r.b,r.a),r.cloneTo(this._lastClearColor)),s|=this.gl.COLOR_BUFFER_BIT),e&t.RenderClearFlag.Depth&&(this._lastClearDepth!=a&&(this._context.clearDepth(a),this._lastClearDepth=a),this._GLRenderState.setDepthMask(!0),s|=this._context.DEPTH_BUFFER_BIT),e&t.RenderClearFlag.Stencil&&(this._context.clearStencil(i),this._GLRenderState.setStencilWrite(!0),s|=this._context.STENCIL_BUFFER_BIT),s&&this._context.clear(s)}copySubFrameBuffertoTex(e,t,r,a,i,s,n,_){this._bindTexture(e.target,e.resource),this._context.copyTexSubImage2D(e.target,t,r,a,i,s,n,_)}colorMask(e,t,r,a){this._context.colorMask(e,t,r,a)}getParams(e){return this._GLParams.getParams(e)}createBuffer(e,t){return new v(this,e,t)}createShaderInstance(e,t,r){return new X(this,e,t,r)}createVertexState(){return new k(this)}getTextureContext(){return this._GLTextureContext}getDrawContext(){return this._GLRenderDrawContext}propertyNameToID(e){if(null!=this._propertyNameMap[e])return this._propertyNameMap[e];var t=this._propertyNameCounter++;return this._propertyNameMap[e]=t,this._propertyNameMap[t]=e,t}propertyIDToName(e){return this._propertyNameMap[e]}getNamesByDefineData(e,t){var r=z._maskMap,a=e._mask;t.length=0;for(var i=0,s=e._length;i<s;i++)for(var n=r[i],_=a[i],l=0;l<32;l++){var h=1<<l;if(_>0&&h>_)break;_&h&&t.push(n[h])}}getDefineByName(e){var r=z._defineMap[e];if(!r){var a=z._maskMap,i=z._defineCounter,s=Math.floor(i/32),n=1<<i%32;r=new t.ShaderDefine(s,n),z._defineMap[e]=r,s==a.length&&(a.length++,a[s]={}),a[s][n]=e,z._defineCounter++}return r}uploadUniforms(e,t,r,a){for(var i=r._data,s=t.getArrayData(),n=0,_=0,l=s.length;_<l;_++){var h=s[_];if(a||-1!==h.textureID){var o=i[h.dataOffset];null!=o&&(n+=h.fun.call(h.caller,h,o))}}return n}uploadOneUniforms(e,t,r){e.bind(),t&&null!=r&&t.fun.call(t.caller,t,r)}unbindVertexState(){this.isWebGL2?this._context.bindVertexArray(null):this._supportCapatable.getExtension(e.WebGLExtension.OES_vertex_array_object).bindVertexArrayOES(null),this._GLBindVertexArray=null}}z._texGammaDefine={},z._lastFrameBuffer=null,z._lastFrameBuffer_WebGLOBJ=null,z._defineMap={},z._defineCounter=0,z._maskMap=[];class j{setInt(e,t){let r=this.descriptor.uniforms.get(e);r&&(r.view[0]=t,this.needUpload=!0)}setFloat(e,t){let r=this.descriptor.uniforms.get(e);r&&(r.view[0]=t,this.needUpload=!0)}setVector2(e,t){let r=this.descriptor.uniforms.get(e);r&&(r.view[0]=t.x,r.view[1]=t.y,this.needUpload=!0)}setVector3(e,t){let r=this.descriptor.uniforms.get(e);r&&(r.view[0]=t.x,r.view[1]=t.y,r.view[2]=t.z,this.needUpload=!0)}setVector4(e,t){let r=this.descriptor.uniforms.get(e);r&&(r.view[0]=t.x,r.view[1]=t.y,r.view[2]=t.z,r.view[3]=t.w,this.needUpload=!0)}setMatrix3x3(e,t){let r=this.descriptor.uniforms.get(e);if(r){let e=t.elements;for(let t=0;t<3;t++)for(let a=0;a<3;a++)r.view[4*t+a]=e[3*t+a];this.needUpload=!0}}setMatrix4x4(e,t){let r=this.descriptor.uniforms.get(e);r&&(r.view.set(t.elements),this.needUpload=!0)}setBuffer(e,t){let r=this.descriptor.uniforms.get(e);r&&(r.view.set(t),this.needUpload=!0)}setArrayBuffer(e,t){let r=this.descriptor.uniforms.get(e);if(r){let e=r.arrayLength,a=r.size,i=r.alignStride;for(let s=0;s<e;s++)r.view.set(t.subarray(s*a,(s+1)*a),s*i);this.needUpload=!0}}setMatrix3x3Array(e,t){let r=this.descriptor.uniforms.get(e);if(r){let e=r.arrayLength;r.size;let a=r.alignStride;for(let i=0;i<e;i++)for(let e=0;e<3;e++)for(let s=0;s<3;s++)r.view[i*a+4*e+s]=t[9*i+3*e+s];this.needUpload=!0}}setUniformData(e,r,a){let i=this.descriptor.uniforms.get(e);if(i)switch(r){case t.ShaderDataType.Bool:i.arrayLength>0?console.warn("ShaderDataType.Bool array not support"):this.setInt(e,a?1:0);break;case t.ShaderDataType.Int:i.arrayLength>0?this.setArrayBuffer(e,a):this.setInt(e,a);break;case t.ShaderDataType.Float:i.arrayLength>0?this.setArrayBuffer(e,a):this.setFloat(e,a);break;case t.ShaderDataType.Vector2:i.arrayLength>0?this.setArrayBuffer(e,a):this.setVector2(e,a);break;case t.ShaderDataType.Vector3:i.arrayLength>0?this.setArrayBuffer(e,a):this.setVector3(e,a);break;case t.ShaderDataType.Vector4:case t.ShaderDataType.Color:i.arrayLength>0?this.setArrayBuffer(e,a):this.setVector4(e,a);break;case t.ShaderDataType.Matrix3x3:i.arrayLength>0?this.setMatrix3x3Array(e,a):this.setMatrix3x3(e,a);break;case t.ShaderDataType.Matrix4x4:i.arrayLength>0?this.setArrayBuffer(e,a):this.setMatrix4x4(e,a);case t.ShaderDataType.Buffer:case t.ShaderDataType.None:case t.ShaderDataType.Texture2D:case t.ShaderDataType.Texture3D:case t.ShaderDataType.TextureCube:case t.ShaderDataType.Texture2DArray:}}}class q{get byteLength(){return this._byteLength}constructor(e){this._currentLength=0,this._byteLength=0,this._maxAlignment=4,this.name=e,this.uniforms=new Map}alignmentPadding(e){let t=this._currentLength%e;0!=t&&(t=e-t,this._currentLength+=t,this._byteLength+=4*t),this._maxAlignment=Math.max(this._maxAlignment,e)}addUniformItem(e,t,r,a,i){if(a>0){r=r>4?r:4,this.alignmentPadding(4);let s,n=a*r,_={index:e,view:s,size:t,alignStride:r,offset:4*this._currentLength,dataView:i,viewByteLength:i.BYTES_PER_ELEMENT*n,arrayLength:a};this.uniforms.set(e,_),this._currentLength+=n,this._byteLength+=_.viewByteLength}else{let a;this.alignmentPadding(t<=2?t:4);let s={index:e,view:a,size:t,alignStride:r,offset:4*this._currentLength,dataView:i,viewByteLength:i.BYTES_PER_ELEMENT*r,arrayLength:0};this.uniforms.set(e,s),this._currentLength+=t,this._byteLength+=t*i.BYTES_PER_ELEMENT}}addUniform(e,r,a=0){let i=0;switch(r){case t.ShaderDataType.Int:case t.ShaderDataType.Bool:i=1,this.addUniformItem(e,1,i,a,Int32Array);break;case t.ShaderDataType.Float:i=1,this.addUniformItem(e,1,i,a,Float32Array);break;case t.ShaderDataType.Vector2:i=2,this.addUniformItem(e,2,i,a,Float32Array);break;case t.ShaderDataType.Vector3:i=3,this.addUniformItem(e,3,i,a,Float32Array);break;case t.ShaderDataType.Vector4:case t.ShaderDataType.Color:i=4,this.addUniformItem(e,4,i,a,Float32Array);break;case t.ShaderDataType.Matrix3x3:i=12,this.addUniformItem(e,12,i,a,Float32Array);break;case t.ShaderDataType.Matrix4x4:i=16,this.addUniformItem(e,16,i,a,Float32Array);break;case t.ShaderDataType.Buffer:console.log("ShaderDataType.Buffer not support");case t.ShaderDataType.Texture2D:case t.ShaderDataType.Texture3D:case t.ShaderDataType.TextureCube:case t.ShaderDataType.Texture2DArray:case t.ShaderDataType.None:}}finish(e=0){e=e>this._maxAlignment?e:this._maxAlignment,this._maxAlignment=e,this.alignmentPadding(e)}clone(){let e=new q(this.name);return this.cloneTo(e),e}cloneTo(e){this.uniforms.forEach(t=>{e.addUniformItem(t.index,t.size,t.alignStride,t.arrayLength,t.dataView)}),e.finish(this._maxAlignment)}destroy(){this.uniforms.clear()}}class Z extends j{constructor(e){super(),this.name=e,this.descriptor=new q(e)}create(){let e=this.descriptor;e.finish();const r=new Uint8Array(e.byteLength).buffer;this._data=new Float32Array(r);for(const[t,a]of e.uniforms)a.view=new a.dataView(r,a.offset,a.viewByteLength/a.dataView.BYTES_PER_ELEMENT);this._buffer=t.LayaGL.renderEngine.createBuffer(t.BufferTargetType.UNIFORM_BUFFER,t.BufferUsage.Dynamic),this._buffer.bindBuffer(),this._buffer.setDataLength(e.byteLength),this.needUpload=!0}addUniform(e,t,r=0){this.descriptor.addUniform(e,t,r)}upload(){this.needUpload&&(this._buffer.setData(this._data,0),this.needUpload=!1)}bind(e){this._buffer.bindBufferBase(e)}clone(){let e=new Z(this.name);return this.cloneTo(e),e}cloneTo(e){this.descriptor.cloneTo(e.descriptor),e.create(),e._data.set(this._data)}destroy(){this._data=null,this._buffer.destroy(),this.descriptor.destroy(),this.descriptor=null}}class Q extends j{upload(){this.needUpload&&this.bufferBlock.needUpload()}bind(e){this.bufferBlock.cluster.buffer.bindBufferRange(e,this.bufferBlock.offset,this.bufferBlock.size)}constructor(e,t,r,a){super(),this.name=e,this.manager=r,this.data=a,this.uniformMap=t;let i=new q(e);t.forEach(e=>{i.addUniform(e.id,e.uniformtype,e.arrayLength)}),i.finish(this.manager.byteAlign/4);let s=i.byteLength;this.descriptor=i,this.size=s,this.bufferBlock=r.getBlock(s,this),this.needUpload=!0}updateOver(){this.needUpload=!1}clearGPUBufferBind(){}notifyGPUBufferChange(e){this.offset=this.bufferBlock.offset,this.needUpload=!0,this.descriptor.uniforms.forEach(e=>{let t=e.viewByteLength/e.dataView.BYTES_PER_ELEMENT,r=e.offset+this.bufferBlock.offset;e.view=new e.dataView(this.bufferBlock.cluster.data,r,t)}),this.needUpload=!0}destroy(){this.name=null,this.data=null,this.uniformMap=null,this.descriptor.destroy(),this.descriptor=null,this.manager.freeBlock(this.bufferBlock)}}class J extends t.ShaderData{constructor(e=null){super(e),this._data=null,this._defineDatas=new L,this._needCacheData=!1,this._updateCacheArray=null,this._subUboBufferNumber=0,this._initData()}_initData(){this._data={},this._updateCacheArray={},this._gammaColorMap=new Map,this._uniformBuffers=new Map,this._subUniformBuffers=new Map,this._uniformBuffersPropertyMap=new Map}createUniformBuffer(e,r){if(this._uniformBuffers.has(e))return this._uniformBuffers.get(e);this._needCacheData=!0;let a=new Z(e);r.forEach(e=>{a.addUniform(e.id,e.uniformtype,e.arrayLength)}),a.create(),this._uniformBuffers.set(e,a);let i=t.Shader3D.propertyNameToID(e);return this._data[i]=a,r.forEach(e=>{let t=e.id,r=this._data[t];null!=r&&a.setUniformData(t,e.uniformtype,r),this._uniformBuffersPropertyMap.set(t,a)}),a}updateUBOBuffer(e){if(!t.Config._uniformBlock)return;let r=this._uniformBuffers.get(e)||this._subUniformBuffers.get(e);if(r){for(var a in this._updateCacheArray){let e=parseInt(a),t=this._uniformBuffersPropertyMap.get(e);t&&this._updateCacheArray[a].call(t,e,this._data[e])}this._updateCacheArray={},r.needUpload&&r.upload()}}createSubUniformBuffer(e,r,a){let i=this._subUniformBuffers.get(r);if(i){if(this._subUboBufferNumber<2){for(var s in this._updateCacheArray){let e=parseInt(s),t=this._uniformBuffersPropertyMap.get(e);t&&this._updateCacheArray[s].call(t,e,this._data[e])}this._updateCacheArray={}}else a.forEach((e,t)=>{this._data[t]&&this._updateCacheArray[t]&&this._updateCacheArray[t].call(i,t,this._data[t])});return i}let n=z.instance.bufferMgr,_=new Q(e,a,n,this);this._subUboBufferNumber++,this._needCacheData=!0,_.notifyGPUBufferChange(),this._subUniformBuffers.set(r,_);let l=t.Shader3D.propertyNameToID(e);return this._data[l]=_,a.forEach(e=>{let t=e.id,r=this._data[t];null!=r&&_.setUniformData(t,e.uniformtype,r),this._uniformBuffersPropertyMap.set(t,_)}),_}getData(){return this._data}addDefine(e){this._defineDatas.add(e)}addDefines(e){this._defineDatas.addDefineDatas(e)}removeDefine(e){this._defineDatas.remove(e)}removeDefines(e){this._defineDatas.removeDefineDatas(e)}hasDefine(e){return this._defineDatas.has(e)}clearDefine(){this._defineDatas.clear()}clearData(){for(const e in this._data)this._data[e]instanceof t.Resource&&this._data[e]._removeReference();this._uniformBuffersPropertyMap.clear(),this._uniformBuffers.forEach(e=>{e.destroy()}),this._uniformBuffers.clear(),this._subUniformBuffers.forEach(e=>{e.destroy()}),this._subUniformBuffers.clear(),this._data={},this._gammaColorMap.clear(),this.clearDefine(),this._needCacheData=!1,this._subUboBufferNumber=0}getBool(e){return this._data[e]}setBool(e,t){this._data[e]=t,this._needCacheData}getInt(e){return this._data[e]}setInt(e,t){this._data[e]=t,this._needCacheData&&(this._updateCacheArray[e]=j.prototype.setInt)}getNumber(e){return this._data[e]}setNumber(e,t){this._data[e]=t,this._needCacheData&&(this._updateCacheArray[e]=j.prototype.setFloat)}getVector2(e){return this._data[e]}setVector2(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone(),this._needCacheData&&(this._updateCacheArray[e]=j.prototype.setVector2)}getVector3(e){return this._data[e]}setVector3(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone(),this._needCacheData&&(this._updateCacheArray[e]=j.prototype.setVector3)}getVector(e){return this._data[e]}setVector(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone(),this._needCacheData&&(this._updateCacheArray[e]=j.prototype.setVector4)}getColor(e){return this._gammaColorMap.get(e)}setColor(e,r){if(r){if(this._data[e]){let a=this._gammaColorMap.get(e);r.cloneTo(a);let i=this._data[e];i.x=t.Color.gammaToLinearSpace(r.r),i.y=t.Color.gammaToLinearSpace(r.g),i.z=t.Color.gammaToLinearSpace(r.b),i.w=r.a}else{let a=new t.Vector4;a.x=t.Color.gammaToLinearSpace(r.r),a.y=t.Color.gammaToLinearSpace(r.g),a.z=t.Color.gammaToLinearSpace(r.b),a.w=r.a,this._data[e]=a,this._gammaColorMap.set(e,r.clone())}this._needCacheData&&(this._updateCacheArray[e]=j.prototype.setVector4)}}getLinearColor(e){return this._data[e]}getMatrix4x4(e){return this._data[e]}setMatrix4x4(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone(),this._needCacheData&&(this._updateCacheArray[e]=j.prototype.setMatrix4x4)}getMatrix3x3(e){return this._data[e]}setMatrix3x3(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone(),this._needCacheData&&(this._updateCacheArray[e]=j.prototype.setMatrix3x3)}getBuffer(e){return this._data[e]}setBuffer(e,t){this._data[e]=t,this._needCacheData&&(this._updateCacheArray[e]=j.prototype.setArrayBuffer)}setTexture(e,t){var r=this._data[e];if(t){let r=z._texGammaDefine[e];r&&t&&t.gammaCorrection>1?this.addDefine(r):r&&this.removeDefine(r)}this._data[e]=t,r&&r._removeReference(),t&&t._addReference()}_setInternalTexture(e,t){if(this._data[e],t){let r=z._texGammaDefine[e];r&&t&&t.gammaCorrection>1?this.addDefine(r):r&&this.removeDefine(r)}this._data[e]=t}getTexture(e){return this._data[e]}getSourceIndex(e){for(var t in this._data)if(this._data[t]==e)return Number(t);return-1}cloneTo(e){e.clearData();var r=e._data;for(var a in this._data){var i=this._data[a];if(null!=i)if("number"==typeof i)r[a]=i;else if("boolean"==typeof i)r[a]=i;else if(i instanceof t.Vector2){let e=r[a]||(r[a]=new t.Vector2);i.cloneTo(e)}else if(i instanceof t.Vector3){let e=r[a]||(r[a]=new t.Vector3);i.cloneTo(e)}else if(i instanceof t.Vector4){let s=this.getColor(parseInt(a));if(s){let t=s.clone();e.setColor(parseInt(a),t)}else{let e=r[a]||(r[a]=new t.Vector4);i.cloneTo(e)}}else if(i instanceof t.Matrix3x3){let e=r[a]||(r[a]=new t.Matrix3x3);i.cloneTo(e)}else if(i instanceof t.Matrix4x4){let e=r[a]||(r[a]=new t.Matrix4x4);i.cloneTo(e)}else i instanceof t.Resource&&(r[a]=i,i._addReference())}this._defineDatas.cloneTo(e._defineDatas),this._gammaColorMap.forEach((t,r)=>{e._gammaColorMap.set(r,t.clone())})}getDefineData(){return this._defineDatas}clone(){var e=new J;return this.cloneTo(e),e}destroy(){this.destroyed||(this.clearData(),this._defineDatas.destroy(),this._defineDatas=null,this.destroyed=!0)}}class ${get renderState(){return this._renderState}set renderState(e){this._renderState=e}get validDefine(){return this._validDefine}set validDefine(e){this._validDefine=e}constructor(e){this._cacheShaderHierarchy=1,this._cacheSharders={},this._renderState=new t.RenderState,this._renderState.setNull()}_resizeCacheShaderMap(e,t,r){var a=this._cacheShaderHierarchy-1;if(t==a)for(var i in e)for(var s=e[i],n=0,_=r-a;n<_;n++)n===_-1?e[0]=s:e=e[0==n?i:0]={};else for(var i in++t,e)this._resizeCacheShaderMap(e[i],t,r)}setCacheShader(e,t){for(var r=this._cacheSharders,a=e._mask,i=e._length-1,s=this._cacheShaderHierarchy-1,n=0;n<s;n++){var _=i<n?0:a[n],l=r[_];l||(r[_]=l={}),r=l}r[i<s?0:a[s]]=t}getCacheShader(e){e._intersectionDefineDatas(this._validDefine);var t=this._cacheSharders,r=e._length;r>this._cacheShaderHierarchy&&(this._resizeCacheShaderMap(t,0,r),this._cacheShaderHierarchy=r);for(var a=e._mask,i=e._length-1,s=this._cacheShaderHierarchy-1,n=0;n<s;n++){var _=i<n?0:a[n],l=t[_];l||(t[_]=l={}),t=l}return t[i<s?0:a[s]]}destroy(){}}class ee{setUniformMap(e){}destroy(){throw new t.NotImplementedError}addShaderPass(e){}}class te{createSubShader(){return new ee}createShaderPass(e){return new $(e)}createRenderState(){return new t.RenderState}createDefineDatas(){return new L}}t.Laya.addBeforeInitCallback(()=>{t.LayaGL.unitRenderModuleDataFactory||(t.LayaGL.unitRenderModuleDataFactory=new te)});class re extends t.SetRendertarget2DCMD{constructor(){super(),this.type=t.RenderCMDType.ChangeRenderTarget,this._clearColorValue=new t.Color}apply(e){this.rt?e.invertY=this.invertY:e.invertY=!1,e.setRenderTarget(this.rt,this.clearColor,this.clearColorValue),e.passData.setVector2(t.ShaderDefines2D.UNIFORM_SIZE,this.size)}}class ae extends t.Draw2DElementCMD{constructor(){super(),this.type=t.RenderCMDType.DrawElement}setRenderelements(e){this._elements=e}apply(e){1==this._elements.length?e.drawRenderElementOne(this._elements[0]):this._elements.forEach(t=>{e.drawRenderElementOne(t)})}}class ie extends t.Blit2DQuadCMD{static _init_(){ie.SCREENTEXTURE_ID=t.Shader3D.propertyNameToID("u_MainTex"),ie.SCREENTEXTUREOFFSETSCALE_ID=t.Shader3D.propertyNameToID("u_OffsetScale"),ie.MAINTEXTURE_TEXELSIZE_ID=t.Shader3D.propertyNameToID("u_MainTex_TexelSize"),ie.GammaCorrect=t.Shader3D.getDefineByName("GAMMACORRECT")}constructor(){super(),ie.SCREENTEXTURE_ID||ie._init_(),this.type=t.RenderCMDType.Blit,this._offsetScale=new t.Vector4,this._sourceTexelSize=new t.Vector4}set source(e){this._source=e,this._source&&this._sourceTexelSize.setValue(1/this._source.width,1/this._source.height,this._source.width,this._source.height)}apply(e){let r=e.invertY;this._dest?this.element.materialShaderData.removeDefine(ie.GammaCorrect):(e.invertY=!1,this.element.materialShaderData.addDefine(ie.GammaCorrect)),this.element.materialShaderData._setInternalTexture(ie.SCREENTEXTURE_ID,this._source),this.element.materialShaderData.setVector(ie.SCREENTEXTUREOFFSETSCALE_ID,this._offsetScale),this.element.materialShaderData.setVector(ie.MAINTEXTURE_TEXELSIZE_ID,this._sourceTexelSize),e.setRenderTarget(this._dest,!1,t.Color.BLACK),e.drawRenderElementOne(this.element),e.invertY=r}}class se{constructor(){this.renderStateIsBySprite=!0,this.type=0,this._shaderInstances=new t.FastSinglelist}_compileShader(e){var r=this.subShader._passes;this._shaderInstances.clear();for(var a=0,i=r.length;a<i;a++){var s=r[a];if(s.pipelineMode!==e.pipelineMode)continue;var n=se._compileDefine;this.globalShaderData?this.globalShaderData._defineDatas.cloneTo(n):e._globalConfigShaderData.cloneTo(n),e.passData&&n.addDefineDatas(e.passData._defineDatas),!e._destRT||1!=e._destRT._textures[0].gammaCorrection?n.add(t.ShaderDefines2D.GAMMASPACE):n.remove(t.ShaderDefines2D.GAMMASPACE),e.invertY?n.add(t.ShaderDefines2D.INVERTY):n.remove(t.ShaderDefines2D.INVERTY),this.value2DShaderData&&(n.addDefineDatas(this.value2DShaderData.getDefineData()),s.nodeCommonMap=this.nodeCommonMap),this.materialShaderData&&n.addDefineDatas(this.materialShaderData._defineDatas);var _=s.withCompile(n,!0);this._shaderInstances.add(_)}}_prepare(e){this.globalShaderData=this.owner&&this.owner._globalShaderData,this._compileShader(e)}_render(e){if(1==this._shaderInstances.length)this.renderByShaderInstance(this._shaderInstances.elements[0],e);else for(var t=this._shaderInstances.elements,r=0,a=this._shaderInstances.length;r<a;r++)this.renderByShaderInstance(t[r],e)}_uploadGlobalAndPass(e,t){this.globalShaderData&&e.uploadUniforms(e._cameraUniformParamsMap,this.globalShaderData,!0),t.passData&&e.uploadUniforms(e._sceneUniformParamsMap,t.passData,!0)}renderByShaderInstance(e,t){e.complete&&this.geometry&&(e.bind(),this._uploadGlobalAndPass(e,t),this.value2DShaderData&&e.uploadUniforms(e._sprite2DUniformParamsMap,this.value2DShaderData,!0),this.materialShaderData&&e.uploadUniforms(e._materialUniformParamsMap,this.materialShaderData,!0),this.renderStateIsBySprite||!this.materialShaderData?(e.uploadRenderStateBlendDepth(this.value2DShaderData),e.uploadRenderStateFrontFace(this.value2DShaderData,!1,t.invertY)):(e.uploadRenderStateBlendDepth(this.materialShaderData),e.uploadRenderStateFrontFace(this.materialShaderData,!1,t.invertY)),z.instance.getDrawContext().drawGeometryElement(this.geometry))}destroy(){this.globalShaderData=null}}se._compileDefine=new L;class ne extends se{_compileShader(e){var r=this.subShader._passes;this._shaderInstances.clear();for(var a=0,i=r.length;a<i;a++){var s=r[a];if(s.pipelineMode!==e.pipelineMode)continue;var n=se._compileDefine;this.globalShaderData?this.globalShaderData._defineDatas.cloneTo(n):e._globalConfigShaderData.cloneTo(n),e.passData&&n.addDefineDatas(e.passData._defineDatas),!e._destRT||1!=e._destRT._textures[0].gammaCorrection?n.add(t.ShaderDefines2D.GAMMASPACE):n.remove(t.ShaderDefines2D.GAMMASPACE),e.invertY?n.add(t.ShaderDefines2D.INVERTY):n.remove(t.ShaderDefines2D.INVERTY),this.value2DShaderData&&(n.addDefineDatas(this.value2DShaderData.getDefineData()),s.nodeCommonMap=this.nodeCommonMap),this.materialShaderData&&n.addDefineDatas(this.materialShaderData._defineDatas),this.primitiveShaderData&&(s.additionShaderData=["Sprite2DGraphics"],n.addDefineDatas(this.primitiveShaderData.getDefineData()));var _=s.withCompile(n,!0);this._shaderInstances.add(_)}}renderByShaderInstance(e,t){if(!e.complete||!this.geometry)return;e.bind(),this._uploadGlobalAndPass(e,t),this.value2DShaderData&&e.uploadUniforms(e._sprite2DUniformParamsMap,this.value2DShaderData,!0),this.materialShaderData&&e.uploadUniforms(e._materialUniformParamsMap,this.materialShaderData,!0);let r=e._additionUniformParamsMaps.get("Sprite2DGraphics");this.primitiveShaderData&&e.uploadUniforms(r,this.primitiveShaderData,!0);let a=this.value2DShaderData;this.renderStateIsBySprite||(this.materialShaderData?a=this.materialShaderData:this.primitiveShaderData&&(a=this.primitiveShaderData)),e.uploadRenderStateBlendDepth(a),e.uploadRenderStateFrontFace(a,!1,t.invertY),z.instance.getDrawContext().drawGeometryElement(this.geometry)}}class _e extends t.SetRenderDataCMD{get dataType(){return this._dataType}set dataType(e){this._dataType=e}get propertyID(){return this._propertyID}set propertyID(e){this._propertyID=e}get dest(){return this._dest}set dest(e){this._dest=e}get value(){return this._value}set value(e){switch(this.dataType){case t.ShaderDataType.Int:case t.ShaderDataType.Float:case t.ShaderDataType.Bool:this.data_number=e,this._value=this.data_number;break;case t.ShaderDataType.Matrix4x4:!this.data_mat&&(this.data_mat=new t.Matrix4x4),e.cloneTo(this.data_mat),this._value=this.data_mat;break;case t.ShaderDataType.Color:!this.data_Color&&(this.data_Color=new t.Color),e.cloneTo(this.data_Color),this._value=this.data_Color;break;case t.ShaderDataType.Texture2D:this._value=this.data_texture=e;break;case t.ShaderDataType.Vector4:!this.data_v4&&(this.data_v4=new t.Vector4),e.cloneTo(this.data_v4),this._value=this.data_v4;break;case t.ShaderDataType.Vector2:!this.data_v2&&(this.data_v2=new t.Vector2),e.cloneTo(this.data_v2),this._value=this.data_v2;break;case t.ShaderDataType.Vector3:!this.data_v3&&(this.data_v3=new t.Vector3),e.cloneTo(this.data_v3),this._value=this.data_v3;break;case t.ShaderDataType.Buffer:this._value=this.data_Buffer=e}}constructor(){super(),this.type=t.RenderCMDType.ChangeData}apply(e){switch(this.dataType){case t.ShaderDataType.Int:this.dest.setInt(this.propertyID,this.value);break;case t.ShaderDataType.Float:this.dest.setNumber(this.propertyID,this.value);break;case t.ShaderDataType.Bool:this.dest.setBool(this.propertyID,this.value);break;case t.ShaderDataType.Matrix4x4:this.dest.setMatrix4x4(this.propertyID,this.value);break;case t.ShaderDataType.Color:this.dest.setColor(this.propertyID,this.value);break;case t.ShaderDataType.Texture2D:this.dest.setTexture(this.propertyID,this.value);break;case t.ShaderDataType.Vector4:this.dest.setVector(this.propertyID,this.value);break;case t.ShaderDataType.Vector2:this.dest.setVector2(this.propertyID,this.value);break;case t.ShaderDataType.Vector3:this.dest.setVector3(this.propertyID,this.value);break;case t.ShaderDataType.Buffer:this.dest.setBuffer(this.propertyID,this.value)}}}class le extends t.SetShaderDefineCMD{get define(){return this._define}set define(e){this._define=e}get dest(){return this._dest}set dest(e){this._dest=e}get add(){return this._add}set add(e){this._add=e}constructor(){super(),this.type=t.RenderCMDType.ChangeShaderDefine}apply(e){this.add?this._dest.addDefine(this.define):this._dest.removeDefine(this.define)}}class he{get vertexDeclaration(){return this._vertexDeclaration}set vertexDeclaration(e){this._vertexDeclaration=e,this._shaderValues=this._vertexDeclaration._shaderValues}constructor(e,r){this._glBuffer=z.instance.createBuffer(e,r),z.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.RC_VertexBuffer,1)}_changeMemory(e){z.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.M_VertexBuffer,-this._glBuffer._byteLength+e)}setDataLength(e){this._changeMemory(e),this._glBuffer.setDataLength(e)}setData(e,t,r,a){if(this.bind(),0!==r||a!==Number.MAX_SAFE_INTEGER){var i=new Uint8Array(e,r,a);this._glBuffer.setData(i,t)}else this._glBuffer.setData(e,t)}bind(){return this._glBuffer.bindBuffer()}unbind(){return this._glBuffer.unbindBuffer()}orphanStorage(){this.bind(),this._glBuffer.setDataLength(this._glBuffer._byteLength)}destroy(){this._glBuffer.destroy(),this._vertexDeclaration=null,this._changeMemory(0),z.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.RC_VertexBuffer,-1)}}class oe{constructor(){if(this._clearColor=new t.Color(0,0,0,0),this.invertY=!1,this.pipelineMode="Forward",this._globalConfigShaderData=t.Shader3D._configDefineValues,t.LayaEnv.isConch&&!oe.isCreateBlitScreenELement){!oe.isCreateBlitScreenELement&&this.setBlitScreenElement(),oe.blitContext=new oe;let e=t.LayaGL.renderEngine;e.on("endFrame",()=>{let r=z._lastFrameBuffer_WebGLOBJ,a=z._lastFrameBuffer;z._lastFrameBuffer_WebGLOBJ=null,z._lastFrameBuffer=null,oe.blitContext.setOffscreenView(e.getInnerWidth(),e.getInnerHeight()),oe.blitContext.setRenderTarget(null,!0,t.Color.BLACK),oe.blitScreenElement.materialShaderData._setInternalTexture(t.Shader3D.propertyNameToID("u_MainTex"),a._textures[0]),oe.blitContext.drawRenderElementOne(oe.blitScreenElement),z._lastFrameBuffer_WebGLOBJ=r,z._lastFrameBuffer=a,z.instance.getTextureContext().bindRenderTarget(a)})}}setBlitScreenElement(){let e=t.LayaGL.render2DRenderPassFactory.createRenderElement2D(),r=t.LayaGL.renderDeviceFactory.createShaderData(),a=new Float32Array([1,1,1,1,1,-1,1,0,-1,1,0,1,-1,-1,0,0]),i=new he(t.BufferTargetType.ARRAY_BUFFER,t.BufferUsage.Dynamic);i.setDataLength(64),i.setData(a.buffer,0,0,a.buffer.byteLength);let s=new t.VertexDeclaration(16,[new t.VertexElement(0,t.VertexElementFormat.Vector4,0)]);i.vertexDeclaration=s;let n=t.LayaGL.renderDeviceFactory.createRenderGeometryElement(t.MeshTopology.TriangleStrip,t.DrawType.DrawArray);n.setDrawArrayParams(0,4);let _=t.LayaGL.renderDeviceFactory.createBufferState();_.applyState([i],null),n.bufferState=_;let l={a_PositionTexcoord:[0,t.ShaderDataType.Vector4]},h={u_MainTex:t.ShaderDataType.Texture2D},o=t.Shader3D.add("GLESblitScreen",!1,!1);o.shaderType=t.ShaderFeatureType.DEFAULT;let d=new t.SubShader(l,h,{});o.addSubShader(d);let u=d.addShaderPass("\n            #define SHADER_NAME GLESblitScreenVS\n\n            varying vec2 v_Texcoord0;\n\n            void main()\n            {\n                gl_Position = vec4(- 1.0 + (a_PositionTexcoord.x + 1.0), (1.0 - ((- 1.0 + (-a_PositionTexcoord.y + 1.0)) + 1.0) / 2.0) * 2.0 - 1.0, 0.0, 1.0);\n\n                v_Texcoord0 = a_PositionTexcoord.zw;\n            }\n        ",'\n            #define SHADER_NAME GLESblitScreenFS\n\n            #include "Color.glsl";\n\n            varying vec2 v_Texcoord0;\n\n            void main()\n            {\n                vec4 mainColor = texture2D(u_MainTex, v_Texcoord0);\n               \n                gl_FragColor = mainColor;\n            }\n        ');u.statefirst=!0;let c=u.renderState;c.depthTest=t.RenderState.DEPTHTEST_ALWAYS,c.depthWrite=!1,c.cull=t.RenderState.CULL_NONE,c.blend=t.RenderState.BLEND_DISABLE,c.stencilRef=1,c.stencilTest=t.RenderState.STENCILTEST_OFF,c.stencilWrite=!1,c.stencilOp=new t.Vector3(t.RenderState.STENCILOP_KEEP,t.RenderState.STENCILOP_KEEP,t.RenderState.STENCILOP_REPLACE),e.geometry=n,e.materialShaderData=r,e.subShader=d,e.renderStateIsBySprite=!1,oe.isCreateBlitScreenELement=!0,oe.blitScreenElement=e}drawRenderElementList(e){for(var r=0,a=e.length;r<a;r++){e.elements[r]._prepare(this)}for(r=0,a=e.length;r<a;r++){e.elements[r]._render(this)}return t.LayaGL.renderEngine._framePassCount++,0}setOffscreenView(e,t){this._offscreenWidth=e,this._offscreenHeight=t}setRenderTarget(e,r,a){this._destRT=e,a.cloneTo(this._clearColor),this._destRT?(z.instance.getTextureContext().bindRenderTarget(this._destRT),z.instance.viewport(0,0,this._destRT._textures[0].width,this._destRT._textures[0].height)):(z.instance.getTextureContext().bindoutScreenTarget(),z.instance.viewport(0,0,this._offscreenWidth,this._offscreenHeight)),z.instance.scissorTest(!1),z.instance.clearRenderTexture(r?t.RenderClearFlag.Color:t.RenderClearFlag.Nothing,this._clearColor)}getRenderTarget(){return this._destRT}drawRenderElementOne(e){e._prepare(this),e._render(this),t.LayaGL.renderEngine._framePassCount++}runOneCMD(e){e.apply(this)}runCMDList(e){e.forEach(e=>{e.apply(this)})}}oe.isCreateBlitScreenELement=!1;class de{constructor(){}createGraphic2DBufferBlock(){return new S}createGraphic2DVertexBlock(){return new R}create2DGraphicVertexDataView(e,t,r,a){return new g(e,t,r,a)}create2DGraphicIndexDataView(e,t){return new E(e,t)}create2DGraphicIndexBuffer(){return new i}createPrimitiveRenderElement2D(){return new ne}create2DGraphicVertexBuffer(){return new a}createRender2DPassManager(){return new m}create2DGlobalRenderDataHandle(){return new P}createSpineRenderDataHandle(){return new B}create2D2DPrimitiveDataHandle(){return new x}create2DBaseRenderDataHandle(){return new D}createMesh2DRenderDataHandle(){return new b}createSetRenderDataCMD(){return new _e}createSetShaderDefineCMD(){return new le}createBlit2DQuadCMDData(){return new ie}createDraw2DElementCMDData(){return new ae}createSetRendertarget2DCMD(){return new re}createRenderElement2D(){return new se}createRenderContext2D(){return new oe}createRender2DPass(){return new c}createRenderStruct2D(){return new y}}t.Laya.addBeforeInitCallback(()=>{t.LayaGL.render2DRenderPassFactory||(t.LayaGL.render2DRenderPassFactory=new de)});class ue{constructor(){this._glVertexState=z.instance.createVertexState()}applyVertexBuffers(){this._glVertexState.applyVertexBuffer(this._vertexBuffers)}applyIndexBuffers(){this._glVertexState.applyIndexBuffer(this._bindedIndexBuffer)}applyState(e,t){this._vertexBuffers=e.slice(),this._bindedIndexBuffer=t,t&&t._glBuffer.unbindBuffer(),this.bind(),this.applyVertexBuffers(),this.applyIndexBuffers(),this.unBind(),t&&t._glBuffer.unbindBuffer()}bind(){this._glVertexState.bindVertexArray(),ue._curBindedBufferState=this}unBind(){if(ue._curBindedBufferState!=this)throw"BufferState: must call bind() function first.";this._glVertexState.unbindVertexArray(),ue._curBindedBufferState=null}isBind(){return ue._curBindedBufferState==this}destroy(){ue._curBindedBufferState==this&&(this._glVertexState.unbindVertexArray(),ue._curBindedBufferState=null),this._glVertexState.destroy(),this._vertexBuffers=null,this._bindedIndexBuffer=null}}class ce extends t.CommandUniformMap{constructor(e){super(e),this._idata=new Map,this._stateName=e,this._stateID=t.Shader3D.propertyNameToID(e)}hasPtrID(e){return this._stateID==e||this._idata.has(e)}addShaderUniform(e,t,r){this._idata.set(e,{id:e,uniformtype:r,propertyName:t,arrayLength:0})}addShaderUniformArray(e,t,r,a,i=""){this._idata.set(e,{id:e,uniformtype:r,propertyName:t,arrayLength:a})}}class fe{constructor(e,r){this._glBuffer=this._glBuffer=z.instance.createBuffer(e,r),z.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.RC_IndexBuffer,1)}_changeMemory(e){z.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.M_IndexBuffer,-this._glBuffer._byteLength+e)}_setIndexDataLength(e){this._changeMemory(e);var t=ue._curBindedBufferState;t?(t.unBind(),this._glBuffer.bindBuffer(),this._glBuffer.setDataLength(e),t.bind()):(this._glBuffer.bindBuffer(),this._glBuffer.setDataLength(e))}setData(e,t,r,a){let i=ue._curBindedBufferState;if(i&&i.unBind(),this._glBuffer.bindBuffer(),0!==r||a!==Number.MAX_SAFE_INTEGER){var s=new Uint8Array(e,r,a);this._glBuffer.setData(s,t)}else this._glBuffer.setData(e,t);i&&i.bind()}_setIndexData(e,t){var r=ue._curBindedBufferState;r?(r.unBind(),this._glBuffer.bindBuffer(),this._glBuffer.setData(e,t),r.bind()):(this._glBuffer.bindBuffer(),this._glBuffer.setData(e,t))}destroy(){this._glBuffer.destroy(),this._changeMemory(0),z.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.RC_IndexBuffer,-1)}}class me{get indexFormat(){return this._indexFormat}set indexFormat(e){this._indexFormat=e,this._glindexFormat=z.instance.getDrawContext().getIndexType(this._indexFormat)}get mode(){return this._mode}set mode(e){this._mode=e,this._glmode=z.instance.getDrawContext().getMeshTopology(this._mode)}constructor(e,r){this._id=++me._idCounter,this.mode=e,this.drawParams=new t.FastSinglelist,this.drawType=r}getDrawDataParams(e){e&&this.drawParams.cloneTo(e)}setDrawArrayParams(e,t){this.drawParams.add(e),this.drawParams.add(t)}setDrawElemenParams(e,t){this.drawParams.add(t),this.drawParams.add(e)}destroy(){delete this.drawParams}clearRenderParams(){this.drawParams.length=0}cloneTo(e){e.mode=this.mode,e.drawType=this.drawType,e.indexFormat=this.indexFormat,e.instanceCount=this.instanceCount,e.drawParams.elements=this.drawParams.elements.slice(),e.drawParams.length=this.drawParams.length}}me._idCounter=0;class pe{constructor(){this._cacheShaerVariable={},this._uploadMark=-1,this._uploadRenderType=-1,this._additionUniformParamsMaps=new Map,this._additionShaderData=new Map}_serializeShader(){return null}_deserialize(e){return!1}get complete(){return this._renderShaderInstance._complete}_create(e,r){let a=t.Config.matUseUBO;t.Config.matUseUBO=!e.is2D&&t.Config.matUseUBO;let i=t.GLSLCodeGenerator.GLShaderLanguageProcess3D(e.defineString,e.attributeMap,e.uniformMap,e.vs,e.ps);this._renderShaderInstance=z.instance.createShaderInstance(i.vs,i.fs,e.attributeMap),t.Config.matUseUBO=a,z._lastShaderError&&console.warn(`[ShaderCompile]Error compiling shader '${r._owner._owner.name}' (pipelineMode=${r.pipelineMode})\n`,z._lastShaderError),this._renderShaderInstance._complete&&(this._shaderPass=r.moduleData,e.is2D?this._create2D():this._create3D())}_create3D(){this._sceneUniformParamsMap=new t.CommandEncoder,this._cameraUniformParamsMap=new t.CommandEncoder,this._spriteUniformParamsMap=new t.CommandEncoder,this._materialUniformParamsMap=new t.CommandEncoder;let e=t.WebGLRenderContext3D._instance._preDrawUniformMaps,r=[];for(let a of e){let e=t.LayaGL.renderDeviceFactory.createGlobalUniformMap(a);r.push(e)}const a=t.LayaGL.renderDeviceFactory.createGlobalUniformMap("BaseCamera");let i,s,n=this._renderShaderInstance.getUniformMap();for(i=0,s=n.length;i<s;i++){let e=n[i];if(r.find(t=>t.hasPtrID(e.dataOffset)))this._sceneUniformParamsMap.addShaderUniform(e);else if(a.hasPtrID(e.dataOffset))this._cameraUniformParamsMap.addShaderUniform(e);else if(this.hasSpritePtrID(e.dataOffset))this._spriteUniformParamsMap.addShaderUniform(e);else if(this._hasAdditionShaderData(e.dataOffset)){let r=this._hasAdditionShaderData(e.dataOffset);if(!this._additionUniformParamsMaps.get(r)){let e=new t.CommandEncoder;this._additionUniformParamsMaps.set(r,e)}this._additionUniformParamsMaps.get(r).addShaderUniform(e)}else this._materialUniformParamsMap.addShaderUniform(e)}}_create2D(){this._sprite2DUniformParamsMap=new t.CommandEncoder,this._materialUniformParamsMap=new t.CommandEncoder,this._sceneUniformParamsMap=new t.CommandEncoder,this._cameraUniformParamsMap=new t.CommandEncoder;const e=t.LayaGL.renderDeviceFactory.createGlobalUniformMap("Sprite2DPass"),r=t.LayaGL.renderDeviceFactory.createGlobalUniformMap("Sprite2DGlobal");let a,i,s=this._renderShaderInstance.getUniformMap();for(a=0,i=s.length;a<i;a++){let i=s[a];if(this.hasSpritePtrID(i.dataOffset))this._sprite2DUniformParamsMap.addShaderUniform(i);else if(e.hasPtrID(i.dataOffset))this._sceneUniformParamsMap.addShaderUniform(i);else if(r.hasPtrID(i.dataOffset))this._cameraUniformParamsMap.addShaderUniform(i);else if(this._hasAdditionShaderData(i.dataOffset)){let e=this._hasAdditionShaderData(i.dataOffset);if(!this._additionUniformParamsMaps.get(e)){let r=new t.CommandEncoder;this._additionUniformParamsMaps.set(e,r)}this._additionUniformParamsMaps.get(e).addShaderUniform(i)}else this._materialUniformParamsMap.addShaderUniform(i)}}hasSpritePtrID(e){let r=this._shaderPass.nodeCommonMap;if(r){for(let a=0,i=r.length;a<i;a++)if(t.LayaGL.renderDeviceFactory.createGlobalUniformMap(r[a]).hasPtrID(e))return!0;return!1}return!1}_hasAdditionShaderData(e){let r=this._shaderPass.additionShaderData;if(!r)return null;for(let a=0,i=r.length;a<i;a++)if(t.LayaGL.renderDeviceFactory.createGlobalUniformMap(r[a]).hasPtrID(e))return r[a];return null}_disposeResource(){this._renderShaderInstance.destroy(),this._sceneUniformParamsMap=null,this._cameraUniformParamsMap=null,this._spriteUniformParamsMap=null,this._materialUniformParamsMap=null,this._sprite2DUniformParamsMap=null,this._uploadMaterial=null,this._uploadRender=null,this._uploadCameraShaderValue=null,this._uploadScene=null,this._additionShaderData=null}bind(){return this._renderShaderInstance.bind()}uploadUniforms(e,r,a){z.instance._addStatisticsInfo(t.GPUEngineStatisticsInfo.C_UniformBufferUploadCount,z.instance.uploadUniforms(this._renderShaderInstance,e,r,a))}uploadRenderStateBlendDepth(e){this._shaderPass.statefirst?this.uploadRenderStateBlendDepthByShader(e):this.uploadRenderStateBlendDepthByMaterial(e)}uploadRenderStateBlendDepthByShader(e){var r,a,i,s,n,_,l,h,o,d,u,c,f,m,p,g,E,T,S,R,x,D,b,B,A,P,C,M,F,y,L,G,I,U,N,w,v,O,V,W,X,k,H,Y;const K=z.instance._GLRenderState;var j=e._data,q=this._shaderPass.renderState,Z=null!==(a=null!==(r=q.depthWrite)&&void 0!==r?r:j[t.Shader3D.DEPTH_WRITE])&&void 0!==a?a:t.RenderState.Default.depthWrite;K.setDepthMask(Z);var Q=null!==(s=null!==(i=q.depthTest)&&void 0!==i?i:j[t.Shader3D.DEPTH_TEST])&&void 0!==s?s:t.RenderState.Default.depthTest;Q==t.RenderState.DEPTHTEST_OFF?K.setDepthTest(!1):(K.setDepthTest(!0),K.setDepthFunc(Q));var J=null!==(_=null!==(n=q.stencilWrite)&&void 0!==n?n:j[t.Shader3D.STENCIL_WRITE])&&void 0!==_?_:t.RenderState.Default.stencilWrite;K.setStencilWrite(J);let $=J?null!==(h=null!==(l=q.stencilWriteMask)&&void 0!==l?l:j[t.Shader3D.STENCIL_WRITE_MASK])&&void 0!==h?h:t.RenderState.Default.stencilWriteMask:0;if(K.setStencilWriteMask($),J){var ee=null!==(d=null!==(o=q.stencilOp)&&void 0!==o?o:j[t.Shader3D.STENCIL_Op])&&void 0!==d?d:t.RenderState.Default.stencilOp;K.setstencilOp(ee.x,ee.y,ee.z)}var te=null!==(c=null!==(u=q.stencilTest)&&void 0!==u?u:j[t.Shader3D.STENCIL_TEST])&&void 0!==c?c:t.RenderState.Default.stencilTest;if(te==t.RenderState.STENCILTEST_OFF)K.setStencilTest(!1);else{K.setStencilTest(!0);var re=null!==(m=null!==(f=q.stencilRef)&&void 0!==f?f:j[t.Shader3D.STENCIL_Ref])&&void 0!==m?m:t.RenderState.Default.stencilRef;let e=null!==(g=null!==(p=q.stencilReadMask)&&void 0!==p?p:j[t.Shader3D.STENCIL_READ_MASK])&&void 0!==g?g:t.RenderState.Default.stencilReadMask;K.setStencilFunc(te,re,e)}let ae=null!==(T=null!==(E=q.depthBias)&&void 0!==E?E:j[t.Shader3D.DEPTH_BIAS])&&void 0!==T?T:t.RenderState.Default.depthBias;if(K.setDepthBias(ae),ae){let e=null!==(R=null!==(S=q.depthBiasConstant)&&void 0!==S?S:j[t.Shader3D.DEPTH_BIAS_CONSTANT])&&void 0!==R?R:t.RenderState.Default.depthBiasConstant,r=null!==(D=null!==(x=q.depthBiasSlopeScale)&&void 0!==x?x:j[t.Shader3D.DEPTH_BIAS_SLOPESCALE])&&void 0!==D?D:t.RenderState.Default.depthBiasSlopeScale,a=null!==(B=null!==(b=q.depthBiasClamp)&&void 0!==b?b:j[t.Shader3D.DEPTH_BIAS_CLAMP])&&void 0!==B?B:t.RenderState.Default.depthBiasClamp;K.setDepthBiasFactor(e,r,a)}switch(null!==(P=null!==(A=q.blend)&&void 0!==A?A:j[t.Shader3D.BLEND])&&void 0!==P?P:t.RenderState.Default.blend){case t.RenderState.BLEND_DISABLE:K.setBlend(!1);break;case t.RenderState.BLEND_ENABLE_ALL:var ie=null!==(M=null!==(C=q.blendEquation)&&void 0!==C?C:j[t.Shader3D.BLEND_EQUATION])&&void 0!==M?M:t.RenderState.Default.blendEquation,se=null!==(y=null!==(F=q.srcBlend)&&void 0!==F?F:j[t.Shader3D.BLEND_SRC])&&void 0!==y?y:t.RenderState.Default.srcBlend,ne=null!==(G=null!==(L=q.dstBlend)&&void 0!==L?L:j[t.Shader3D.BLEND_DST])&&void 0!==G?G:t.RenderState.Default.dstBlend;K.setBlend(!0),K.setBlendEquation(ie),K.setBlendFunc(se,ne);break;case t.RenderState.BLEND_ENABLE_SEPERATE:var _e=null!==(U=null!==(I=q.blendEquationRGB)&&void 0!==I?I:j[t.Shader3D.BLEND_EQUATION_RGB])&&void 0!==U?U:t.RenderState.Default.blendEquationRGB,le=null!==(w=null!==(N=q.blendEquationAlpha)&&void 0!==N?N:j[t.Shader3D.BLEND_EQUATION_ALPHA])&&void 0!==w?w:t.RenderState.Default.blendEquationAlpha,he=null!==(O=null!==(v=q.srcBlendRGB)&&void 0!==v?v:j[t.Shader3D.BLEND_SRC_RGB])&&void 0!==O?O:t.RenderState.Default.srcBlendRGB,oe=null!==(W=null!==(V=q.dstBlendRGB)&&void 0!==V?V:j[t.Shader3D.BLEND_DST_RGB])&&void 0!==W?W:t.RenderState.Default.dstBlendRGB,de=null!==(k=null!==(X=q.srcBlendAlpha)&&void 0!==X?X:j[t.Shader3D.BLEND_SRC_ALPHA])&&void 0!==k?k:t.RenderState.Default.srcBlendAlpha,ue=null!==(Y=null!==(H=q.dstBlendAlpha)&&void 0!==H?H:j[t.Shader3D.BLEND_DST_ALPHA])&&void 0!==Y?Y:t.RenderState.Default.dstBlendAlpha;K.setBlend(!0),K.setBlendEquationSeparate(_e,le),K.setBlendFuncSeperate(he,oe,de,ue)}}uploadRenderStateBlendDepthByMaterial(e){var r,a,i;const s=z.instance._GLRenderState;var n=e.getData(),_=n[t.Shader3D.DEPTH_WRITE];_=null!=_?_:t.RenderState.Default.depthWrite,s.setDepthMask(_);var l=n[t.Shader3D.DEPTH_TEST];(l=null!=l?l:t.RenderState.Default.depthTest)===t.RenderState.DEPTHTEST_OFF?s.setDepthTest(!1):(s.setDepthTest(!0),s.setDepthFunc(l));var h=n[t.Shader3D.STENCIL_WRITE];h=null!=h?h:t.RenderState.Default.stencilWrite,s.setStencilWrite(h);let o=h?null!==(r=n[t.Shader3D.STENCIL_WRITE_MASK])&&void 0!==r?r:t.RenderState.Default.stencilWriteMask:0;if(s.setStencilWriteMask(o),h){var d=n[t.Shader3D.STENCIL_Op];d=null!=d?d:t.RenderState.Default.stencilOp,s.setstencilOp(d.x,d.y,d.z)}var u=n[t.Shader3D.STENCIL_TEST];if((u=null!=u?u:t.RenderState.Default.stencilTest)==t.RenderState.STENCILTEST_OFF)s.setStencilTest(!1);else{let e=null!==(a=n[t.Shader3D.STENCIL_READ_MASK])&&void 0!==a?a:t.RenderState.Default.stencilReadMask;var c=n[t.Shader3D.STENCIL_Ref];c=null!=c?c:t.RenderState.Default.stencilRef,s.setStencilTest(!0),s.setStencilFunc(u,c,e)}let f=null!==(i=n[t.Shader3D.DEPTH_BIAS])&&void 0!==i?i:t.RenderState.Default.depthBias;if(s.setDepthBias(f),f){let e=n[t.Shader3D.DEPTH_BIAS_CONSTANT];e=null!=e?e:t.RenderState.Default.depthBiasConstant;let r=n[t.Shader3D.DEPTH_BIAS_SLOPESCALE];r=null!=r?r:t.RenderState.Default.depthBiasSlopeScale;let a=n[t.Shader3D.DEPTH_BIAS_CLAMP];a=null!=a?a:t.RenderState.Default.depthBiasClamp,s.setDepthBiasFactor(e,r,a)}var m=n[t.Shader3D.BLEND];switch(m=null!=m?m:t.RenderState.Default.blend){case t.RenderState.BLEND_ENABLE_ALL:var p=n[t.Shader3D.BLEND_EQUATION];p=null!=p?p:t.RenderState.Default.blendEquation;var g=n[t.Shader3D.BLEND_SRC];g=null!=g?g:t.RenderState.Default.srcBlend;var E=n[t.Shader3D.BLEND_DST];E=null!=E?E:t.RenderState.Default.dstBlend,s.setBlend(!0),s.setBlendEquation(p),s.setBlendFunc(g,E);break;case t.RenderState.BLEND_ENABLE_SEPERATE:var T=n[t.Shader3D.BLEND_EQUATION_RGB];T=null!=T?T:t.RenderState.Default.blendEquationRGB;var S=n[t.Shader3D.BLEND_EQUATION_ALPHA];S=null!=S?S:t.RenderState.Default.blendEquationAlpha;var R=n[t.Shader3D.BLEND_SRC_RGB];R=null!=R?R:t.RenderState.Default.srcBlendRGB;var x=n[t.Shader3D.BLEND_DST_RGB];x=null!=x?x:t.RenderState.Default.dstBlendRGB;var D=n[t.Shader3D.BLEND_SRC_ALPHA];D=null!=D?D:t.RenderState.Default.srcBlendAlpha;var b=n[t.Shader3D.BLEND_DST_ALPHA];b=null!=b?b:t.RenderState.Default.dstBlendAlpha,s.setBlend(!0),s.setBlendEquationSeparate(T,S),s.setBlendFuncSeperate(R,x,D,b);break;case t.RenderState.BLEND_DISABLE:default:s.setBlend(!1)}}uploadRenderStateFrontFace(e,r,a){var i;const s=z.instance._GLRenderState;var n,_=this._shaderPass.renderState,l=e.getData()[t.Shader3D.CULL];switch(this._shaderPass.statefirst&&(l=null!==(i=_.cull)&&void 0!==i?i:l),l=null!=l?l:t.RenderState.Default.cull){case t.RenderState.CULL_NONE:s.setCullFace(!1),n=r!=a?t.CullMode.Front:t.CullMode.Back,s.setFrontFace(n);break;case t.RenderState.CULL_FRONT:s.setCullFace(!0),n=r==a?t.CullMode.Front:t.CullMode.Back,s.setFrontFace(n);break;case t.RenderState.CULL_BACK:default:s.setCullFace(!0),n=r!=a?t.CullMode.Front:t.CullMode.Back,s.setFrontFace(n)}}}class ge{constructor(){this.globalBlockMap={}}createShaderData(e){return new J(e)}createShaderInstance(e,r){let a=new pe;if(a._create(e,r),t.Shader3D.debugMode){let a=e.defineString,i=e.is2D;t.ShaderVariantCollection.active.add(r,a,i)}return a}createIndexBuffer(e){return new fe(t.BufferTargetType.ELEMENT_ARRAY_BUFFER,e)}createVertexBuffer(e){return new he(t.BufferTargetType.ARRAY_BUFFER,e)}createBufferState(){return new ue}createRenderGeometryElement(e,t){return new me(e,t)}createGlobalUniformMap(e){let t=this.globalBlockMap[e];return t||(t=this.globalBlockMap[e]=new ce(e)),t}createEngine(r,a){let i,s={stencil:t.Config.isStencil,alpha:t.Config.isAlpha,antialias:t.Config.isAntialias,premultipliedAlpha:t.Config.premultipliedAlpha,preserveDrawingBuffer:t.Config.preserveDrawingBuffer,depth:t.Config.isDepth,failIfMajorPerformanceCaveat:t.Config.isfailIfMajorPerformanceCaveat,powerPreference:t.Config.powerPreference};const n=t.Config.useWebGL2?e.WebGLMode.Auto:e.WebGLMode.WebGL1;i=new z(s,n),i.initRenderEngine(a.source);var _=i._context;return t.Config.printWebglOrder&&this._replaceWebglcall(_),_&&new t.LayaGL,t.LayaGL.renderEngine=i,t.LayaGL.textureContext=i.getTextureContext(),Promise.resolve()}_replaceWebglcall(e){var t={};for(const r in e)"function"==typeof e[r]&&"getError"!=r&&"__SPECTOR_Origin_getError"!=r&&"__proto__"!=r&&(t[r]=e[r],e[r]=function(){let a=[];for(let e=0;e<arguments.length;e++)a.push(arguments[e]);let i=t[r].apply(e,a);e.getError();return i})}}t.Laya.addBeforeInitCallback(()=>{t.LayaGL.renderDeviceFactory||(t.LayaGL.renderDeviceFactory=new ge)}),e.BatchBuffer=_,e.BatchManager=d,e.GL2TextureContext=w,e.GLBuffer=v,e.GLObject=G,e.GLParams=O,e.GLRenderDrawContext=V,e.GLRenderState=W,e.GLShaderInstance=X,e.GLTextureContext=N,e.GLVertexState=k,e.GlCapable=Y,e.VertexArrayObject=class{constructor(){}},e.Web2DBaseRenderDataHandle=D,e.Web2DGraphic2DIndexDataView=E,e.Web2DGraphic2DVertexDataView=g,e.Web2DGraphicWholeBuffer=r,e.Web2DGraphicsBufferDataView=p,e.Web2DGraphicsIndexBatchBuffer=s,e.Web2DGraphicsIndexBuffer=i,e.Web2DGraphicsVertexBuffer=a,e.WebDefineDatas=L,e.WebGLBlit2DQuadCMD=ie,e.WebGLBufferState=ue,e.WebGLCommandUniformMap=ce,e.WebGLConfig=class{},e.WebGLDraw2DElementCMD=ae,e.WebGLEngine=z,e.WebGLIndexBuffer=fe,e.WebGLInternalRT=I,e.WebGLInternalTex=U,e.WebGLPrimitiveRenderElement2D=ne,e.WebGLRender2DProcess=de,e.WebGLRenderDeviceFactory=ge,e.WebGLRenderElement2D=se,e.WebGLRenderGeometryElement=me,e.WebGLSetRenderData=_e,e.WebGLSetRendertarget2DCMD=re,e.WebGLSetShaderDefine=le,e.WebGLShaderData=J,e.WebGLShaderInstance=pe,e.WebGLSubUniformBuffer=Q,e.WebGLUniformBuffer=Z,e.WebGLUniformBufferBase=j,e.WebGLUniformBufferDescriptor=q,e.WebGLUniformBufferManager=K,e.WebGLVertexBuffer=he,e.WebGlobalRenderData=P,e.WebGraphics2DBufferBlock=S,e.WebGraphics2DVertexBlock=R,e.WebGraphicsBatch=h,e.WebGraphicsBatchContext=l,e.WebMesh2DRenderDataHandle=b,e.WebPrimitiveDataHandle=x,e.WebRender2DDataHandle=T,e.WebRender2DPass=c,e.WebRender2DPassManager=m,e.WebRenderStruct2D=y,e.WebShaderPass=$,e.WebSpineRenderDataHandle=B,e.WebSubShader=ee,e.WebUnitRenderModuleDataFactory=te,e.WebglRenderContext2D=oe}(window.Laya=window.Laya||{},Laya);